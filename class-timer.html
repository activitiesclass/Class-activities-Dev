<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>جدول الحصص - Class Timer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --main-color: #4f8cff;
      --accent: #e0ffe0;
      --glass: rgba(255,255,255,0.7);
      --dark-bg: #23272f;
      --dark-glass: rgba(40,44,52,0.85);
    }
    body.night {
      background: linear-gradient(120deg, #23272f 0%, #4f8cff 100%);
      color: #fff;
    }
    .night header, .night .controls, .night .modern-table, .night .current-session, .night .timer, .night .details-modal {
      background: var(--dark-glass) !important;
      color: #fff !important;
      box-shadow: 0 4px 24px #000a;
    }
    .night .modern-table th {
      background: linear-gradient(90deg, #4f8cff 0%, #23272f 100%) !important;
      color: #fff !important;
    }
    .night .modern-btn {
      background: linear-gradient(90deg, #4f8cff 0%, #23272f 100%) !important;
      color: #fff !important;
      border: 2px solid #4f8cff !important;
    }
    .night .modern-btn:hover {
      background: #23272f !important;
      color: #4f8cff !important;
    }
    .night .sidebar-toggle {
      background: #23272f !important;
      color: #4f8cff !important;
    }
  </style>
  <style>
    body {
      font-family: 'Cairo', Arial, sans-serif;
      background: linear-gradient(120deg, #e0ffe0 0%, #b2f7ef 100%, #fff 100%);
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
      animation: bgmove 12s ease-in-out infinite alternate;
    }
    @keyframes bgmove {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    header {
      background: linear-gradient(90deg, #e0ffe0 0%, #b2f7ef 100%);
      box-shadow: 0 8px 32px #b2f7ef55;
      padding: 36px 20px 28px 20px;
      text-align: center;
      border-radius: 0 0 40px 40px;
      position: relative;
      margin-bottom: 32px;
      border-bottom: 4px solid #b2f7ef;
      transition: box-shadow 0.3s;
    }
    .logo {
      float: right;
      width: 80px;
      margin-left: 28px;
      border-radius: 18px;
      box-shadow: 0 4px 18px #b2f7ef55;
      background: #fff;
      padding: 6px;
      transition: transform 0.3s;
    }
    .logo:hover {
      transform: scale(1.07) rotate(-3deg);
      box-shadow: 0 8px 32px #b2f7ef99;
    }
    .school-name {
      color: #009688;
      font-size: 2.5em;
      font-weight: bold;
      letter-spacing: 2.5px;
      text-shadow: 0 2px 12px #b2f7ef44;
      display: inline-block;
      margin-top: 8px;
      margin-bottom: 8px;
      animation: fadein 1.2s;
    }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .clock {
      color: #0074D9;
      font-size: 2em;
      float: left;
      margin-right: 24px;
      background: #e0ffe0;
      padding: 8px 22px 8px 18px;
      border-radius: 14px;
      box-shadow: 0 2px 8px #b2f7ef33;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Cairo', Arial, sans-serif;
      font-weight: bold;
      letter-spacing: 1.5px;
      min-width: 120px;
    }
    .clock:before {
      content: '\f017';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #009688;
      font-size: 1.1em;
      margin-left: 7px;
      margin-right: 2px;
      vertical-align: middle;
      display: inline-block;
      animation: spin 2.5s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .clear { clear: both; }
    .controls {
      margin: 30px auto 18px;
      text-align: center;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 18px #b2f7ef33;
      padding: 22px 0 14px 0;
      width: 92%;
      max-width: 650px;
      border: 2px solid #b2f7ef44;
      transition: box-shadow 0.2s;
      animation: fadein 1.2s 0.2s backwards;
    }
    select {
      font-size: 1.2em;
      padding: 9px 26px;
      border-radius: 10px;
      border: 2px solid #b2f7ef;
      background: #e0ffe0;
      margin: 0 10px;
      transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px #b2f7ef22;
    }
    select:focus {
      border: 2.5px solid #009688;
      outline: none;
      box-shadow: 0 4px 16px #b2f7ef44;
    }
    table {
      width: 95%;
      margin: 24px auto;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 4px 24px #b2f7ef55;
      border-radius: 18px;
      overflow: hidden;
    }
    th, td {
      padding: 16px 10px;
      border: 1px solid #b2f7ef44;
      text-align: center;
      font-size: 1.1em;
    }
    th {
      background: linear-gradient(90deg, #e0ffe0 0%, #b2f7ef 100%);
      color: #009688;
      font-size: 1.15em;
      border-bottom: 2px solid #b2f7ef;
      letter-spacing: 1px;
    }
    tfoot td {
      background: #f9f9f9;
      color: #888;
    }
    .footer {
      text-align: center;
      color: #c00;
      font-weight: bold;
      margin: 30px 0 10px;
    }
  </style>
</head>
<body>
  <header>
    <img id="schoolLogo" src="assets/media/images/school-logo.png" class="logo" alt="شعار المدرسة">
    <span class="school-name" id="schoolName">اسم المدرسة</span>
    <span class="clock" id="clock"></span>
    <button class="sidebar-toggle" id="toggleNight" title="الوضع الليلي"><i class="fa fa-moon"></i></button>
    <div class="clear"></div>
  </header>
  <div class="controls">
  <label for="daySelect">اختر اليوم:</label>
  <select id="daySelect"></select>
  <button id="todayBtn" class="modern-btn"><i class="fa fa-calendar-day"></i> اليوم الحالي</button>
  </div>
  <div id="currentSession" class="current-session"></div>
  <div id="timer" class="timer"></div>
  <table id="liveEventsTable" class="modern-table">
    <thead>
      <tr>
        <th>اليوم</th>
        <th>الحصة</th>
        <th>المادة</th>
        <th>الصف</th>
        <th>المعلم</th>
        <th>وقت البداية</th>
        <th>وقت النهاية</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <!-- <div class="footer"></div> -->
  <script>
    // بيانات الأيام
  // في جافاسكريبت 0=الأحد، 1=الإثنين ... 6=السبت
  const days = ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"];
    const daySelect = document.getElementById('daySelect');
    days.forEach((day, idx) => {
      const opt = document.createElement('option');
      opt.value = day;
      opt.textContent = day;
      daySelect.appendChild(opt);
    });
    // تعيين اليوم الحالي افتراضيًا عند تحميل الصفحة أو عند الضغط على زر "اليوم الحالي"
    function setTodaySelect() {
      let todayIdx = new Date().getDay();
      if (todayIdx === 6 && !days.includes("السبت")) todayIdx = 0;
      daySelect.selectedIndex = todayIdx;
      updateCurrentSession();
    }
    setTodaySelect();
    document.getElementById('todayBtn').onclick = setTodaySelect;

    // تحديث الساعة الرقمية
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('ar-EG');
    }
    setInterval(updateClock, 1000);
    updateClock();


    // تحميل اسم المدرسة والشعار واللون من ملف config/school.json
    function setSchoolInfo() {
      fetch('config/school.json')
        .then(r => r.ok ? r.json() : {schoolName: 'اسم المدرسة', schoolLogo: 'assets/media/images/school-logo.png', themeColor: '#4f8cff'})
        .then(info => {
          let schoolName = info.schoolName || info["schoolName "] || info[" schoolName"] || info["schoolname"] || info["school_name"] || '';
          schoolName = (schoolName || '').toString().trim();
          document.getElementById('schoolName').textContent = schoolName ? schoolName : '⚠️ لم يتم العثور على اسم المدرسة في ملف school.json';
          document.getElementById('schoolLogo').src = info.schoolLogo || 'assets/media/images/school-logo.png';
          document.documentElement.style.setProperty('--main-color', info.themeColor || '#4f8cff');
        });
    }
    setSchoolInfo();


    // تحميل بيانات الحصص وبيانات اليوم فقط
    let schedule = [];
    let todayInfo = [];
    Promise.all([
      fetch('data/schedule.json').then(r => r.json()),
      fetch('data/todayInfo.json').then(r => r.json())
    ]).then(([scheduleData, todayData]) => {
      schedule = scheduleData;
      todayInfo = todayData;
      updateCurrentSession();
      setInterval(updateCurrentSession, 1000);
      daySelect.addEventListener('change', updateCurrentSession);
    });

    // منطق ذكي لعرض شجرة الأحداث وتفاصيل الحصة
    function updateCurrentSession() {
      const now = new Date();
      const today = daySelect.value;
      const currentTime = now.toTimeString().slice(0,8);
      let currentPeriod = null;
      for (let period of schedule) {
        if (currentTime >= period.start_time && currentTime <= period.end_time) {
          currentPeriod = period;
          break;
        }
      }
      let sessionInfo = '';
      let timerInfo = '';
      const liveTable = document.getElementById('liveEventsTable');
      const liveTbody = liveTable.querySelector('tbody');
      // عرض جميع الحصص لليوم المختار كشجرة أحداث
      const todayEvents = todayInfo.filter(ev => ev.day === today);
      liveTbody.innerHTML = '';
      schedule.forEach(period => {
        const event = todayEvents.find(ev => ev.period == period.period);
        const isCurrent = currentPeriod && period.period == currentPeriod.period && today === days[now.getDay()];
        liveTbody.innerHTML += `<tr class="event-row${isCurrent ? ' current' : ''}" data-period="${period.period}">
          <td><i class="fa fa-calendar-day"></i> ${today}</td>
          <td><span class="period-badge">${period.period}</span></td>
          <td>${event ? `<i class='fa fa-book'></i> ${event.subject}` : '-'}</td>
          <td>${event ? event.class_name : '-'}</td>
          <td>${event ? event.teacher : '-'}</td>
          <td>${period.start_time}</td>
          <td>${period.end_time}</td>
        </tr>`;
      });
      liveTable.style.display = '';
      // تفاصيل الحصة الجارية
      if (currentPeriod && today === days[now.getDay()]) {
        const event = todayEvents.find(ev => ev.period == currentPeriod.period);
        if (event) {
          sessionInfo = `<span class='live-dot'></span> <b>${event.subject}</b> | الصف: <b>${event.class_name}</b> | المعلم: <b>${event.teacher}</b> | الحصة: <b>${currentPeriod.period}</b>`;
        } else {
          sessionInfo = `اليوم: <b>${today}</b> | الحصة: <b>${currentPeriod.period}</b> (لا يوجد معلم أو صف محدد)`;
        }
        // مؤقت دائري متحرك
        const [h, m, s] = currentPeriod.end_time.split(":").map(Number);
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, s);
        let diff = Math.floor((end - now) / 1000);
        if (diff < 0) diff = 0;
        const mm = String(Math.floor(diff/60)).padStart(2,'0');
        const ss = String(diff%60).padStart(2,'0');
        timerInfo = `<span class='timer-circle'><svg width='48' height='48'><circle r='20' cx='24' cy='24' fill='none' stroke='#4f8cff' stroke-width='5' stroke-dasharray='126' stroke-dashoffset='${126-Math.max(0,Math.min(1,(diff/(45*60))))*126}'/></svg><span>${mm}:${ss}</span></span>`;
      } else {
        sessionInfo = `لا توجد حصة جارية الآن`;
        timerInfo = '';
      }
      document.getElementById('currentSession').innerHTML = sessionInfo;
      document.getElementById('timer').innerHTML = timerInfo;
      // إضافة منطق نافذة التفاصيل
      document.querySelectorAll('.event-row').forEach(row => {
        row.onclick = function() {
          const period = +this.getAttribute('data-period');
          const event = todayEvents.find(ev => ev.period == period);
          if (event) showDetailsModal(event, schedule.find(p=>p.period==period));
        };
      });
    }

    // نافذة تفاصيل الحصة
    function showDetailsModal(event, period) {
      let modal = document.getElementById('detailsModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'detailsModal';
        modal.className = 'details-modal';
        document.body.appendChild(modal);
      }
      modal.innerHTML = `
        <div class='modal-content'>
          <button class='close-modal' onclick='this.parentNode.parentNode.style.display="none"'>&times;</button>
          <h2><i class='fa fa-book'></i> ${event.subject}</h2>
          <p><b>اليوم:</b> ${event.day}</p>
          <p><b>الحصة:</b> ${event.period}</p>
          <p><b>الصف:</b> ${event.class_name}</p>
          <p><b>المعلم:</b> ${event.teacher}</p>
          <p><b>من:</b> ${period.start_time} <b>إلى:</b> ${period.end_time}</p>
        </div>
      `;
      modal.style.display = 'flex';
    }

    // زر الوضع الليلي
    document.getElementById('toggleNight').onclick = function() {
      document.body.classList.toggle('night');
    };
  </script>
  <style>
    .modern-table {
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 4px 24px #b2f7ef55;
      background: #fff;
      margin-bottom: 40px;
      font-size: 1.1em;
      min-width: 320px;
      max-width: 100%;
      transition: box-shadow 0.2s;
    }
    .modern-table th {
      background: linear-gradient(90deg, #e0ffe0 0%, #b2f7ef 100%);
      color: #009688;
      font-size: 1.15em;
      border-bottom: 2px solid #b2f7ef;
      letter-spacing: 1px;
    }
    .modern-table tr {
      transition: background 0.2s;
    }
    .modern-table tr:hover {
      background: #f0f8ff;
    }
    .modern-table td {
      border: 1px solid #b2f7ef44;
    }
    .modern-btn {
      margin-right: 15px;
      font-size: 1.15em;
      padding: 10px 28px;
      background: linear-gradient(90deg, #e0ffe0 0%, #b2f7ef 100%);
      border: 2px solid #b2f7ef;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, color 0.2s, border 0.2s;
      font-weight: bold;
      color: #009688;
      box-shadow: 0 2px 8px #b2f7ef33;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
    }
    .modern-btn:after {
      content: '\f061';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #b2f7ef;
      font-size: 1em;
      margin-right: 8px;
      vertical-align: middle;
      opacity: 0.7;
      transition: color 0.2s;
    }
    .modern-btn:hover {
      background: #b2f7ef;
      box-shadow: 0 6px 24px #b2f7ef44;
      color: #00796b;
      border: 2.5px solid #009688;
    }
    .modern-btn:hover:after {
      color: #009688;
    }
    .current-session {
      text-align: center;
      margin: 36px 0 16px;
      font-size: 1.6em;
      color: #009688;
      font-weight: bold;
      letter-spacing: 1.5px;
      background: linear-gradient(90deg, #e0ffe0 0%, #b2f7ef 100%);
      border-radius: 16px;
      padding: 14px 0;
      box-shadow: 0 4px 18px #b2f7ef33;
      max-width: 650px;
      margin-left: auto;
      margin-right: auto;
      border: 2px solid #b2f7ef44;
      animation: fadein 1.2s 0.3s backwards;
    }
    .timer {
      text-align: center;
      font-size: 2.3em;
      color: #c00;
      margin-bottom: 28px;
      font-family: 'Cairo', Arial, sans-serif;
      font-weight: bold;
      letter-spacing: 2.5px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 18px #b2f7ef33;
      max-width: 320px;
      margin-left: auto;
      margin-right: auto;
      padding: 12px 0;
      border: 2px solid #b2f7ef44;
      animation: fadein 1.2s 0.4s backwards;
    }
    @media (max-width: 600px) {
      .modern-table, .modern-table th, .modern-table td {
        font-size: 0.98em;
        padding: 7px 2px;
      }
      .school-name {
        font-size: 1.25em;
      }
      .clock {
        font-size: 1.15em;
        padding: 4px 8px;
      }
      .modern-btn {
        font-size: 1em;
        padding: 7px 12px;
      }
      .current-session {
        font-size: 1.15em;
        padding: 8px 0;
      }
      .timer {
        font-size: 1.25em;
        padding: 6px 0;
      }
    }
  </style>
</body>
</html>

