<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>من هو؟ - لعبة التفاعل الصفي</title>
  
  <!-- خطوط Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Canvas Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap');
    
    :root {
      /* الألوان الأساسية */
      --primary-color: #2c5aa0;
      --secondary-color: #34a85a;
      --accent-color: #f39c12;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --success-color: #27ae60;
      --info-color: #3498db;
      --text-color: #2c3e50;
      --white: #ffffff;
      
      /* ألوان التدرج */
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-warning: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --gradient-royal: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-mystic: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-cosmic: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      
      /* ألوان البطاقات */
      --card-bg: #ffffff;
      --card-shadow: rgba(0, 0, 0, 0.1);
      --card-hover-shadow: rgba(0, 0, 0, 0.2);
      --card-border: #e1e8ed;
      
      /* متغيرات الحركة */
      --animation-speed: 0.3s;
      --bounce-animation: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --smooth-animation: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      
      /* الظلال المتقدمة */
      --neumorphism-light: #ffffff;
      --neumorphism-dark: #d1d9e6;
      --neumorphism-inset: inset 5px 5px 10px #d1d9e6, inset -5px -5px 10px #ffffff;
      --neumorphism-outset: 5px 5px 10px #d1d9e6, -5px -5px 10px #ffffff;
      
      /* ألوان الخلفية المتدرجة */
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      --card-gradient: linear-gradient(145deg, #f0f2f5 0%, #ffffff 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', sans-serif;
      direction: rtl;
      background: var(--bg-gradient);
      background-attachment: fixed;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      color: var(--text-color);
    }

    /* خلفية متحركة */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
      animation: backgroundShift 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes backgroundShift {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.1) rotate(180deg); }
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* زر العودة المتطور */
    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--gradient-primary);
      color: var(--white);
      padding: 15px 25px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      box-shadow: var(--neumorphism-outset);
      transition: all var(--animation-speed) var(--bounce-animation);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .back-button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        var(--neumorphism-outset),
        0 15px 30px rgba(0,0,0,0.2);
    }

    /* تصميم العنوان المتطور */
    .header {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
    }

    .main-title {
      font-size: clamp(2.5rem, 5vw, 4rem);
      font-weight: 800;
      background: var(--gradient-royal);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      animation: titleGlow 3s ease-in-out infinite;
      position: relative;
    }

    @keyframes titleGlow {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.05); filter: brightness(1.2); }
    }

    .subtitle {
      font-size: 1.3rem;
      color: #5a6c7d;
      font-weight: 500;
      opacity: 0.8;
      margin-bottom: 20px;
    }

    /* بطاقة التحكم الرئيسية */
    .controls {
      background: var(--card-gradient);
      border-radius: 25px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--neumorphism-outset);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      transition: all var(--animation-speed) var(--smooth-animation);
      position: relative;
      overflow: hidden;
    }

    .controls::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-royal);
      border-radius: 25px 25px 0 0;
    }

    .controls:hover {
      transform: translateY(-5px);
      box-shadow: 
        var(--neumorphism-outset),
        0 20px 40px rgba(0,0,0,0.1);
    }

    /* مجموعات التحكم */
    .control-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      background: rgba(255,255,255,0.7);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--neumorphism-inset);
      transition: all var(--animation-speed) var(--bounce-animation);
    }

    .form-group:hover {
      transform: scale(1.02);
      background: rgba(255,255,255,0.9);
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    select, .form-control {
      width: 100%;
      padding: 12px 18px;
      border: 2px solid transparent;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
      background: rgba(255,255,255,0.9);
      box-shadow: var(--neumorphism-inset);
      transition: all var(--animation-speed) var(--smooth-animation);
      font-weight: 500;
      color: var(--text-color);
    }

    select:focus, .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 
        var(--neumorphism-inset),
        0 0 0 3px rgba(44, 90, 160, 0.1);
      transform: scale(1.02);
    }

    /* أزرار اللعبة المتطورة */
    .game-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    button, .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      font-family: 'Cairo', sans-serif;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-animation);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: var(--neumorphism-outset);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    button::before, .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    button:hover::before, .btn:hover::before {
      left: 100%;
    }

    button:hover:not(:disabled), .btn:hover:not(:disabled) {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        var(--neumorphism-outset),
        0 15px 30px rgba(0,0,0,0.2);
    }

    button:active, .btn:active {
      transform: translateY(0) scale(0.98);
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: var(--white);
    }

    .btn-success {
      background: var(--gradient-success);
      color: var(--white);
    }

    .btn-warning {
      background: var(--gradient-warning);
      color: #2c3e50;
    }

    .btn-royal {
      background: var(--gradient-royal);
      color: var(--white);
    }

    .btn-mystic {
      background: var(--gradient-mystic);
      color: var(--white);
    }

    .btn-cosmic {
      background: var(--gradient-cosmic);
      color: #2c3e50;
    }

    /* بطاقات الاختيار المتطورة */
    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
      margin-top: 30px;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .student-card {
      background: var(--card-gradient);
      border-radius: 20px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-animation);
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: var(--neumorphism-outset);
      position: relative;
      overflow: hidden;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .student-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-royal);
      transform: scaleX(0);
      transition: transform var(--animation-speed) var(--smooth-animation);
    }

    .student-card:hover::before {
      transform: scaleX(1);
    }

    .student-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 
        var(--neumorphism-outset),
        0 25px 50px rgba(0,0,0,0.15);
      border-color: var(--primary-color);
    }

    .student-card.selected {
      background: var(--gradient-success);
      color: var(--white);
      transform: scale(1.05);
      box-shadow: 
        0 20px 40px rgba(79, 172, 254, 0.3),
        inset 0 0 20px rgba(255,255,255,0.2);
    }

    .student-card.correct {
      background: var(--gradient-success);
      color: var(--white);
      animation: correctPulse 0.6s ease-in-out;
    }

    .student-card.wrong {
      background: var(--gradient-secondary);
      color: var(--white);
      animation: wrongShake 0.6s ease-in-out;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .student-name {
      font-size: 1.2rem;
      font-weight: 600;
      line-height: 1.4;
      position: relative;
      z-index: 2;
    }

    /* منطقة اللعبة */
    .game-area {
      background: var(--card-gradient);
      border-radius: 25px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--neumorphism-outset);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .current-student {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 700;
      background: var(--gradient-royal);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
      padding: 20px;
      background-color: rgba(255,255,255,0.7);
      border-radius: 15px;
      box-shadow: var(--neumorphism-inset);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    /* نظام الرسائل المتطور */
    .messages {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
    }

    .message {
      background: var(--card-gradient);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: var(--neumorphism-outset);
      border-left: 5px solid var(--primary-color);
      backdrop-filter: blur(10px);
      animation: messageSlide 0.5s var(--bounce-animation);
      position: relative;
      overflow: hidden;
    }

    @keyframes messageSlide {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .message.success {
      border-left-color: var(--success-color);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    .message.error {
      border-left-color: var(--danger-color);
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    .message.warning {
      border-left-color: var(--warning-color);
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    .message.info {
      border-left-color: var(--info-color);
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    /* شاشة التحميل المتطورة */
    .loading-area {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(10px);
    }

    .loading-area.active {
      display: flex;
    }

    .loading-content {
      text-align: center;
      color: var(--white);
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top: 6px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* النتائج */
    .result-display {
      background: var(--gradient-success);
      color: var(--white);
      padding: 2rem;
      border-radius: 20px;
      margin: 2rem 0;
      font-size: 1.2rem;
      font-weight: 600;
      box-shadow: var(--neumorphism-outset);
      animation: celebrate 1s ease-in-out;
      text-align: center;
      line-height: 1.6;
    }

    @keyframes celebrate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .game-interface {
      width: 100%;
    }

    .student-card.correct::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      color: var(--white);
      font-weight: 900;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
      animation: checkMark 1.2s ease-out;
      z-index: 10;
    }

    @keyframes checkMark {
      0% { 
        transform: translate(-50%, -50%) scale(0) rotateZ(-180deg);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2) rotateZ(-90deg);
        opacity: 1;
      }
      100% { 
        transform: translate(-50%, -50%) scale(1) rotateZ(0deg);
        opacity: 1;
      }
    }

    .student-card.wrong::after {
      content: '✗';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      color: var(--white);
      font-weight: 900;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
      animation: wrongMark 1s ease-out;
      z-index: 10;
    }

    @keyframes wrongMark {
      0% { 
        transform: translate(-50%, -50%) scale(0) rotateZ(180deg);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2) rotateZ(90deg);
        opacity: 1;
      }
      100% { 
        transform: translate(-50%, -50%) scale(1) rotateZ(0deg);
        opacity: 1;
      }
    }

    /* الفئات المساعدة */
    .hidden {
      display: none !important;
    }

    /* واجهة تجميع الأسماء */
    .assemble-interface {
      text-align: center;
      padding: 20px;
    }

    .assemble-title {
      font-size: 2rem;
      font-weight: 700;
      background: var(--gradient-royal);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
      padding: 15px;
      background-color: rgba(255,255,255,0.7);
      border-radius: 15px;
      box-shadow: var(--neumorphism-inset);
    }

    .level-indicator {
      background: var(--gradient-success);
      color: var(--white);
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 600;
      margin-bottom: 20px;
      display: inline-block;
      box-shadow: var(--neumorphism-outset);
    }

    .name-parts-container {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 30px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .original-name {
      font-size: 1.5rem;
      font-weight: 600;
      color: #5a6c7d;
      margin-bottom: 20px;
      opacity: 0.7;
    }

    .shuffled-parts {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
      min-height: 100px;
      padding: 20px;
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      border: 2px dashed rgba(255,255,255,0.3);
    }

    .ordered-parts {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      min-height: 100px;
      padding: 20px;
      background: rgba(79, 172, 254, 0.1);
      border-radius: 15px;
      border: 2px dashed var(--primary-color);
    }

    .name-part {
      background: var(--card-gradient);
      border: 2px solid var(--primary-color);
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: grab;
      transition: all var(--animation-speed) var(--bounce-animation);
      box-shadow: var(--neumorphism-outset);
      user-select: none;
      position: relative;
      min-width: 100px;
      text-align: center;
    }

    .name-part:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        var(--neumorphism-outset),
        0 10px 20px rgba(0,0,0,0.15);
      border-color: var(--success-color);
    }

    .name-part:active {
      cursor: grabbing;
      transform: scale(0.95);
    }

    .name-part.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }

    .drop-zone {
      min-height: 80px;
      border: 2px dashed var(--primary-color);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
      transition: all var(--animation-speed) var(--smooth-animation);
      background: rgba(255,255,255,0.05);
    }

    .drop-zone.dragover {
      border-color: var(--success-color);
      background: rgba(79, 172, 254, 0.1);
      transform: scale(1.02);
    }

    .assemble-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient-success);
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }

    .stats-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-item {
      background: var(--card-gradient);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      box-shadow: var(--neumorphism-inset);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #5a6c7d;
      margin-top: 5px;
    }

    /* واجهة اختيار الطلاب - الوضع الانتقائي */
    .student-selection-interface {
      text-align: center;
      padding: 20px;
      width: 100%;
    }

    .selection-title {
      font-size: 2.2rem;
      font-weight: 700;
      background: var(--gradient-royal);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      padding: 15px;
      background-color: rgba(255,255,255,0.7);
      border-radius: 15px;
      box-shadow: var(--neumorphism-inset);
    }

    .selection-subtitle {
      font-size: 1.1rem;
      color: #5a6c7d;
      margin-bottom: 30px;
      font-weight: 500;
    }

    .selection-methods {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .method-tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 25px;
    }

    .method-tab {
      background: rgba(255,255,255,0.7);
      border: 2px solid transparent;
      border-radius: 25px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      font-family: 'Cairo', sans-serif;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-animation);
      box-shadow: var(--neumorphism-outset);
    }

    .method-tab:hover {
      transform: translateY(-2px);
      box-shadow: 
        var(--neumorphism-outset),
        0 10px 20px rgba(0,0,0,0.15);
    }

    .method-tab.active {
      background: var(--gradient-primary);
      color: var(--white);
      border-color: var(--primary-color);
      transform: scale(1.05);
    }

    .selection-content {
      min-height: 300px;
      padding: 20px;
    }

    /* بطاقات اختيار الطلاب */
    .student-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
      padding: 10px;
    }

    .student-selection-card {
      background: var(--card-gradient);
      border-radius: 18px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-animation);
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: var(--neumorphism-outset);
      position: relative;
      overflow: hidden;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .student-selection-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-success);
      transform: scaleX(0);
      transition: transform var(--animation-speed) var(--smooth-animation);
    }

    .student-selection-card:hover::before {
      transform: scaleX(1);
    }

    .student-selection-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 
        var(--neumorphism-outset),
        0 25px 50px rgba(0,0,0,0.15);
      border-color: var(--success-color);
    }

    .student-avatar {
      width: 60px;
      height: 60px;
      background: var(--gradient-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      color: var(--white);
      font-size: 1.8rem;
      box-shadow: var(--neumorphism-outset);
    }

    .student-selection-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .selection-badge {
      background: var(--gradient-success);
      color: var(--white);
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      opacity: 0.8;
      transition: all var(--animation-speed) var(--smooth-animation);
    }

    .student-selection-card:hover .selection-badge {
      opacity: 1;
      transform: scale(1.1);
    }

    /* قائمة اختيار الطلاب */
    .student-selection-list {
      background: rgba(255,255,255,0.7);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--neumorphism-inset);
      max-height: 400px;
      overflow-y: auto;
    }

    .list-header {
      background: var(--gradient-primary);
      color: var(--white);
      padding: 15px 20px;
      font-weight: 600;
      font-size: 1.1rem;
      text-align: center;
    }

    .student-count {
      background: rgba(255,255,255,0.2);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .student-list-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.5);
      cursor: pointer;
      transition: all var(--animation-speed) var(--smooth-animation);
      position: relative;
    }

    .student-list-item:hover {
      background: rgba(79, 172, 254, 0.1);
      transform: translateX(5px);
    }

    .student-list-item:last-child {
      border-bottom: none;
    }

    .student-number {
      width: 40px;
      height: 40px;
      background: var(--gradient-royal);
      color: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      margin-left: 15px;
      box-shadow: var(--neumorphism-outset);
    }

    .student-list-name {
      flex: 1;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color);
      text-align: right;
    }

    .select-button {
      background: var(--gradient-success);
      color: var(--white);
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all var(--animation-speed) var(--bounce-animation);
      box-shadow: var(--neumorphism-outset);
    }

    .student-list-item:hover .select-button {
      transform: scale(1.1);
      box-shadow: 
        var(--neumorphism-outset),
        0 10px 20px rgba(0,0,0,0.15);
    }

    .selection-controls {
      margin-top: 25px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    /* واجهة الوضع الانتقائي */
    .manual-game-interface {
      width: 100%;
      padding: 20px;
    }

    .target-student-display {
      background: var(--gradient-royal);
      color: var(--white);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: var(--neumorphism-outset);
      animation: pulse 2s infinite;
    }

    .target-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 15px;
      opacity: 0.9;
    }

    .target-name {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .target-instruction {
      font-size: 1.1rem;
      opacity: 0.8;
      font-weight: 500;
    }

    .random-progress {
      background: var(--gradient-primary);
      color: var(--white);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      animation: progressPulse 2s ease-in-out infinite;
    }

    @keyframes progressPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      }
      50% {
        transform: scale(1.02);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.5);
      }
    }

    .mode-indicator {
      background: var(--gradient-success);
      color: var(--white);
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 8px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(39, 174, 96, 0.3);
      animation: modeGlow 3s ease-in-out infinite;
    }

    @keyframes modeGlow {
      0%, 100% {
        opacity: 0.9;
        transform: scale(1);
      }
      50% {
        opacity: 1;
        transform: scale(1.01);
      }
    }

    /* واجهة الإعدادات */
    .settings-interface {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px;
      background: var(--card-bg);
      border-radius: 25px;
      box-shadow: var(--neumorphism-shadow);
      animation: slideIn 0.6s var(--smooth-animation);
    }

    .settings-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .settings-title {
      font-size: 2rem;
      font-weight: 700;
      background: var(--gradient-primary);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .settings-subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .settings-content {
      display: grid;
      gap: 30px;
      margin-bottom: 40px;
    }

    .settings-section {
      background: rgba(255, 255, 255, 0.1);
      padding: 25px;
      border-radius: 20px;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding: 10px 0;
    }

    .setting-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
      color: var(--text-primary);
      cursor: pointer;
    }

    .setting-text {
      font-weight: 500;
    }

    .volume-slider {
      width: 150px;
      margin: 0 10px;
    }

    .volume-display {
      font-weight: 600;
      color: var(--primary-color);
      min-width: 40px;
    }

    .settings-controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* تحسينات للأجهزة المحمولة */
    @media (max-width: 768px) {
      .settings-interface {
        padding: 20px;
        margin: 10px;
      }
      
      .setting-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .volume-slider {
        width: 100%;
      }
      
      .settings-controls {
        flex-direction: column;
      }
    }

    /* واجهة وضع البقاء */
    .survival-interface {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      animation: slideIn 0.6s var(--smooth-animation);
    }

    .survival-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .survival-title {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #e74c3c, #ff6b35, #f39c12);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
      text-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
      animation: fireGlow 3s ease-in-out infinite;
    }

    .survival-level {
      font-size: 1.2rem;
      color: var(--primary-color);
      font-weight: 600;
      background: rgba(52, 152, 219, 0.1);
      padding: 8px 20px;
      border-radius: 20px;
      border: 2px solid var(--primary-color);
    }

    @keyframes fireGlow {
      0%, 100% {
        filter: brightness(1) drop-shadow(0 0 10px rgba(231, 76, 60, 0.3));
      }
      50% {
        filter: brightness(1.2) drop-shadow(0 0 20px rgba(231, 76, 60, 0.6));
      }
    }

    .survival-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .survival-stat-card {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      box-shadow: var(--neumorphism-shadow);
      transition: all 0.3s var(--smooth-animation);
      border: 2px solid transparent;
    }

    .survival-stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .survival-stat-card.lives {
      border-color: #e74c3c;
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.05));
    }

    .survival-stat-card.score {
      border-color: #f39c12;
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(211, 84, 0, 0.05));
    }

    .survival-stat-card.streak {
      border-color: #e67e22;
      background: linear-gradient(135deg, rgba(230, 126, 34, 0.1), rgba(191, 85, 18, 0.05));
    }

    .survival-stat-card.timer {
      border-color: #9b59b6;
      background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), rgba(142, 68, 173, 0.05));
    }

    .survival-stat-card.best {
      border-color: #f1c40f;
      background: linear-gradient(135deg, rgba(241, 196, 15, 0.1), rgba(183, 149, 11, 0.05));
    }

    .survival-stat-card .stat-icon {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }

    .survival-stat-card .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .survival-stat-card .stat-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .survival-target {
      text-align: center;
      margin-bottom: 30px;
    }

    .target-question {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
    }

    .survival-hint {
      color: var(--text-secondary);
      font-size: 1rem;
      background: rgba(52, 152, 219, 0.1);
      padding: 8px 16px;
      border-radius: 15px;
      border: 1px solid rgba(52, 152, 219, 0.3);
    }

    .survival-card {
      border: 3px solid transparent;
      transition: all 0.3s var(--smooth-animation);
    }

    .survival-card:hover {
      border-color: var(--primary-color);
      box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
      transform: translateY(-5px) scale(1.02);
    }

    .survival-controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }

    /* نهاية وضع البقاء */
    .survival-end {
      max-width: 600px;
      margin: 0 auto;
      padding: 40px;
      background: var(--card-bg);
      border-radius: 25px;
      box-shadow: var(--neumorphism-shadow);
      text-align: center;
      animation: slideIn 0.8s var(--smooth-animation);
    }

    .survival-end-header {
      margin-bottom: 30px;
    }

    .end-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }

    .end-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--danger-color);
      margin-bottom: 10px;
    }

    .survival-final-stats {
      margin-bottom: 30px;
    }

    .final-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .final-stat .stat-label {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .final-stat .stat-value {
      color: var(--text-primary);
      font-weight: 700;
      font-size: 1.1rem;
    }

    .final-stat .stat-value.highlight {
      color: var(--primary-color);
      font-size: 1.3rem;
    }

    .new-record {
      background: var(--gradient-success);
      color: var(--white);
      padding: 15px;
      border-radius: 15px;
      font-weight: 700;
      font-size: 1.2rem;
      margin-top: 20px;
      animation: pulse 2s infinite;
    }

    .best-score {
      color: var(--text-secondary);
      font-style: italic;
      margin-top: 15px;
    }

    .survival-end-controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* استجابة للأجهزة المحمولة - وضع البقاء */
    @media (max-width: 768px) {
      .survival-interface {
        padding: 15px;
      }
      
      .survival-title {
        font-size: 2rem;
      }
      
      .survival-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .survival-stat-card {
        padding: 10px;
      }
      
      .target-question {
        font-size: 1.4rem;
      }
      
      .survival-controls {
        flex-direction: column;
      }
      
      .survival-end {
        margin: 10px;
      }
    }
    .survival-instructions {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 30px;
      padding: 40px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.3);
      max-width: 900px;
      margin: 20px auto;
      color: white;
      text-align: right;
      direction: rtl;
      position: relative;
      overflow: hidden;
      animation: floatIn 0.8s ease-out;
    }

    .survival-instructions::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: shimmer 3s infinite;
    }

    .instructions-header {
      text-align: center;
      margin-bottom: 40px;
      position: relative;
      z-index: 2;
    }

    .instructions-title {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 10px rgba(0,0,0,0.3);
      font-weight: bold;
    }

    .instructions-subtitle {
      font-size: 1.3em;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .instruction-section {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      z-index: 2;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 1.5em;
      margin-bottom: 15px;
      color: #FFD700;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: bold;
    }

    .section-content {
      font-size: 1.1em;
      line-height: 1.8;
      margin-bottom: 15px;
    }

    .highlight-box {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 15px;
      margin: 15px 0;
      border-left: 4px solid #FFD700;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .instructions-controls {
      text-align: center;
      margin-top: 30px;
      gap: 20px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      position: relative;
      z-index: 2;
    }

    .instructions-controls .btn {
      font-size: 1.2em;
      padding: 15px 30px;
      margin: 5px;
      min-width: 150px;
    }

    /* Enhanced Survival Interface */
    .survival-header .survival-explanation {
      font-size: 1.1em;
      opacity: 0.9;
      margin-top: 10px;
    }

    .stat-help {
      font-size: 0.85em;
      color: #666;
      font-style: italic;
      margin-top: 5px;
    }

    .survival-progress {
      background: linear-gradient(145deg, #f0f0f0, #cacaca);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 
        8px 8px 20px rgba(163, 177, 198, 0.6),
        -8px -8px 20px rgba(255, 255, 255, 0.8);
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-weight: bold;
      color: #333;
    }

    .progress-bar {
      height: 15px;
      background: linear-gradient(145deg, #e0e0e0, #c0c0c0);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: inset 4px 4px 8px rgba(163, 177, 198, 0.4);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 10px;
      transition: width 0.5s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
    }

    .survival-target {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      border-radius: 20px;
      padding: 25px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 15px 35px rgba(252, 182, 159, 0.3);
    }

    .target-question {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #d35400;
    }

    .target-student-name {
      font-size: 2.2em;
      font-weight: bold;
      color: #2c3e50;
      background: rgba(255, 255, 255, 0.8);
      padding: 15px 25px;
      border-radius: 15px;
      margin: 15px 0;
      border: 3px solid #e74c3c;
      box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
      animation: targetPulse 2s infinite;
    }

    @keyframes targetPulse {
      0%, 100% { 
        transform: scale(1);
        border-color: #e74c3c;
      }
      50% { 
        transform: scale(1.02);
        border-color: #c0392b;
      }
    }

    .survival-hint {
      font-size: 1.1em;
      color: #e67e22;
      font-weight: 500;
    }

    .survival-tips {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .tip {
      background: linear-gradient(145deg, #fff9e6, #fff3d3);
      border-radius: 15px;
      padding: 15px;
      border-left: 4px solid #f39c12;
      box-shadow: 0 8px 20px rgba(243, 156, 18, 0.2);
      font-size: 0.95em;
      line-height: 1.5;
    }

    /* Enhanced Animations */
    @keyframes shimmer {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    @keyframes floatIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Teacher Selection Interface */
    .teacher-selection-interface {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px;
      direction: rtl;
    }

    .selection-header {
      text-align: center;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 25px;
      padding: 30px;
      color: white;
      box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
    }

    .selection-title {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .selection-subtitle {
      font-size: 1.3em;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .selection-hint {
      font-size: 1em;
      color: #FFD700;
      font-style: italic;
    }

    .secret-selection-area {
      background: linear-gradient(145deg, #f0f0f0, #cacaca);
      border-radius: 25px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 
        15px 15px 30px rgba(163, 177, 198, 0.6),
        -15px -15px 30px rgba(255, 255, 255, 0.8);
    }

    .selection-instruction {
      text-align: center;
      margin-bottom: 30px;
    }

    .instruction-text {
      font-size: 1.3em;
      color: #333;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .privacy-notice {
      font-size: 1em;
      color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
      padding: 10px 20px;
      border-radius: 10px;
      display: inline-block;
    }

    .students-grid-selection {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
    }

    .teacher-selection-card {
      background: linear-gradient(145deg, #ffffff, #e6e6e6);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        8px 8px 16px rgba(163, 177, 198, 0.6),
        -8px -8px 16px rgba(255, 255, 255, 0.8);
    }

    .teacher-selection-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 
        12px 12px 24px rgba(163, 177, 198, 0.7),
        -12px -12px 24px rgba(255, 255, 255, 0.9);
    }

    .teacher-selection-card .student-avatar {
      font-size: 2.5em;
      margin-bottom: 15px;
    }

    .teacher-selection-card .student-name {
      font-size: 1.1em;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .selection-indicator {
      font-size: 0.9em;
      color: #667eea;
      font-style: italic;
    }

    .selection-controls {
      text-align: center;
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Survival Game Interface */
    .survival-game-interface {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      direction: rtl;
    }

    .game-header {
      text-align: center;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      border-radius: 20px;
      padding: 25px;
      color: white;
      box-shadow: 0 15px 35px rgba(255, 107, 107, 0.3);
    }

    .game-title {
      font-size: 2em;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .game-instruction {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .survival-stats-bar {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .stat-item {
      background: linear-gradient(145deg, #f0f0f0, #cacaca);
      border-radius: 15px;
      padding: 15px 25px;
      text-align: center;
      box-shadow: 
        8px 8px 16px rgba(163, 177, 198, 0.6),
        -8px -8px 16px rgba(255, 255, 255, 0.8);
      min-width: 120px;
    }

    .stat-icon {
      font-size: 1.8em;
      margin-bottom: 8px;
      display: block;
    }

    .stat-value {
      font-size: 1.8em;
      font-weight: bold;
      color: #667eea;
      display: block;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9em;
      color: #333;
      font-weight: bold;
    }

    /* Students Battlefield */
    .students-battlefield {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      padding: 20px;
      min-height: 400px;
    }

    .battle-card {
      background: linear-gradient(145deg, #ffffff, #e6e6e6);
      border-radius: 15px;
      padding: 0;
      cursor: pointer;
      transition: all 0.4s ease;
      transform: translateY(100px);
      opacity: 0;
      perspective: 1000px;
      height: 160px;
      position: relative;
      overflow: hidden;
      box-shadow: 
        8px 8px 16px rgba(163, 177, 198, 0.6),
        -8px -8px 16px rgba(255, 255, 255, 0.8);
    }

    .battle-card.card-drop-in {
      transform: translateY(0);
      opacity: 1;
      animation: cardDrop 0.6s ease-out;
    }

    .battle-card:hover:not(.disabled):not(.exploding-card) {
      transform: translateY(-8px) scale(1.05);
      box-shadow: 
        15px 15px 30px rgba(163, 177, 198, 0.7),
        -15px -15px 30px rgba(255, 255, 255, 0.9);
    }

    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px;
    }

    .card-front {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .battle-card .student-avatar {
      font-size: 2.5em;
      margin-bottom: 10px;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
    }

    .battle-card .student-name {
      font-size: 1em;
      font-weight: bold;
      color: #333;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .card-glow {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .battle-card:hover .card-glow {
      opacity: 1;
      animation: shimmer 2s infinite;
    }

    /* Card States */
    .battle-card.disabled {
      pointer-events: none;
      opacity: 0.6;
    }

    .battle-card.correct-selection {
      background: linear-gradient(145deg, #d4edda, #c3e6cb);
      border: 3px solid #28a745;
      animation: correctPulse 1s ease-in-out;
    }

    .battle-card.exploding-card {
      background: linear-gradient(145deg, #f8d7da, #f5c6cb);
      border: 3px solid #dc3545;
      animation: explodeCard 0.8s ease-out;
      pointer-events: none;
    }

    /* Victory Celebration */
    .victory-celebration {
      position: relative;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 30px;
      color: white;
      box-shadow: 0 25px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .celebration-fireworks {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .firework {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #FFD700;
      border-radius: 50%;
      animation: firework 2s infinite;
    }

    .firework:nth-child(1) {
      top: 20%;
      left: 20%;
      animation-delay: 0s;
    }

    .firework:nth-child(2) {
      top: 30%;
      right: 20%;
      animation-delay: 0.5s;
    }

    .firework:nth-child(3) {
      top: 60%;
      left: 50%;
      animation-delay: 1s;
    }

    .victory-content {
      position: relative;
      z-index: 2;
    }

    .victory-icon {
      font-size: 4em;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }

    .victory-title {
      font-size: 2.2em;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .winner-name {
      font-size: 2.5em;
      color: #FFD700;
      font-weight: bold;
      margin: 20px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }

    .victory-message {
      font-size: 1.3em;
      margin-bottom: 30px;
      opacity: 0.9;
    }

    .final-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
      flex-wrap: wrap;
    }

    .final-stats .stat-card {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      min-width: 100px;
      backdrop-filter: blur(10px);
    }

    .celebration-controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 30px;
    }

    /* Game Over Screen */
    .game-over-screen {
      max-width: 700px;
      margin: 0 auto;
      padding: 40px;
      text-align: center;
    }

    .game-over-content {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      border-radius: 25px;
      padding: 40px;
      color: white;
      box-shadow: 0 25px 60px rgba(255, 107, 107, 0.3);
    }

    .game-over-icon {
      font-size: 4em;
      margin-bottom: 20px;
      animation: shake 0.5s ease-in-out infinite;
    }

    .game-over-title {
      font-size: 2.2em;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .game-over-message {
      font-size: 1.2em;
      margin-bottom: 25px;
      opacity: 0.9;
    }

    .reveal-answer {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin: 25px 0;
      backdrop-filter: blur(10px);
    }

    .reveal-text {
      font-size: 1.1em;
      margin-bottom: 10px;
    }

    .correct-answer {
      font-size: 1.8em;
      color: #FFD700;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .game-over-controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 30px;
    }

    /* New Animations */
    @keyframes cardDrop {
      from {
        transform: translateY(-50px) rotateX(-90deg);
        opacity: 0;
      }
      to {
        transform: translateY(0) rotateX(0deg);
        opacity: 1;
      }
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes explodeCard {
      0% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.2) rotate(5deg); }
      50% { transform: scale(1.1) rotate(-5deg); }
      75% { transform: scale(1.15) rotate(3deg); }
      100% { transform: scale(0.8) rotate(0deg); opacity: 0.3; }
    }

    @keyframes firework {
      0% { 
        transform: scale(0);
        opacity: 1;
      }
      50% {
        transform: scale(1);
        opacity: 0.8;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    @keyframes glow {
      from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 20px #FFD700; }
      to { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 40px #FFD700; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .students-battlefield {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
        padding: 15px;
      }
      
      .battle-card {
        height: 130px;
      }
      
      .battle-card .student-avatar {
        font-size: 2em;
      }
      
      .battle-card .student-name {
        font-size: 0.9em;
      }
      
      .survival-stats-bar {
        gap: 15px;
      }
      
      .stat-item {
        min-width: 100px;
        padding: 12px 20px;
      }
      
      .victory-celebration,
      .game-over-content {
        margin: 10px;
        padding: 25px;
      }
      
      .students-grid-selection {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }
    }
        padding: 20px;
        margin: 10px;
      }
      
      .survival-end-controls {
        flex-direction: column;
      }
    }

    /* واجهة إخفاء الطالب المستهدف */
    .hidden-target {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      border: 2px dashed rgba(255, 255, 255, 0.3);
    }

    .secret-icon {
      font-size: 3rem;
      margin-bottom: 10px;
      opacity: 0.7;
    }

    .secret-text {
      font-size: 1.2rem;
      margin-bottom: 15px;
      opacity: 0.8;
      font-weight: 500;
    }

    .reveal-btn, .hide-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: var(--white);
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--animation-speed) var(--smooth-animation);
      font-family: 'Cairo', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .reveal-btn:hover, .hide-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .revealed-target {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .revealed-target .target-name {
      font-size: 2.2rem;
      font-weight: 800;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      border-radius: 12px;
    }

    .hide-btn {
      background: rgba(231, 76, 60, 0.2);
      border-color: rgba(231, 76, 60, 0.3);
    }

    .hide-btn:hover {
      background: rgba(231, 76, 60, 0.3);
    }

    /* المؤشرات البصرية الاحترافية للإجابات */
    .selected-answer {
      transform: scale(1.05);
      z-index: 10;
      position: relative;
    }

    .correct-answer {
      background: var(--gradient-success) !important;
      color: var(--white) !important;
      border-color: var(--success-color) !important;
      box-shadow: 
        0 0 30px rgba(39, 174, 96, 0.6),
        0 0 60px rgba(39, 174, 96, 0.4),
        inset 0 0 20px rgba(255, 255, 255, 0.2) !important;
    }

    .wrong-answer {
      background: var(--gradient-secondary) !important;
      color: var(--white) !important;
      border-color: var(--danger-color) !important;
      box-shadow: 
        0 0 30px rgba(231, 76, 60, 0.6),
        0 0 60px rgba(231, 76, 60, 0.4),
        inset 0 0 20px rgba(255, 255, 255, 0.1) !important;
    }

    .answer-result-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3.5rem;
      color: var(--white);
      font-weight: 900;
      text-shadow: 
        2px 2px 8px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(255, 255, 255, 0.3);
      z-index: 15;
      animation: resultIconAppear 0.6s var(--bounce-animation);
    }

    @keyframes resultIconAppear {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(-180deg);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.3) rotate(-90deg);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    /* جزيئات الاحتفال */
    .celebration-particle {
      position: absolute;
      top: 0;
      width: 8px;
      height: 8px;
      background: radial-gradient(circle, #ffd700, #ffed4e);
      border-radius: 50%;
      pointer-events: none;
      animation: particleFloat 2s ease-out forwards;
      z-index: 20;
    }

    @keyframes particleFloat {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      50% {
        transform: translateY(-50px) scale(1.2);
        opacity: 0.8;
      }
      100% {
        transform: translateY(-100px) scale(0.5);
        opacity: 0;
      }
    }

    /* تحسين حركات النجاح والخطأ */
    @keyframes correctPulse {
      0%, 100% { 
        transform: scale(1.05); 
        filter: brightness(1);
      }
      50% { 
        transform: scale(1.15); 
        filter: brightness(1.3);
      }
    }

    @keyframes wrongShake {
      0%, 100% { 
        transform: translateX(0) scale(1.05); 
      }
      10%, 30%, 50%, 70%, 90% { 
        transform: translateX(-8px) scale(1.05); 
      }
      20%, 40%, 60%, 80% { 
        transform: translateX(8px) scale(1.05); 
      }
    }

    /* تأثيرات إضافية للبطاقات المختارة */
    .selected-answer::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(45deg, 
        transparent, 
        rgba(255, 255, 255, 0.4), 
        transparent, 
        rgba(255, 255, 255, 0.4), 
        transparent);
      border-radius: 23px;
      animation: borderGlow 1.5s linear infinite;
      z-index: -1;
    }

    @keyframes borderGlow {
      0% {
        background-position: 0% 0%;
      }
      100% {
        background-position: 100% 100%;
      }
    }

    /* تأثير الوهج للإجابة الصحيحة */
    .correct-answer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at center, 
        rgba(39, 174, 96, 0.3) 0%, 
        transparent 70%);
      border-radius: 20px;
      animation: successGlow 2s ease-in-out infinite;
      pointer-events: none;
      z-index: 5;
    }

    @keyframes successGlow {
      0%, 100% {
        opacity: 0.3;
        transform: scale(1);
      }
      50% {
        opacity: 0.7;
        transform: scale(1.05);
      }
    }

    /* تأثير الاهتزاز للإجابة الخاطئة */
    .wrong-answer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at center, 
        rgba(231, 76, 60, 0.3) 0%, 
        transparent 70%);
      border-radius: 20px;
      animation: errorPulse 1s ease-in-out 3;
      pointer-events: none;
      z-index: 5;
    }

    @keyframes errorPulse {
      0%, 100% {
        opacity: 0.2;
        transform: scale(1);
      }
      50% {
        opacity: 0.6;
        transform: scale(1.02);
      }
    }

    /* تحسينات للاستجابة على الأجهزة المختلفة */
    @media (max-width: 768px) {
      .answer-result-icon {
        font-size: 2.5rem;
      }
      
      .celebration-particle {
        width: 6px;
        height: 6px;
      }
      
      .selected-answer {
        transform: scale(1.02);
      }
      
      .correct-answer,
      .wrong-answer {
        box-shadow: 
          0 0 15px rgba(39, 174, 96, 0.5),
          0 0 30px rgba(39, 174, 96, 0.3),
          inset 0 0 10px rgba(255, 255, 255, 0.1) !important;
      }
    }

    /* تحسين الأداء للحركات */
    .student-card {
      will-change: transform, opacity;
      backface-visibility: hidden;
    }

    .celebration-particle {
      will-change: transform, opacity;
      backface-visibility: hidden;
    }

    .game-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-gradient);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: var(--neumorphism-outset);
      transition: all var(--animation-speed) var(--bounce-animation);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 
        var(--neumorphism-outset),
        0 15px 30px rgba(0,0,0,0.15);
    }

    .stat-card.lives {
      border-left: 5px solid var(--danger-color);
    }

    .stat-card.attempts {
      border-left: 5px solid var(--info-color);
    }

    .stat-card.correct {
      border-left: 5px solid var(--success-color);
    }

    .stat-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .stat-card .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .stat-card .stat-label {
      font-size: 0.9rem;
      color: #5a6c7d;
      font-weight: 500;
    }

    .manual-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    /* النوافذ المنبثقة الاحترافية */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .modal-content {
      background: var(--card-gradient);
      border-radius: 25px;
      padding: 40px;
      text-align: center;
      box-shadow: 
        var(--neumorphism-outset),
        0 30px 60px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      max-width: 500px;
      width: 90%;
      animation: modalSlideIn 0.4s var(--bounce-animation);
    }

    @keyframes modalSlideIn {
      from {
        transform: scale(0.7) translateY(-50px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    /* نافذة النجاح */
    .success-content {
      background: linear-gradient(135deg, var(--success-color) 0%, var(--primary-color) 100%);
      color: var(--white);
    }

    .success-animation {
      position: relative;
      margin-bottom: 25px;
    }

    .success-icon {
      font-size: 4rem;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-20px);
      }
      60% {
        transform: translateY(-10px);
      }
    }

    .success-confetti {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 2px, transparent 2px);
      background-size: 20px 20px;
      animation: confettiRain 2s infinite;
    }

    @keyframes confettiRain {
      0% {
        transform: translateX(-50%) translateY(-20px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateX(-50%) translateY(100px) rotate(360deg);
        opacity: 0;
      }
    }

    .success-title {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .winner-name {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.2);
      padding: 10px 20px;
      border-radius: 15px;
    }

    .success-message {
      font-size: 1.2rem;
      margin-bottom: 25px;
      opacity: 0.9;
    }

    /* نافذة الكشف */
    .reveal-content {
      background: linear-gradient(135deg, var(--warning-color) 0%, var(--danger-color) 100%);
      color: var(--white);
    }

    .reveal-animation {
      margin-bottom: 25px;
    }

    .reveal-icon {
      font-size: 4rem;
      animation: reveal 2s ease-in-out;
    }

    @keyframes reveal {
      0%, 100% {
        transform: scale(1) rotate(0deg);
      }
      25% {
        transform: scale(1.1) rotate(-10deg);
      }
      75% {
        transform: scale(1.1) rotate(10deg);
      }
    }

    .reveal-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .revealed-name {
      font-size: 2.2rem;
      font-weight: 800;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.2);
      padding: 15px 25px;
      border-radius: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .reveal-message {
      font-size: 1.1rem;
      margin-bottom: 25px;
      opacity: 0.9;
    }

    /* إحصائيات النوافذ */
    .success-stats, .reveal-stats {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .success-stats .stat, .reveal-stats .stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .success-stats .stat:last-child, .reveal-stats .stat:last-child {
      margin-bottom: 0;
    }

    .stat-label {
      font-weight: 500;
    }

    .stat-value {
      font-weight: 700;
    }

    /* أزرار النوافذ */
    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .modal-buttons .btn {
      min-width: 150px;
    }

    /* تحسينات الاستجابة */
    @media (max-width: 768px) {
      .main-container {
        padding: 15px;
      }

      .main-title {
        font-size: 2.5rem;
      }

      .controls {
        padding: 20px;
      }

      .control-group {
        grid-template-columns: 1fr;
      }

      .students-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
      }

      .student-card {
        padding: 20px;
        min-height: 120px;
      }

      .messages {
        right: 10px;
        left: 10px;
        max-width: none;
      }

      .back-button {
        top: 10px;
        left: 10px;
        padding: 12px 20px;
      }

      /* تحسينات تجميع الأسماء للهواتف */
      .assemble-title {
        font-size: 1.5rem;
      }

      .shuffled-parts, .ordered-parts {
        flex-direction: column;
        align-items: center;
      }

      .name-part {
        width: 90%;
        max-width: 200px;
      }

      .assemble-controls {
        flex-direction: column;
        gap: 10px;
      }

      .assemble-controls .btn {
        width: 100%;
        max-width: 300px;
      }

      .stats-display {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      /* تحسينات واجهة اختيار الطلاب للهواتف */
      .selection-title {
        font-size: 1.6rem;
      }

      .method-tabs {
        flex-direction: column;
        gap: 8px;
      }

      .method-tab {
        width: 100%;
        max-width: 250px;
        margin: 0 auto;
      }

      .student-selection-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
      }

      .student-selection-card {
        padding: 15px;
        min-height: 140px;
      }

      .student-avatar {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
      }

      .student-list-item {
        padding: 12px 15px;
      }

      .student-number {
        width: 35px;
        height: 35px;
        font-size: 0.8rem;
      }

      .student-list-name {
        font-size: 1rem;
      }

      .select-button {
        padding: 6px 15px;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .main-title {
        font-size: 2rem;
      }

      .students-grid {
        grid-template-columns: 1fr;
      }

      .student-card {
        min-height: 100px;
      }

      .current-student {
        font-size: 2rem;
      }

      .assemble-title {
        font-size: 1.3rem;
      }

      .name-part {
        font-size: 1rem;
        padding: 10px 15px;
      }

      .level-indicator {
        font-size: 0.9rem;
        padding: 8px 15px;
      }

      /* تحسينات إضافية لواجهة اختيار الطلاب */
      .selection-title {
        font-size: 1.4rem;
      }

      .student-selection-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .student-selection-card {
        min-height: 120px;
        padding: 12px;
      }

      .student-avatar {
        width: 45px;
        height: 45px;
        font-size: 1.3rem;
        margin-bottom: 10px;
      }

      .student-selection-name {
        font-size: 1rem;
      }

      .selection-badge {
        font-size: 0.8rem;
        padding: 5px 12px;
      }

      .student-selection-list {
        max-height: 300px;
      }

      .list-header {
        padding: 12px 15px;
        font-size: 1rem;
      }

      .student-count {
        font-size: 0.8rem;
        padding: 4px 12px;
      }

      /* تحسينات النوافذ للهواتف */
      .modal-content {
        padding: 25px;
        max-width: 95%;
      }

      .success-title, .reveal-title {
        font-size: 2rem;
      }

      .winner-name, .revealed-name {
        font-size: 1.6rem;
        padding: 8px 15px;
      }

      .success-message, .reveal-message {
        font-size: 1rem;
      }

      .modal-buttons {
        flex-direction: column;
        gap: 10px;
      }

      .modal-buttons .btn {
        width: 100%;
        min-width: auto;
      }

      .target-name {
        font-size: 2rem;
      }

      .game-stats {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .manual-controls {
        flex-direction: column;
        gap: 15px;
      }

      .manual-controls .btn {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
      }

      /* تحسينات إخفاء الطالب للهواتف */
      .hidden-target, .revealed-target {
        padding: 15px;
        margin: 10px 0;
      }

      .secret-icon {
        font-size: 2.5rem;
      }

      .secret-text {
        font-size: 1rem;
      }

      .reveal-btn, .hide-btn {
        padding: 8px 15px;
        font-size: 0.8rem;
      }

      .revealed-target .target-name {
        font-size: 1.8rem;
        padding: 8px 15px;
      }
    }
  </style>
</head>
<body>
  <!-- شاشة التحميل -->
  <div class="loading-area" id="loadingArea">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">جاري التحميل...</div>
    </div>
  </div>

  <!-- نظام الرسائل -->
  <div class="messages" id="messages"></div>

  <!-- زر العودة -->
  <a href="../index.html" class="back-button">
    <i class="fas fa-arrow-right"></i>
  </a>

  <!-- الحاوية الرئيسية -->
  <div class="main-container">
    <!-- رأس الصفحة -->
    <div class="header">
      <h1 class="main-title">🎯 من هو؟</h1>
      <p class="subtitle">لعبة تفاعلية لتخمين هوية الطلاب </p>
    </div>

    <!-- أدوات التحكم الرئيسية -->
    <div class="controls">
      <div class="control-group">
        <div class="form-group">
          <label for="classSelect">📚 اختيار الصف</label>
          <select id="classSelect" class="form-control">
            <option value="">اختر الصف الدراسي</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="modeSelect">🎮 وضع اللعبة</label>
          <select id="modeSelect" class="form-control">
            <option value="random">🎲 فردي عشوائي</option>
            <option value="manual">🎯 فردي انتقائي</option>
            <option value="survival">🔥 وضع البقاء</option>
            <option value="assemble">🧩 تجميع أجزاء الاسم</option>
          </select>
        </div>
      </div>

      <div class="control-group">
        <div class="form-group">
          <label for="timeSelect">⏱️ الوقت المحدد</label>
          <select id="timeSelect" class="form-control">
            <option value="0">🚫 بلا وقت محدد</option>
            <option value="30">⚡ 30 ثانية</option>
            <option value="60">🟢 60 ثانية</option>
            <option value="120">🟡 120 ثانية</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="livesSelect">❤️ عدد المحاولات</label>
          <select id="livesSelect" class="form-control">
            <option value="1">❤️ محاولة واحدة</option>
            <option value="3">💕 3 محاولات</option>
            <option value="5">💖 5 محاولات</option>
            <option value="-1">💝 محاولات لا نهائية</option>
          </select>
        </div>
      </div>

      <!-- أزرار بدء اللعبة -->
      <div class="game-buttons">
        <button id="startGameBtn" class="btn btn-primary" disabled>
          <i class="fas fa-play"></i>
          🎲 بدء اللعبة
        </button>
        <button id="settingsBtn" class="btn btn-cosmic">
          <i class="fas fa-cog"></i>
          ⚙️ الإعدادات
        </button>
      </div>
    </div>

    <!-- منطقة الرسائل -->
    <div id="messageArea"></div>

    <!-- منطقة اللعبة -->
    <div class="game-area" id="gameArea">
      <p><i class="fas fa-info-circle"></i> اختر الصف ونمط اللعبة لبدء التحدي</p>
    </div>
  </div>

  <script>
    // نظام الصوتيات المتقدم
    class SoundSystem {
      constructor() {
        this.sounds = {};
        this.musicEnabled = true;
        this.soundEnabled = true;
        this.volume = 0.6;
        this.initializeSounds();
      }

      initializeSounds() {
        this.soundMap = {
          'click': 'cosmic-click.mp3',
          'correct': 'epic-victory.mp3',
          'wrong': 'point-lose.mp3',
          'reveal': 'knowledge-unlock.mp3',
          'notification': 'ai-notification.mp3',
          'success': 'crystal-bonus.mp3',
          'error': 'shield-block.mp3'
        };

        this.sounds = {};
        Object.keys(this.soundMap).forEach(key => {
          this.sounds[key] = this.createAudioElement(this.soundMap[key]);
        });
      }

      createAudioElement(filename) {
        const audio = new Audio(`../assets/media/sounds/kingdom-sounds/${filename}`);
        audio.volume = this.volume;
        audio.preload = 'auto';
        
        audio.addEventListener('error', (e) => {
          console.warn(`فشل في تحميل الصوت: ${filename}`);
        });
        
        return audio;
      }

      play(soundName, options = {}) {
        if (!this.soundEnabled) return;
        
        const audio = this.sounds[soundName];
        if (!audio) {
          console.warn(`الصوت غير موجود: ${soundName}`);
          return;
        }

        try {
          audio.currentTime = 0;
          audio.volume = options.volume || this.volume;
          
          const playPromise = audio.play();
          if (playPromise !== undefined) {
            playPromise
              .then(() => {
                if (options.onComplete) {
                  audio.addEventListener('ended', options.onComplete, { once: true });
                }
              })
              .catch(e => console.warn(`خطأ في تشغيل الصوت ${soundName}:`, e));
          }
        } catch (error) {
          console.warn(`فشل في تشغيل الصوت ${soundName}:`, error);
        }
      }
    }

    // نظام إدارة الحالة
    class GameState {
      constructor() {
        this.studentData = null;
        this.currentClass = '';
        this.gameMode = '';
        this.timeLimit = 60;
        this.maxLives = 3;
        this.targetStudent = '';
        this.allStudents = [];
        this.usedStudents = [];
        this.isLoading = false;
        
        this.stats = {
          score: 0,
          correctAnswers: 0,
          wrongAnswers: 0,
          streak: 0,
          lives: 3,
          gamesPlayed: 0
        };

        // خصائص وضع البقاء
        this.survival = {
          level: 1,
          timeLeft: 30,
          difficultyMultiplier: 1,
          bestScore: parseInt(localStorage.getItem('whoisSurvivalBest') || '0'),
          startTime: null,
          bonusLives: 0
        };
      }

      reset() {
        this.currentClass = '';
        this.gameMode = '';
        this.targetStudent = '';
        this.allStudents = [];
        this.usedStudents = [];
        this.stats.lives = this.maxLives;
        this.stats.streak = 0;
      }

      updateStats(isCorrect, timeUsed = 0) {
        this.stats.gamesPlayed++;

        if (isCorrect) {
          this.stats.correctAnswers++;
          this.stats.streak++;
          this.stats.score += 10;
        } else {
          this.stats.wrongAnswers++;
          this.stats.streak = 0;
          // تقليل المحاولات فقط إذا لم تكن لا نهائية
          if (this.maxLives !== -1) {
            this.stats.lives--;
          }
        }
      }

      getSuccessRate() {
        if (this.stats.gamesPlayed === 0) return 0;
        return Math.round((this.stats.correctAnswers / this.stats.gamesPlayed) * 100);
      }
    }

    // نظام إدارة الرسائل
    class MessageSystem {
      constructor() {
        this.container = document.getElementById('messageArea');
      }

      show(message, type = 'info', duration = 5000) {
        this.clear();

        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        messageEl.innerHTML = message;

        this.container.appendChild(messageEl);

        if (duration > 0) {
          setTimeout(() => {
            this.clear();
          }, duration);
        }

        return messageEl;
      }

      clear() {
        this.container.innerHTML = '';
      }
    }

    // نظام تجميع الأسماء
    class NameAssemblyGame {
      constructor(gameInstance) {
        this.game = gameInstance;
        this.currentLevel = 1;
        this.maxLevel = 3;
        this.currentName = '';
        this.nameParts = [];
        this.shuffledParts = [];
        this.orderedParts = [];
        this.correctAnswers = 0;
        this.totalAttempts = 0;
        this.requiredCorrectForNext = 3;
        
        this.draggedElement = null;
      }

      start() {
        this.currentLevel = 1;
        this.correctAnswers = 0;
        this.totalAttempts = 0;
        this.setupNewRound();
      }

      setupNewRound() {
        // اختيار اسم عشوائي
        const students = this.game.state.allStudents;
        if (!students || students.length === 0) {
          this.game.messages.show('⚠️ لا توجد بيانات طلاب متاحة', 'warning');
          return;
        }

        this.currentName = students[Math.floor(Math.random() * students.length)];
        this.generateNameParts();
        this.displayInterface();
      }

      generateNameParts() {
        const fullNameParts = this.currentName.trim().split(/\s+/);
        
        // إزالة كلمات "بن" و "بنت" من أجزاء الاسم
        const filteredParts = fullNameParts.filter(part => 
          part !== 'بن' && part !== 'بنت' && part.trim() !== ''
        );
        
        // تحديد أجزاء الاسم حسب المستوى
        switch(this.currentLevel) {
          case 1: // الاسم الأول + الثاني
            this.nameParts = filteredParts.slice(0, 2);
            break;
          case 2: // الاسم الأول + الثاني + الثالث
            this.nameParts = filteredParts.slice(0, 3);
            break;
          case 3: // الاسم الكامل (بدون بن/بنت)
            this.nameParts = filteredParts;
            break;
        }

        // التأكد من وجود أجزاء كافية
        if (this.nameParts.length === 0) {
          // في حالة عدم وجود أجزاء صالحة، استخدم الاسم الأصلي
          this.nameParts = [this.currentName];
        }

        // خلط الأجزاء
        this.shuffledParts = [...this.nameParts].sort(() => Math.random() - 0.5);
        this.orderedParts = [];
      }

      displayInterface() {
        const gameArea = document.getElementById('gameArea');
        
        // إنشاء عرض الاسم الأصلي مع إزالة بن/بنت للتوضيح
        const filteredName = this.currentName.split(/\s+/)
          .filter(part => part !== 'بن' && part !== 'بنت' && part.trim() !== '')
          .join(' ');
        
        gameArea.innerHTML = `
          <div class="assemble-interface">
            <div class="assemble-title">🧩 جمع أجزاء الاسم</div>
            
            <div class="level-indicator">
              المرحلة ${this.currentLevel} من ${this.maxLevel}
              ${this.getLevelDescription()}
            </div>

            <div class="stats-display">
              <div class="stat-item">
                <div class="stat-value">${this.correctAnswers}</div>
                <div class="stat-label">إجابات صحيحة</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${this.totalAttempts}</div>
                <div class="stat-label">إجمالي المحاولات</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${this.requiredCorrectForNext - this.correctAnswers}</div>
                <div class="stat-label">متبقي للمرحلة التالية</div>
              </div>
            </div>

            <div class="progress-bar">
              <div class="progress-fill" style="width: ${(this.correctAnswers / this.requiredCorrectForNext) * 100}%"></div>
            </div>

            <div class="name-parts-container">
              <div class="original-name">رتب الأجزاء لتكوين الاسم الصحيح</div>
              
              <div class="shuffled-parts" id="shuffledParts">
                ${this.shuffledParts.map((part, index) => 
                  `<div class="name-part" draggable="true" data-part="${part}" data-index="${index}">
                    ${part}
                  </div>`
                ).join('')}
              </div>

              <div class="ordered-parts" id="orderedParts"></div>
            </div>

            <div class="assemble-controls">
              <button onclick="nameAssembly.checkOrder()" class="btn btn-success">
                <i class="fas fa-check"></i>
                ✅ تحقق من الترتيب
              </button>
              <button onclick="nameAssembly.resetOrder()" class="btn btn-warning">
                <i class="fas fa-undo"></i>
                🔄 إعادة ترتيب
              </button>
              <button onclick="nameAssembly.skipRound()" class="btn btn-cosmic">
                <i class="fas fa-forward"></i>
                ⏭️ تخطي
              </button>
              <button onclick="game.resetGame()" class="btn btn-primary">
                <i class="fas fa-home"></i>
                🏠 العودة للقائمة
              </button>
            </div>
          </div>
        `;

        this.setupDragAndDrop();
        this.game.soundSystem.play('reveal');
        this.game.messages.show(`🎯 رتب أجزاء الاسم: ${filteredName}`, 'info', 5000);
      }

      getLevelDescription() {
        switch(this.currentLevel) {
          case 1: return '(الاسم الأول + الثاني)';
          case 2: return '(الاسم الأول + الثاني + الثالث)';
          case 3: return '(الاسم الكامل)';
          default: return '';
        }
      }

      setupDragAndDrop() {
        const shuffledContainer = document.getElementById('shuffledParts');
        const orderedContainer = document.getElementById('orderedParts');

        // إعداد الأجزاء القابلة للسحب
        const parts = shuffledContainer.querySelectorAll('.name-part');
        parts.forEach(part => {
          part.addEventListener('dragstart', (e) => {
            this.draggedElement = e.target;
            e.target.classList.add('dragging');
            this.game.soundSystem.play('click');
          });

          part.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            this.draggedElement = null;
          });

          // إضافة دعم اللمس للأجهزة المحمولة
          part.addEventListener('click', () => {
            this.handlePartClick(part);
          });
        });

        // إعداد منطقة الإسقاط
        [shuffledContainer, orderedContainer].forEach(container => {
          container.addEventListener('dragover', (e) => {
            e.preventDefault();
            container.classList.add('dragover');
          });

          container.addEventListener('dragleave', () => {
            container.classList.remove('dragover');
          });

          container.addEventListener('drop', (e) => {
            e.preventDefault();
            container.classList.remove('dragover');
            
            if (this.draggedElement && container === orderedContainer) {
              this.movePartToOrdered(this.draggedElement);
            } else if (this.draggedElement && container === shuffledContainer) {
              this.movePartToShuffled(this.draggedElement);
            }
          });
        });
      }

      handlePartClick(part) {
        this.game.soundSystem.play('click');
        
        if (part.parentElement.id === 'shuffledParts') {
          this.movePartToOrdered(part);
        } else {
          this.movePartToShuffled(part);
        }
      }

      movePartToOrdered(part) {
        const orderedContainer = document.getElementById('orderedParts');
        const partText = part.dataset.part;
        
        if (!this.orderedParts.includes(partText)) {
          this.orderedParts.push(partText);
          orderedContainer.appendChild(part.cloneNode(true));
          part.remove();
          
          // إعادة إعداد الأحداث للعنصر الجديد
          const newPart = orderedContainer.lastElementChild;
          newPart.addEventListener('click', () => {
            this.handlePartClick(newPart);
          });
          
          this.game.soundSystem.play('notification');
        }
      }

      movePartToShuffled(part) {
        const shuffledContainer = document.getElementById('shuffledParts');
        const partText = part.dataset.part;
        
        // إزالة من المرتب
        this.orderedParts = this.orderedParts.filter(p => p !== partText);
        shuffledContainer.appendChild(part.cloneNode(true));
        part.remove();
        
        // إعادة إعداد الأحداث للعنصر الجديد
        const newPart = shuffledContainer.lastElementChild;
        newPart.addEventListener('click', () => {
          this.handlePartClick(newPart);
        });
        
        this.game.soundSystem.play('click');
      }

      checkOrder() {
        if (this.orderedParts.length === 0) {
          this.game.messages.show('⚠️ يرجى ترتيب أجزاء الاسم أولاً', 'warning');
          return;
        }

        const userOrder = this.orderedParts.join(' ');
        const correctOrder = this.nameParts.join(' ');
        const isCorrect = userOrder === correctOrder;
        
        this.totalAttempts++;

        if (isCorrect) {
          this.correctAnswers++;
          this.game.soundSystem.play('correct');
          this.game.messages.show('🎉 ممتاز! الترتيب صحيح', 'success', 3000);
          
          // تأثير بصري للنجاح
          this.celebrateSuccess();
          
          if (this.correctAnswers >= this.requiredCorrectForNext) {
            setTimeout(() => {
              this.levelUp();
            }, 2000);
          } else {
            setTimeout(() => {
              this.setupNewRound();
            }, 2000);
          }
        } else {
          this.game.soundSystem.play('wrong');
          
          // إنشاء عرض الاسم المفلتر للرسالة
          const filteredName = this.currentName.split(/\s+/)
            .filter(part => part !== 'بن' && part !== 'بنت' && part.trim() !== '')
            .join(' ');
          
          this.game.messages.show(`❌ خطأ! الترتيب الصحيح: ${correctOrder}`, 'error', 5000);
          
          // إظهار الإجابة الصحيحة
          setTimeout(() => {
            this.showCorrectAnswer();
          }, 1000);
          
          setTimeout(() => {
            this.setupNewRound();
          }, 4000);
        }
      }

      celebrateSuccess() {
        // إضافة تأثير الاحتفال
        const parts = document.querySelectorAll('#orderedParts .name-part');
        parts.forEach((part, index) => {
          setTimeout(() => {
            part.style.animation = 'correctPulse 0.6s ease-in-out';
          }, index * 100);
        });

        // إطلاق الألعاب النارية إذا كانت متوفرة
        if (typeof confetti !== 'undefined') {
          confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
          });
        }
      }

      showCorrectAnswer() {
        const orderedContainer = document.getElementById('orderedParts');
        orderedContainer.innerHTML = this.nameParts.map(part => 
          `<div class="name-part" style="background: var(--gradient-success); color: white;">
            ${part}
          </div>`
        ).join('');
      }

      resetOrder() {
        this.orderedParts = [];
        const orderedContainer = document.getElementById('orderedParts');
        const shuffledContainer = document.getElementById('shuffledParts');
        
        // إعادة جميع الأجزاء للحاوية المخلوطة
        orderedContainer.innerHTML = '';
        shuffledContainer.innerHTML = this.shuffledParts.map((part, index) => 
          `<div class="name-part" draggable="true" data-part="${part}" data-index="${index}">
            ${part}
          </div>`
        ).join('');
        
        this.setupDragAndDrop();
        this.game.soundSystem.play('notification');
        this.game.messages.show('🔄 تم إعادة ترتيب الأجزاء', 'info', 2000);
      }

      skipRound() {
        this.game.soundSystem.play('click');
        this.game.messages.show('⏭️ تم تخطي الجولة', 'info', 2000);
        this.setupNewRound();
      }

      levelUp() {
        if (this.currentLevel < this.maxLevel) {
          this.currentLevel++;
          this.correctAnswers = 0;
          this.game.soundSystem.play('success');
          this.game.messages.show(`🎊 تهانينا! انتقلت للمرحلة ${this.currentLevel}`, 'success', 4000);
          
          setTimeout(() => {
            this.setupNewRound();
          }, 2000);
        } else {
          this.completeGame();
        }
      }

      completeGame() {
        this.game.soundSystem.play('success');
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="result-display">
            🏆 تهانينا! أكملت جميع المراحل!
            <br><br>
            إجمالي الإجابات الصحيحة: ${this.correctAnswers + (this.requiredCorrectForNext * (this.maxLevel - 1))}
            <br>
            إجمالي المحاولات: ${this.totalAttempts}
            <br>
            معدل النجاح: ${Math.round(((this.correctAnswers + (this.requiredCorrectForNext * (this.maxLevel - 1))) / this.totalAttempts) * 100)}%
          </div>
          
          <div class="game-buttons">
            <button onclick="nameAssembly.start()" class="btn btn-primary">
              🔄 لعب مرة أخرى
            </button>
            <button onclick="game.resetGame()" class="btn btn-cosmic">
              🏠 العودة للقائمة
            </button>
          </div>
        `;

        // إطلاق احتفال كبير
        if (typeof confetti !== 'undefined') {
          confetti({
            particleCount: 200,
            spread: 100,
            origin: { y: 0.4 }
          });
        }
      }
    }

    // الفئة الرئيسية للعبة
    class WhoIsItGame {
      constructor() {
        this.state = new GameState();
        this.messages = new MessageSystem();
        this.soundSystem = new SoundSystem();
        this.nameAssembly = new NameAssemblyGame(this);
        this.init();
      }

      async init() {
        try {
          this.showLoading(true);
          await this.loadStudentData();
          this.loadSettings(); // تحميل الإعدادات المحفوظة
          this.setupEventListeners();
          this.showLoading(false);
          this.messages.show('✅ تم تحميل النظام بنجاح', 'success');
          this.soundSystem.play('notification');
        } catch (error) {
          this.showLoading(false);
          console.error('خطأ في تحميل البيانات:', error);
          this.messages.show('❌ لا يمكن تشغيل النشاط بدون ملف البيانات!', 'error');
          this.soundSystem.play('error');
        }
      }

      showLoading(show) {
        const loadingArea = document.getElementById('loadingArea');
        this.state.isLoading = show;
        
        if (show) {
          loadingArea.classList.add('active');
        } else {
          loadingArea.classList.remove('active');
        }
      }

      async loadStudentData() {
        try {
          this.messages.show('جاري تحميل بيانات الطلاب...', 'info', 10000);
          
          const res = await fetch('../data/studentData.json');
          if (!res.ok) {
            throw new Error('فشل في تحميل ملف البيانات');
          }
          this.state.studentData = await res.json();
          
          this.populateClassSelect();
          this.messages.clear();
          this.messages.show('تم تحميل بيانات الطلاب بنجاح! 🎓', 'success');
          
        } catch (error) {
          this.messages.show('خطأ في تحميل بيانات الطلاب: ' + error.message, 'error');
          this.soundSystem.play('wrong');
          
          // إضافة بيانات تجريبية في حالة فشل التحميل
          this.state.studentData = {
            "الأول": ["أحمد محمد سالم", "فاطمة علي خالد", "سالم خالد أحمد", "مريم سعيد محمد", "يوسف حمد علي"],
            "الثاني": ["نورا أحمد سالم", "محمد سالم يوسف", "آمنة يوسف حمد", "خالد محمد أحمد", "هناء علي سعيد"],
            "الثالث": ["عبدالله سعيد محمد", "زينب محمد علي", "طارق أحمد خالد", "رقية سالم يوسف", "حمد علي أحمد"],
            "الرابع": ["سعاد خالد محمد", "عمر محمد سالم", "ليلى أحمد علي", "ناصر سعيد حمد", "عائشة حمد يوسف"],
            "الخامس": ["إبراهيم علي سالم", "خديجة محمد أحمد", "سليمان خالد علي", "وردة سعيد محمد", "راشد حمد خالد"],
            "السادس": ["منى يوسف سالم", "عيسى محمد علي", "جميلة أحمد خالد", "بدر سعيد محمد", "نجاة علي حمد"]
          };
          
          this.populateClassSelect();
          this.messages.show('تم تحميل بيانات تجريبية بدلاً من الملف الأصلي', 'warning');
        }
      }

      populateClassSelect() {
        const classSelect = document.getElementById('classSelect');
        const startBtn = document.getElementById('startGameBtn');
        
        classSelect.innerHTML = '<option value="">اختر الصف</option>';

        const classes = Object.keys(this.state.studentData);

        classes.forEach(className => {
          const studentCount = this.state.studentData[className].length;
          const option = document.createElement('option');
          option.value = className;
          option.textContent = `${className} (${studentCount} طالب)`;
          classSelect.appendChild(option);
        });

        classSelect.addEventListener('change', () => {
          startBtn.disabled = !classSelect.value;
          
          if (classSelect.value) {
            const studentCount = this.state.studentData[classSelect.value].length;
            this.messages.show(`📚 تم اختيار "${classSelect.value}" - يحتوي على ${studentCount} طالب`, 'info', 3000);
          }
        });
      }

      setupEventListeners() {
        const startBtn = document.getElementById('startGameBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const classSelect = document.getElementById('classSelect');
        const modeSelect = document.getElementById('modeSelect');
        const timeSelect = document.getElementById('timeSelect');
        const livesSelect = document.getElementById('livesSelect');

        startBtn.addEventListener('click', () => this.startGame());
        settingsBtn.addEventListener('click', () => this.showSettings());

        timeSelect.addEventListener('change', () => {
          this.state.timeLimit = parseInt(timeSelect.value);
        });

        livesSelect.addEventListener('change', () => {
          this.state.maxLives = parseInt(livesSelect.value);
        });

        classSelect.addEventListener('change', () => {
          startBtn.disabled = !classSelect.value;
          
          if (classSelect.value) {
            const studentCount = this.state.studentData[classSelect.value].length;
            this.messages.show(`📚 تم اختيار "${classSelect.value}" - يحتوي على ${studentCount} طالب`, 'info', 3000);
          }
        });
      }

      startGame() {
        const classValue = document.getElementById('classSelect').value;
        const modeValue = document.getElementById('modeSelect').value;

        if (!classValue || !modeValue) {
          this.messages.show('⚠️ يرجى اختيار الصف ونمط اللعبة', 'warning');
          return;
        }

        this.state.currentClass = classValue;
        this.state.gameMode = modeValue;
        this.state.allStudents = this.state.studentData[classValue] || [];
        this.state.usedStudents = []; // إعادة تعيين قائمة الطلاب المستخدمين

        this.soundSystem.play('click');
        this.messages.show('🎯 بدء اللعبة...', 'info', 2000);
        
        setTimeout(() => {
          if (modeValue === 'assemble') {
            this.nameAssembly.start();
          } else if (modeValue === 'manual') {
            this.showStudentSelection();
          } else if (modeValue === 'random') {
            this.startRandomMode();
          } else if (modeValue === 'survival') {
            this.startSurvivalMode();
          } else {
            this.newRound();
          }
        }, 1000);
      }

      showSettings() {
        this.soundSystem.play('click');
        
        const gameArea = document.getElementById('gameArea');
        gameArea.innerHTML = `
          <div class="settings-interface">
            <div class="settings-header">
              <div class="settings-title">⚙️ إعدادات النظام</div>
              <div class="settings-subtitle">تخصيص تجربة اللعبة</div>
            </div>

            <div class="settings-content">
              <div class="settings-section">
                <h3 class="section-title">🎵 الإعدادات الصوتية</h3>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="soundEnabled" ${this.soundSystem.soundEnabled ? 'checked' : ''}>
                    <span class="setting-text">تشغيل الأصوات</span>
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label">مستوى الصوت:</label>
                  <input type="range" id="volumeSlider" min="0" max="100" value="${this.soundSystem.volume * 100}" class="volume-slider">
                  <span class="volume-display">${Math.round(this.soundSystem.volume * 100)}%</span>
                </div>
              </div>

              <div class="settings-section">
                <h3 class="section-title">🎮 إعدادات اللعبة</h3>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="animationsEnabled" checked>
                    <span class="setting-text">تشغيل الحركات والتأثيرات</span>
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="confettiEnabled" checked>
                    <span class="setting-text">عرض الألعاب النارية</span>
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="autoHideTarget" checked>
                    <span class="setting-text">إخفاء الطالب المستهدف تلقائياً</span>
                  </label>
                </div>
              </div>

              <div class="settings-section">
                <h3 class="section-title">📊 إعدادات البيانات</h3>
                <div class="setting-item">
                  <button onclick="game.exportData()" class="btn btn-primary">
                    📤 تصدير البيانات
                  </button>
                  <button onclick="game.resetStats()" class="btn btn-secondary">
                    🔄 إعادة تعيين الإحصائيات
                  </button>
                </div>
              </div>
            </div>

            <div class="settings-controls">
              <button onclick="game.saveSettings()" class="btn btn-success">
                💾 حفظ الإعدادات
              </button>
              <button onclick="game.resetGame()" class="btn btn-cosmic">
                🏠 العودة للقائمة الرئيسية
              </button>
            </div>
          </div>
        `;

        // ربط الأحداث
        this.setupSettingsEvents();
        this.messages.show('⚙️ إعدادات النظام جاهزة للتخصيص', 'info', 3000);
      }

      setupSettingsEvents() {
        const soundEnabled = document.getElementById('soundEnabled');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeDisplay = document.querySelector('.volume-display');

        // تغيير حالة الصوت
        soundEnabled.addEventListener('change', () => {
          this.soundSystem.soundEnabled = soundEnabled.checked;
          this.soundSystem.play('click');
        });

        // تغيير مستوى الصوت
        volumeSlider.addEventListener('input', () => {
          const volume = volumeSlider.value / 100;
          this.soundSystem.volume = volume;
          volumeDisplay.textContent = `${volumeSlider.value}%`;
        });

        volumeSlider.addEventListener('change', () => {
          this.soundSystem.play('notification');
        });
      }

      saveSettings() {
        const settings = {
          soundEnabled: document.getElementById('soundEnabled').checked,
          volume: document.getElementById('volumeSlider').value / 100,
          animationsEnabled: document.getElementById('animationsEnabled').checked,
          confettiEnabled: document.getElementById('confettiEnabled').checked,
          autoHideTarget: document.getElementById('autoHideTarget').checked
        };

        // حفظ في Local Storage
        localStorage.setItem('whoisGameSettings', JSON.stringify(settings));
        
        this.soundSystem.play('success');
        this.messages.show('✅ تم حفظ الإعدادات بنجاح!', 'success', 3000);
      }

      exportData() {
        const data = {
          settings: JSON.parse(localStorage.getItem('whoisGameSettings') || '{}'),
          stats: this.state.stats,
          timestamp: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `whois-game-data-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        this.soundSystem.play('notification');
        this.messages.show('📤 تم تصدير البيانات بنجاح!', 'success', 3000);
      }

      resetStats() {
        if (confirm('هل أنت متأكد من إعادة تعيين جميع الإحصائيات؟')) {
          this.state.stats = {
            score: 0,
            correctAnswers: 0,
            wrongAnswers: 0,
            streak: 0,
            lives: 3,
            gamesPlayed: 0
          };
          
          this.soundSystem.play('notification');
          this.messages.show('🔄 تم إعادة تعيين الإحصائيات!', 'info', 3000);
        }
      }

      loadSettings() {
        const savedSettings = localStorage.getItem('whoisGameSettings');
        if (savedSettings) {
          try {
            const settings = JSON.parse(savedSettings);
            
            // تطبيق الإعدادات الصوتية
            if (settings.soundEnabled !== undefined) {
              this.soundSystem.soundEnabled = settings.soundEnabled;
            }
            if (settings.volume !== undefined) {
              this.soundSystem.volume = settings.volume;
            }
            
            // يمكن إضافة المزيد من الإعدادات هنا
            
          } catch (error) {
            console.warn('خطأ في تحميل الإعدادات:', error);
          }
        }
      }

      newRound() {
        if (this.state.allStudents.length === 0) {
          this.messages.show('⚠️ لا توجد بيانات طلاب متاحة', 'warning');
          return;
        }

        const targetStudent = this.state.allStudents[Math.floor(Math.random() * this.state.allStudents.length)];
        this.state.targetStudent = targetStudent;

        this.displayGameInterface();
      }

      showStudentSelection() {
        if (this.state.allStudents.length === 0) {
          this.messages.show('⚠️ لا توجد بيانات طلاب متاحة', 'warning');
          return;
        }

        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="student-selection-interface">
            <div class="selection-title">🎯 الوضع الانتقائي - اختر الطالب</div>
            <div class="selection-subtitle">اختر الطالب الذي تريد أن يخمنه باقي الطلاب</div>
            
            <div class="selection-methods">
              <div class="method-tabs">
                <button onclick="game.showSelectionMode('cards')" class="method-tab active" id="cardsTab">
                  🃏 بطاقات الطلاب
                </button>
                <button onclick="game.showSelectionMode('list')" class="method-tab" id="listTab">
                  📋 قائمة الطلاب
                </button>
              </div>
              
              <div class="selection-content" id="selectionContent">
                ${this.generateStudentCards()}
              </div>
            </div>

            <div class="selection-controls">
              <button onclick="game.resetGame()" class="btn btn-cosmic">
                <i class="fas fa-arrow-left"></i>
                🔙 العودة للإعدادات
              </button>
            </div>
          </div>
        `;

        this.soundSystem.play('reveal');
        this.messages.show('🎯 اختر الطالب المطلوب من القائمة أو البطاقات', 'info', 5000);
      }

      showSelectionMode(mode) {
        const cardsTab = document.getElementById('cardsTab');
        const listTab = document.getElementById('listTab');
        const content = document.getElementById('selectionContent');

        // تحديث التبويبات
        cardsTab.classList.toggle('active', mode === 'cards');
        listTab.classList.toggle('active', mode === 'list');

        if (mode === 'cards') {
          content.innerHTML = this.generateStudentCards();
        } else {
          content.innerHTML = this.generateStudentList();
        }

        this.soundSystem.play('click');
      }

      generateStudentCards() {
        return `
          <div class="student-selection-grid">
            ${this.state.allStudents.map(student => `
              <div class="student-selection-card" onclick="game.selectTargetStudent('${student}')">
                <div class="student-avatar">
                  <i class="fas fa-user-graduate"></i>
                </div>
                <div class="student-selection-name">${student}</div>
                <div class="selection-badge">اختر</div>
              </div>
            `).join('')}
          </div>
        `;
      }

      generateStudentList() {
        return `
          <div class="student-selection-list">
            <div class="list-header">
              <span class="student-count">عدد الطلاب: ${this.state.allStudents.length}</span>
            </div>
            ${this.state.allStudents.map((student, index) => `
              <div class="student-list-item" onclick="game.selectTargetStudent('${student}')">
                <div class="student-number">${index + 1}</div>
                <div class="student-list-name">${student}</div>
                <div class="select-button">
                  <i class="fas fa-check-circle"></i>
                  اختر
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      selectTargetStudent(studentName) {
        this.state.targetStudent = studentName;
        this.soundSystem.play('success');
        this.messages.show(`✅ تم اختيار الطالب: ${studentName}`, 'success', 3000);
        
        // تهيئة إعدادات الوضع الانتقائي
        this.state.stats.lives = this.state.maxLives;
        this.state.stats.correctAnswers = 0;
        this.state.stats.wrongAnswers = 0;
        this.state.stats.gamesPlayed = 0;
        
        // انتظار قصير ثم بدء اللعبة
        setTimeout(() => {
          this.displayManualGameInterface();
        }, 1500);
      }

      // الوضع العشوائي الجديد - يستخدم نفس منطق الوضع الانتقائي مع اختيار عشوائي
      startRandomMode() {
        if (this.state.allStudents.length === 0) {
          this.messages.show('⚠️ لا توجد بيانات طلاب متاحة', 'warning');
          return;
        }

        // إعادة تعيين قائمة الطلاب المستخدمين إذا انتهت جميع الطلاب
        if (this.state.usedStudents.length >= this.state.allStudents.length) {
          this.state.usedStudents = [];
          this.soundSystem.play('notification');
          this.messages.show('🎉 تهانينا! تم الانتهاء من جميع طلاب الصف! بدء دورة جديدة...', 'success', 5000);
          
          // إضافة احتفال قصير
          if (typeof confetti !== 'undefined') {
            confetti({
              particleCount: 100,
              spread: 70,
              origin: { y: 0.6 }
            });
          }
        }

        // اختيار طالب عشوائي من الطلاب غير المستخدمين
        const availableStudents = this.state.allStudents.filter(
          student => !this.state.usedStudents.includes(student)
        );

        if (availableStudents.length === 0) {
          // هذا لا يجب أن يحدث، لكن كحماية إضافية
          this.state.usedStudents = [];
          return this.startRandomMode();
        }

        // اختيار عشوائي
        const randomIndex = Math.floor(Math.random() * availableStudents.length);
        const selectedStudent = availableStudents[randomIndex];
        
        // إضافة الطالب للمستخدمين
        this.state.usedStudents.push(selectedStudent);
        this.state.targetStudent = selectedStudent;

        this.soundSystem.play('reveal');
        this.messages.show(`🎲 تم اختيار طالب عشوائي! الجولة ${this.state.usedStudents.length} من ${this.state.allStudents.length}`, 'info', 3000);
        
        // تهيئة إعدادات الوضع العشوائي (نفس منطق الوضع الانتقائي)
        this.state.stats.lives = this.state.maxLives;
        this.state.stats.correctAnswers = 0;
        this.state.stats.wrongAnswers = 0;
        this.state.stats.gamesPlayed = 0;
        
        // انتظار قصير ثم بدء اللعبة
        setTimeout(() => {
          this.displayManualGameInterface();
        }, 1500);
      }

      // وضع البقاء - التحدي المستمر
      startSurvivalMode() {
        if (this.state.allStudents.length === 0) {
          this.messages.show('⚠️ لا توجد بيانات طلاب متاحة', 'warning');
          return;
        }

        // تهيئة إعدادات وضع البقاء
        this.state.survival.level = 1;
        this.state.survival.timeLeft = 30;
        this.state.survival.difficultyMultiplier = 1;
        this.state.survival.startTime = Date.now();
        this.state.survival.bonusLives = 0;
        this.state.survival.isActive = true;

        // إعدادات البقاء الأولية
        this.state.stats.lives = this.state.maxLives; // استخدام إعدادات المحاولات المختارة
        this.state.stats.score = 0;
        this.state.stats.correctAnswers = 0;
        this.state.stats.wrongAnswers = 0;
        this.state.stats.gamesPlayed = 0;
        this.state.stats.streak = 0;

        this.soundSystem.play('reveal');
        this.messages.show('🔥 وضع البقاء! المعلم سيختار الطالب المستهدف', 'info', 3000);
        
        // بدء عملية اختيار المعلم للطالب المستهدف
        this.showTeacherSelection();
      }

      showTeacherSelection() {
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="teacher-selection-interface">
            <div class="selection-header">
              <div class="selection-title">👨‍🏫 اختيار المعلم</div>
              <div class="selection-subtitle">اختر الطالب المستهدف سراً</div>
              <div class="selection-hint">الطلاب لن يروا اختيارك</div>
            </div>

            <div class="secret-selection-area">
              <div class="selection-instruction">
                <div class="instruction-text">انقر على الطالب الذي تريد أن يبحث عنه الطلاب:</div>
                <div class="privacy-notice">🔒 اختيارك محمي ومخفي عن الطلاب</div>
              </div>

              <div class="students-grid-selection" id="teacherSelectionGrid">
                ${this.generateTeacherSelectionGrid()}
              </div>
            </div>

            <div class="selection-controls">
              <button onclick="game.randomTeacherSelection()" class="btn btn-cosmic">
                🎲 اختيار عشوائي
              </button>
              <button onclick="game.resetGame()" class="btn btn-secondary">
                🏠 إلغاء والعودة
              </button>
            </div>
          </div>
        `;
      }

      generateTeacherSelectionGrid() {
        return this.state.allStudents.map(student => `
          <div class="teacher-selection-card" onclick="game.selectTargetForSurvival('${student}')">
            <div class="student-avatar">👤</div>
            <div class="student-name">${student}</div>
            <div class="selection-indicator">انقر للاختيار</div>
          </div>
        `).join('');
      }

      selectTargetForSurvival(studentName) {
        this.state.targetStudent = studentName;
        this.soundSystem.play('select');
        
        // إظهار تأكيد الاختيار
        const confirmationOverlay = document.createElement('div');
        confirmationOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          backdrop-filter: blur(10px);
        `;
        
        confirmationOverlay.innerHTML = `
          <div style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            color: white;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            margin: 20px;
          ">
            <div style="font-size: 3em; margin-bottom: 20px;">✅</div>
            <div style="font-size: 1.8em; margin-bottom: 15px; font-weight: bold;">
              تم اختيار الطالب المستهدف
            </div>
            <div style="font-size: 1.3em; margin-bottom: 20px; color: #FFD700;">
              ${studentName}
            </div>
            <div style="font-size: 1em; margin-bottom: 30px; opacity: 0.9;">
              سيبحث الطلاب عن هذا الطالب بين جميع طلاب الصف
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
              <button onclick="this.parentElement.parentElement.parentElement.remove(); game.startSurvivalGameplay();" class="btn btn-success" style="min-width: 150px;">
                🚀 بدء اللعبة
              </button>
              <button onclick="this.parentElement.parentElement.parentElement.remove(); game.showTeacherSelection();" class="btn btn-secondary" style="min-width: 150px;">
                🔄 تغيير الاختيار
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(confirmationOverlay);
      }

      randomTeacherSelection() {
        const randomStudent = this.state.allStudents[Math.floor(Math.random() * this.state.allStudents.length)];
        this.selectTargetForSurvival(randomStudent);
      }

      startSurvivalGameplay() {
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="survival-game-interface">
            <div class="game-header">
              <div class="game-title">🔥 وضع البقاء - ابحث عن الطالب المطلوب</div>
              <div class="game-instruction">اعثر على الطالب الصحيح من بين جميع طلاب الصف</div>
            </div>

            <div class="survival-stats-bar">
              <div class="stat-item lives">
                <span class="stat-icon">❤️</span>
                <span class="stat-value" id="livesCount">${this.state.stats.lives}</span>
                <span class="stat-label">المحاولات</span>
              </div>
              <div class="stat-item score">
                <span class="stat-icon">🏆</span>
                <span class="stat-value" id="scoreCount">${this.state.stats.score}</span>
                <span class="stat-label">النقاط</span>
              </div>
              <div class="stat-item level">
                <span class="stat-icon">⭐</span>
                <span class="stat-value" id="levelCount">${this.state.survival.level}</span>
                <span class="stat-label">المستوى</span>
              </div>
            </div>

            <div class="students-battlefield" id="studentsBattlefield">
              ${this.generateSurvivalBattlefield()}
            </div>

            <div class="game-controls">
              <button onclick="game.pauseSurvivalGame()" class="btn btn-secondary">
                ⏸️ إيقاف مؤقت
              </button>
              <button onclick="game.resetGame()" class="btn btn-danger">
                🏠 إنهاء اللعبة
              </button>
            </div>
          </div>
        `;

        // بدء انيميشن سقوط البطاقات
        this.animateCardsEntry();
        this.soundSystem.play('start-timer');
      }

      generateSurvivalBattlefield() {
        return this.state.allStudents.map((student, index) => `
          <div class="battle-card" 
               data-student="${student}" 
               data-index="${index}"
               onclick="game.selectSurvivalCard('${student}', this)"
               style="animation-delay: ${index * 0.1}s">
            <div class="card-inner">
              <div class="card-front">
                <div class="student-avatar">👤</div>
                <div class="student-name">${student}</div>
                <div class="card-glow"></div>
              </div>
              <div class="card-back">
                <div class="explosion-effect"></div>
              </div>
            </div>
          </div>
        `).join('');
      }

      animateCardsEntry() {
        const cards = document.querySelectorAll('.battle-card');
        cards.forEach((card, index) => {
          setTimeout(() => {
            card.classList.add('card-drop-in');
          }, index * 100);
        });
      }

      selectSurvivalCard(selectedStudent, cardElement) {
        // منع النقر المتعدد
        if (cardElement.classList.contains('disabled')) return;
        
        const isCorrect = selectedStudent === this.state.targetStudent;
        
        if (isCorrect) {
          this.handleCorrectSelection(cardElement, selectedStudent);
        } else {
          this.handleWrongSelection(cardElement, selectedStudent);
        }
      }

      handleCorrectSelection(cardElement, selectedStudent) {
        // فحص إعدادات الوقت - إذا كان لا محدود، لا تنهي اللعبة
        const isUnlimitedTime = this.state.timeLimit === 0; // 0 يعني لا محدود
        
        // تأثير النجاح على البطاقة
        cardElement.classList.add('correct-selection');
        
        // تحديث النقاط
        const points = 100 + (this.state.stats.streak * 10);
        this.state.stats.score += points;
        this.state.stats.correctAnswers++;
        this.state.stats.streak++;
        
        // أصوات النجاح
        this.soundSystem.play('success');
        
        if (isUnlimitedTime) {
          // في الوقت اللامحدود، أظهر رسالة نجاح واختر طالب جديد
          this.messages.show(`✅ ممتاز! تم العثور على ${selectedStudent}. جاري اختيار طالب جديد...`, 'success', 3000);
          
          // تحديث الإحصائيات
          this.updateSurvivalStats();
          
          // اختيار طالب جديد وإعادة بدء الجولة
          setTimeout(() => {
            this.selectNewTargetStudent();
            this.startSurvivalGameplay();
          }, 2000);
        } else {
          // في الوقت المحدود، إنهاء اللعبة بالاحتفال
          // تعطيل جميع البطاقات
          const allCards = document.querySelectorAll('.battle-card');
          allCards.forEach(card => card.classList.add('disabled'));
          
          // إظهار الاحتفال
          setTimeout(() => {
            this.showVictoryCelebration(selectedStudent);
          }, 1000);
        }
      }

      selectNewTargetStudent() {
        // اختيار طالب جديد عشوائياً
        const availableStudents = this.state.allStudents.filter(student => student !== this.state.targetStudent);
        if (availableStudents.length > 0) {
          this.state.targetStudent = availableStudents[Math.floor(Math.random() * availableStudents.length)];
        } else {
          // إذا لم يتبق طلاب، اختر عشوائياً من الجميع
          this.state.targetStudent = this.state.allStudents[Math.floor(Math.random() * this.state.allStudents.length)];
        }
      }

      updateSurvivalStats() {
        // تحديث عرض الإحصائيات
        const scoreElement = document.getElementById('scoreCount');
        const levelElement = document.getElementById('levelCount');
        
        if (scoreElement) scoreElement.textContent = this.state.stats.score;
        
        // زيادة المستوى كل 5 إجابات صحيحة
        if (this.state.stats.correctAnswers % 5 === 0) {
          this.state.survival.level++;
          if (levelElement) levelElement.textContent = this.state.survival.level;
          this.messages.show(`🎊 تهانينا! وصلت للمستوى ${this.state.survival.level}`, 'success', 3000);
        }
      }

      handleWrongSelection(cardElement, selectedStudent) {
        // تقليل المحاولات فقط إذا لم تكن لا محدودة
        if (this.state.maxLives !== -1) {
          this.state.stats.lives--;
        }
        this.state.stats.streak = 0;
        
        // تأثير الانفجار
        cardElement.classList.add('exploding-card');
        this.soundSystem.play('wrong_answer');
        
        // تحديث العداد
        const livesElement = document.getElementById('livesCount');
        if (livesElement) {
          livesElement.textContent = this.state.maxLives === -1 ? '∞' : this.state.stats.lives;
        }
        
        // إزالة البطاقة بعد الانفجار
        setTimeout(() => {
          cardElement.style.opacity = '0';
          cardElement.style.transform = 'scale(0) rotate(360deg)';
        }, 500);
        
        // فحص انتهاء اللعبة فقط إذا لم تكن المحاولات لا محدودة
        if (this.state.maxLives !== -1 && this.state.stats.lives <= 0) {
          setTimeout(() => {
            this.showGameOver();
          }, 1000);
        } else {
          if (this.state.maxLives === -1) {
            this.messages.show(`❌ خطأ! محاولات لا محدودة متاحة`, 'error', 2000);
          } else {
            this.messages.show(`❌ خطأ! ${this.state.stats.lives} محاولات متبقية`, 'error', 2000);
          }
        }
      }

      showVictoryCelebration(winnerName) {
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="victory-celebration">
            <div class="celebration-fireworks">
              <div class="firework"></div>
              <div class="firework"></div>
              <div class="firework"></div>
            </div>
            
            <div class="victory-content">
              <div class="victory-icon">🎉</div>
              <div class="victory-title">تهانينا! تم العثور على الطالب!</div>
              <div class="winner-name">${winnerName}</div>
              <div class="victory-message">لقد نجحت في إيجاد الطالب المطلوب!</div>
              
              <div class="final-stats">
                <div class="stat-card">
                  <div class="stat-icon">🏆</div>
                  <div class="stat-value">${this.state.stats.score}</div>
                  <div class="stat-label">النقاط النهائية</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon">🔥</div>
                  <div class="stat-value">${this.state.stats.streak}</div>
                  <div class="stat-label">السلسلة</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon">⭐</div>
                  <div class="stat-value">${this.state.survival.level}</div>
                  <div class="stat-label">المستوى</div>
                </div>
              </div>
              
              <div class="celebration-controls">
                <button onclick="game.startSurvivalMode()" class="btn btn-success">
                  🎮 لعب مرة أخرى
                </button>
                <button onclick="game.resetGame()" class="btn btn-cosmic">
                  🏠 العودة للقائمة
                </button>
              </div>
            </div>
          </div>
        `;

        // تشغيل الألعاب النارية والأصوات
        this.soundSystem.play('win');
        
        // إطلاق confetti إذا كان متاحاً
        if (typeof confetti !== 'undefined') {
          // انفجار كبير
          confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
          });
          
          // انفجارات متتالية
          setTimeout(() => confetti({
            particleCount: 50,
            angle: 60,
            spread: 55,
            origin: { x: 0 }
          }), 250);
          
          setTimeout(() => confetti({
            particleCount: 50,
            angle: 120,
            spread: 55,
            origin: { x: 1 }
          }), 400);
        }
        
        this.messages.show(`🎉 مبروك! تم العثور على ${winnerName}!`, 'success', 4000);
      }

      showGameOver() {
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="game-over-screen">
            <div class="game-over-content">
              <div class="game-over-icon">💥</div>
              <div class="game-over-title">انتهت اللعبة!</div>
              <div class="game-over-message">لم تتمكن من العثور على الطالب المطلوب</div>
              <div class="reveal-answer">
                <div class="reveal-text">الطالب المطلوب كان:</div>
                <div class="correct-answer">${this.state.targetStudent}</div>
              </div>
              
              <div class="final-stats">
                <div class="stat-card">
                  <div class="stat-icon">🏆</div>
                  <div class="stat-value">${this.state.stats.score}</div>
                  <div class="stat-label">النقاط</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon">✅</div>
                  <div class="stat-value">${this.state.stats.correctAnswers}</div>
                  <div class="stat-label">إجابات صحيحة</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon">❌</div>
                  <div class="stat-value">${this.state.stats.wrongAnswers}</div>
                  <div class="stat-label">إجابات خاطئة</div>
                </div>
              </div>
              
              <div class="game-over-controls">
                <button onclick="game.startSurvivalMode()" class="btn btn-primary">
                  🔄 حاول مرة أخرى
                </button>
                <button onclick="game.resetGame()" class="btn btn-cosmic">
                  🏠 العودة للقائمة
                </button>
              </div>
            </div>
          </div>
        `;

        this.soundSystem.play('draw');
        this.messages.show(`💥 انتهت اللعبة! الطالب المطلوب كان: ${this.state.targetStudent}`, 'error', 5000);
      }

      pauseSurvivalGame() {
        // منطق إيقاف اللعبة مؤقتاً
        this.messages.show('⏸️ تم إيقاف اللعبة مؤقتاً', 'info', 2000);
      }

      showSurvivalInstructions() {
        // دالة مخفية - تعليمات وضع البقاء غير مفعلة
        this.messages.show('ℹ️ التعليمات غير متاحة في هذا الوضع', 'info', 2000);
        return;
      }

      startSurvivalGame() {
        setTimeout(() => {
          this.displaySurvivalInterface();
          this.startSurvivalRound();
        }, 500);
      }

      displaySurvivalInterface() {
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="survival-interface">
            <div class="survival-header">
              <div class="survival-title">🔥 وضع البقاء</div>
              <div class="survival-level">المستوى ${this.state.survival.level}</div>
              <div class="survival-explanation">أجب بسرعة ودقة للحصول على مكافآت!</div>
            </div>

            <div class="survival-stats">
              <div class="survival-stat-card lives">
                <div class="stat-icon">❤️</div>
                <div class="stat-value">${this.state.stats.lives}</div>
                <div class="stat-label">المحاولات المتبقية</div>
                <div class="stat-help">تفقد محاولة مع كل خطأ</div>
              </div>
              <div class="survival-stat-card score">
                <div class="stat-icon">🏆</div>
                <div class="stat-value">${this.state.stats.score}</div>
                <div class="stat-label">النقاط الحالية</div>
                <div class="stat-help">تزيد مع كل إجابة صحيحة</div>
              </div>
              <div class="survival-stat-card streak">
                <div class="stat-icon">🔥</div>
                <div class="stat-value">${this.state.stats.streak}</div>
                <div class="stat-label">الإجابات المتتالية</div>
                <div class="stat-help">3 متتالية = محاولة إضافية!</div>
              </div>
              <div class="survival-stat-card timer">
                <div class="stat-icon">⏱️</div>
                <div class="stat-value" id="survivalTimer">${this.state.survival.timeLeft}</div>
                <div class="stat-label">الوقت المتبقي</div>
                <div class="stat-help">أجب قبل انتهاء الوقت</div>
              </div>
              <div class="survival-stat-card best">
                <div class="stat-icon">👑</div>
                <div class="stat-value">${this.state.survival.bestScore}</div>
                <div class="stat-label">أفضل نتيجة</div>
                <div class="stat-help">رقمك القياسي</div>
              </div>
            </div>

            <div class="survival-progress">
              <div class="progress-info">
                <span>التقدم نحو المستوى التالي:</span>
                <span>${this.state.stats.correctAnswers % 5}/5 إجابات صحيحة</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${(this.state.stats.correctAnswers % 5) * 20}%"></div>
              </div>
            </div>
            
            <div class="survival-target">
              <div class="target-question">🎯 ابحث عن الطالب:</div>
              <div class="target-student-name" id="targetStudentName">
                ${this.state.targetStudent || 'جاري الاختيار...'}
              </div>
              <div class="survival-hint">
                المستوى ${this.state.survival.level} • 
                مضاعف النقاط: x${this.state.survival.difficultyMultiplier.toFixed(1)} • 
                نقاط الإجابة التالية: ~${Math.round(100 * this.state.survival.difficultyMultiplier + (this.state.stats.streak * 10))}
              </div>
            </div>
            
            <div class="students-grid" id="survivalOptions">
              ${this.generateSurvivalOptions()}
            </div>

            <div class="survival-tips">
              <div class="tip">💡 <strong>نصيحة:</strong> ابحث عن اسم "${this.state.targetStudent || 'الطالب المطلوب'}" بين الخيارات أدناه!</div>
              <div class="tip">⚡ <strong>مكافأة السرعة:</strong> كلما أجبت أسرع، حصلت على نقاط أكثر!</div>
              <div class="tip">🔥 <strong>التسلسل:</strong> كل 3 إجابات صحيحة متتالية تعطيك محاولة إضافية!</div>
            </div>

            <div class="survival-controls">
              <button onclick="game.pauseSurvivalGame()" class="btn btn-secondary">
                ⏸️ إيقاف مؤقت
              </button>
              <button onclick="game.resetGame()" class="btn btn-cosmic">
                🏠 إنهاء وضع البقاء
              </button>
            </div>
          </div>
        `;

        this.updateSurvivalStats();
        this.startSurvivalTimer();
      }

      generateSurvivalOptions() {
        // زيادة عدد الخيارات حسب المستوى (المزيد من الصعوبة)
        const baseOptions = 4;
        const extraOptions = Math.floor(this.state.survival.level / 3);
        const totalOptions = Math.min(baseOptions + extraOptions, this.state.allStudents.length, 8);
        
        const shuffled = [...this.state.allStudents].sort(() => Math.random() - 0.5);
        const options = shuffled.slice(0, totalOptions);
        
        if (!options.includes(this.state.targetStudent)) {
          options[0] = this.state.targetStudent;
          options.sort(() => Math.random() - 0.5);
        }

        return options.map(student => `
          <div class="student-card survival-card" onclick="game.checkSurvivalAnswer('${student}')">
            <div class="student-name">${student}</div>
          </div>
        `).join('');
      }

      getSurvivalTimeLimit() {
        // الوقت يقل مع زيادة المستوى
        const baseTime = 15; // 15 ثانية أساسية
        const timeReduction = Math.floor(this.state.survival.level / 3); // تقليل ثانية كل 3 مستويات
        const minTime = 8; // الحد الأدنى للوقت
        
        return Math.max(minTime, baseTime - timeReduction);
      }

      startSurvivalRound() {
        // اختيار طالب عشوائي
        const randomStudent = this.state.allStudents[Math.floor(Math.random() * this.state.allStudents.length)];
        this.state.targetStudent = randomStudent;
        
        // تحديث اسم الطالب المستهدف في الواجهة
        const targetNameElement = document.getElementById('targetStudentName');
        if (targetNameElement) {
          targetNameElement.textContent = randomStudent;
          targetNameElement.style.animation = 'none';
          setTimeout(() => {
            targetNameElement.style.animation = 'targetPulse 2s infinite';
          }, 100);
        }
        
        // تحديث الخيارات
        const optionsContainer = document.getElementById('survivalOptions');
        if (optionsContainer) {
          optionsContainer.innerHTML = this.generateSurvivalOptions();
        }
        
        // إعادة تعيين الوقت
        this.state.survival.timeLeft = this.getSurvivalTimeLimit();
        
        // عرض رسالة توضيحية
        this.messages.show(`🎯 ابحث عن: ${randomStudent}`, 'info', 3000);
        this.soundSystem.play('notification');
      }

      startSurvivalTimer() {
        this.survivalInterval = setInterval(() => {
          this.state.survival.timeLeft--;
          
          const timerElement = document.getElementById('survivalTimer');
          if (timerElement) {
            timerElement.textContent = this.state.survival.timeLeft;
            
            // تحذير عندما يبقى 5 ثوان
            if (this.state.survival.timeLeft <= 5) {
              timerElement.style.color = '#e74c3c';
              timerElement.style.animation = 'pulse 0.5s infinite';
            }
          }
          
          // انتهاء الوقت = إجابة خاطئة
          if (this.state.survival.timeLeft <= 0) {
            this.checkSurvivalAnswer('__TIME_OUT__');
          }
        }, 1000);
      }

      checkSurvivalAnswer(selectedStudent) {
        clearInterval(this.survivalInterval);
        
        const isCorrect = selectedStudent === this.state.targetStudent && selectedStudent !== '__TIME_OUT__';
        const isTimeOut = selectedStudent === '__TIME_OUT__';
        
        this.state.stats.gamesPlayed++;

        if (isCorrect) {
          // إجابة صحيحة - مكافآت!
          this.state.stats.correctAnswers++;
          this.state.stats.streak++;
          
          // نقاط أساسية + مكافأة التسلسل + مضاعف المستوى
          const basePoints = 100;
          const streakBonus = this.state.stats.streak * 10;
          const levelMultiplier = this.state.survival.difficultyMultiplier;
          const timeBonus = this.state.survival.timeLeft * 5; // مكافأة للوقت المتبقي
          
          const totalPoints = Math.round((basePoints + streakBonus + timeBonus) * levelMultiplier);
          this.state.stats.score += totalPoints;
          
          // مكافأة محاولة إضافية كل 3 إجابات صحيحة متتالية
          if (this.state.stats.streak % 3 === 0) {
            this.state.stats.lives++;
            this.state.survival.bonusLives++;
            this.soundSystem.play('success');
            this.messages.show(`🎁 مكافأة! محاولة إضافية للتسلسل ${this.state.stats.streak}!`, 'success', 2000);
          } else {
            this.soundSystem.play('correct');
            this.messages.show(`🎉 صحيح! +${totalPoints} نقطة`, 'success', 1500);
          }
          
          // رفع المستوى كل 5 إجابات صحيحة
          if (this.state.stats.correctAnswers % 5 === 0) {
            this.levelUp();
          }
          
        } else {
          // إجابة خاطئة أو انتهاء الوقت
          this.state.stats.wrongAnswers++;
          this.state.stats.streak = 0;
          
          // تقليل المحاولات فقط إذا لم تكن لا محدودة
          if (this.state.maxLives !== -1) {
            this.state.stats.lives--;
          }
          
          if (isTimeOut) {
            this.soundSystem.play('wrong');
            this.messages.show(`⏰ انتهى الوقت! الإجابة الصحيحة: ${this.state.targetStudent}`, 'error', 2000);
          } else {
            this.soundSystem.play('wrong');
            this.messages.show(`❌ خطأ! الإجابة الصحيحة: ${this.state.targetStudent}`, 'error', 2000);
          }
        }

        // تحديث أفضل نتيجة
        if (this.state.stats.score > this.state.survival.bestScore) {
          this.state.survival.bestScore = this.state.stats.score;
          localStorage.setItem('whoisSurvivalBest', this.state.stats.score.toString());
        }

        this.updateSurvivalStats();

        // التحقق من نهاية اللعبة فقط إذا لم تكن المحاولات لا محدودة
        if (this.state.maxLives !== -1 && this.state.stats.lives <= 0) {
          setTimeout(() => {
            this.endSurvivalMode();
          }, 2000);
        } else {
          // جولة جديدة
          setTimeout(() => {
            this.resetSurvivalTimer();
            this.startSurvivalRound();
          }, 2000);
        }
      }

      levelUp() {
        this.state.survival.level++;
        this.state.survival.difficultyMultiplier += 0.2;
        
        // تقليل الوقت قليلاً (لا يقل عن 15 ثانية)
        this.state.survival.timeLeft = Math.max(15, 30 - this.state.survival.level);
        
        this.soundSystem.play('notification');
        this.messages.show(`🆙 ارتقيت للمستوى ${this.state.survival.level}! مضاعف النقاط: x${this.state.survival.difficultyMultiplier.toFixed(1)}`, 'info', 3000);
      }

      resetSurvivalTimer() {
        // إعادة تعيين الوقت حسب المستوى
        this.state.survival.timeLeft = Math.max(15, 30 - this.state.survival.level);
        const timerElement = document.getElementById('survivalTimer');
        if (timerElement) {
          timerElement.style.color = '';
          timerElement.style.animation = '';
        }
        this.startSurvivalTimer();
      }

      updateSurvivalStats() {
        // تحديث جميع الإحصائيات في الواجهة
        const elements = {
          lives: document.querySelector('.survival-stat-card.lives .stat-value'),
          score: document.querySelector('.survival-stat-card.score .stat-value'),
          streak: document.querySelector('.survival-stat-card.streak .stat-value'),
          best: document.querySelector('.survival-stat-card.best .stat-value')
        };

        if (elements.lives) elements.lives.textContent = this.state.maxLives === -1 ? '∞' : this.state.stats.lives;
        if (elements.score) elements.score.textContent = this.state.stats.score.toLocaleString();
        if (elements.streak) elements.streak.textContent = this.state.stats.streak;
        if (elements.best) elements.best.textContent = this.state.survival.bestScore.toLocaleString();

        // تحديث مستوى الصعوبة
        const hintElement = document.querySelector('.survival-hint');
        if (hintElement) {
          hintElement.textContent = `المستوى ${this.state.survival.level} • مضاعف النقاط: x${this.state.survival.difficultyMultiplier.toFixed(1)}`;
        }
      }

      pauseSurvival() {
        clearInterval(this.survivalInterval);
        this.soundSystem.play('click');
        this.messages.show('⏸️ تم إيقاف وضع البقاء مؤقتاً', 'info', 2000);
        
        const pauseBtn = document.querySelector('.survival-controls .btn-secondary');
        if (pauseBtn) {
          pauseBtn.innerHTML = '▶️ استئناف';
          pauseBtn.onclick = () => this.resumeSurvival();
        }
      }

      resumeSurvival() {
        this.startSurvivalTimer();
        this.soundSystem.play('click');
        this.messages.show('▶️ تم استئناف وضع البقاء', 'info', 2000);
        
        const resumeBtn = document.querySelector('.survival-controls .btn-secondary');
        if (resumeBtn) {
          resumeBtn.innerHTML = '⏸️ إيقاف مؤقت';
          resumeBtn.onclick = () => this.pauseSurvival();
        }
      }

      endSurvivalMode() {
        clearInterval(this.survivalInterval);
        
        const totalTime = Math.round((Date.now() - this.state.survival.startTime) / 1000);
        const minutes = Math.floor(totalTime / 60);
        const seconds = totalTime % 60;
        
        this.soundSystem.play('notification');
        
        const gameArea = document.getElementById('gameArea');
        gameArea.innerHTML = `
          <div class="survival-end">
            <div class="survival-end-header">
              <div class="end-icon">💀</div>
              <div class="end-title">انتهى وضع البقاء!</div>
            </div>
            
            <div class="survival-final-stats">
              <div class="final-stat">
                <span class="stat-label">النقاط النهائية:</span>
                <span class="stat-value highlight">${this.state.stats.score.toLocaleString()}</span>
              </div>
              <div class="final-stat">
                <span class="stat-label">المستوى المُحقق:</span>
                <span class="stat-value">${this.state.survival.level}</span>
              </div>
              <div class="final-stat">
                <span class="stat-label">أطول تسلسل:</span>
                <span class="stat-value">${Math.max(...(this.streakHistory || [this.state.stats.streak]))}</span>
              </div>
              <div class="final-stat">
                <span class="stat-label">الإجابات الصحيحة:</span>
                <span class="stat-value">${this.state.stats.correctAnswers}</span>
              </div>
              <div class="final-stat">
                <span class="stat-label">الإجابات الخاطئة:</span>
                <span class="stat-value">${this.state.stats.wrongAnswers}</span>
              </div>
              <div class="final-stat">
                <span class="stat-label">مدة البقاء:</span>
                <span class="stat-value">${minutes}:${seconds.toString().padStart(2, '0')}</span>
              </div>
              <div class="final-stat">
                <span class="stat-label">المحاولات الإضافية:</span>
                <span class="stat-value">${this.state.survival.bonusLives}</span>
              </div>
              ${this.state.stats.score === this.state.survival.bestScore ? 
                '<div class="new-record">🏆 رقم قياسي جديد!</div>' : 
                `<div class="best-score">أفضل نتيجة: ${this.state.survival.bestScore.toLocaleString()}</div>`
              }
            </div>

            <div class="survival-end-controls">
              <button onclick="game.startSurvivalMode()" class="btn btn-primary">
                🔥 إعادة المحاولة
              </button>
              <button onclick="game.resetGame()" class="btn btn-cosmic">
                🏠 العودة للقائمة الرئيسية
              </button>
            </div>
          </div>
        `;
      }

      displayManualGameInterface() {
        const gameArea = document.getElementById('gameArea');
        const isRandomMode = this.state.gameMode === 'random';
        
        gameArea.innerHTML = `
          <div class="manual-game-interface">
            <div class="target-student-display">
              <div class="target-title">${isRandomMode ? '🎲 الطالب المختار عشوائياً' : '🎯 الطالب المستهدف'}</div>
              ${isRandomMode ? '<div class="mode-indicator">🤖 اختيار تلقائي • لا تكرار</div>' : ''}
              <div class="hidden-target" id="hiddenTarget">
                <div class="secret-icon">🔒</div>
                <div class="secret-text">مخفي عن الطلاب</div>
                <button onclick="game.revealTarget()" class="reveal-btn">
                  <i class="fas fa-eye"></i>
                  كشف للمعلم
                </button>
              </div>
              <div class="target-instruction">على الطلاب تخمين من هو هذا الطالب</div>
              ${isRandomMode ? `<div class="random-progress">الجولة ${this.state.usedStudents.length} من ${this.state.allStudents.length} • ${this.state.allStudents.length - this.state.usedStudents.length} متبقي</div>` : ''}
            </div>

            <div class="game-stats">
              <div class="stat-card lives">
                <div class="stat-icon">❤️</div>
                <div class="stat-value">${this.state.maxLives === -1 ? '∞' : this.state.stats.lives}</div>
                <div class="stat-label">المحاولات المتبقية</div>
              </div>
              <div class="stat-card attempts">
                <div class="stat-icon">🎮</div>
                <div class="stat-value">${this.state.stats.gamesPlayed}</div>
                <div class="stat-label">إجمالي المحاولات</div>
              </div>
              <div class="stat-card correct">
                <div class="stat-icon">✅</div>
                <div class="stat-value">${this.state.stats.correctAnswers}</div>
                <div class="stat-label">إجابات صحيحة</div>
              </div>
            </div>
            
            <div class="students-grid">
              ${this.generateStudentOptions()}
            </div>

            <div class="manual-controls">
              <button onclick="game.newManualRound()" class="btn btn-primary">
                ${isRandomMode ? '🎲 طالب عشوائي جديد' : '🔄 طالب جديد'}
              </button>
              <button onclick="game.resetGame()" class="btn btn-cosmic">
                🏠 العودة للقائمة
              </button>
            </div>
          </div>
        `;

        this.soundSystem.play('reveal');
        this.messages.show(`🎯 ابدأ التخمين! الطالب مخفي للحفاظ على عدالة اللعبة`, 'info', 5000);
      }

      displayGameInterface() {
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="current-student">
            من هو الطالب المُختار؟
          </div>
          
          <div class="students-grid">
            ${this.generateStudentOptions()}
          </div>
          
          <div class="game-buttons" style="margin-top: 20px;">
            <button onclick="game.newRound()" class="btn btn-primary">
              🔄 جولة جديدة
            </button>
            <button onclick="game.endGame()" class="btn btn-warning">
              🏁 إنهاء اللعبة
            </button>
          </div>
        `;

        this.soundSystem.play('reveal');
        this.messages.show(`🎯 اعثر على: ${this.state.targetStudent}`, 'info', 5000);
      }

      generateStudentOptions() {
        const shuffled = [...this.state.allStudents].sort(() => Math.random() - 0.5);
        const options = shuffled.slice(0, Math.min(8, shuffled.length));
        
        if (!options.includes(this.state.targetStudent)) {
          options[0] = this.state.targetStudent;
          options.sort(() => Math.random() - 0.5);
        }

        return options.map(student => `
          <div class="student-card" onclick="game.checkAnswer('${student}')">
            <div class="student-name">${student}</div>
          </div>
        `).join('');
      }

      checkAnswer(selectedStudent) {
        if (this.state.gameMode === 'manual' || this.state.gameMode === 'random') {
          this.checkManualAnswer(selectedStudent);
        } else if (this.state.gameMode === 'survival') {
          this.checkSurvivalAnswer(selectedStudent);
        } else {
          this.checkRegularAnswer(selectedStudent);
        }
      }

      checkManualAnswer(selectedStudent) {
        const isCorrect = selectedStudent === this.state.targetStudent;
        
        // إضافة مؤشرات بصرية احترافية للبطاقة المختارة فقط
        const cards = document.querySelectorAll('.student-card');
        cards.forEach(card => {
          const cardName = card.querySelector('.student-name').textContent;
          if (cardName === selectedStudent) {
            // إضافة تأثير بصري للبطاقة المختارة
            card.classList.add('selected-answer');
            card.classList.add(isCorrect ? 'correct-answer' : 'wrong-answer');
            
            // إضافة أيقونة النتيجة
            const resultIcon = document.createElement('div');
            resultIcon.className = 'answer-result-icon';
            resultIcon.innerHTML = isCorrect ? '✓' : '✗';
            card.appendChild(resultIcon);
          }
        });
        
        this.state.stats.gamesPlayed++;

        if (isCorrect) {
          // إجابة صحيحة - عرض نافذة احترافية للفوز
          this.state.stats.correctAnswers++;
          this.soundSystem.play('correct');
          
          // تأثير الاحتفال للبطاقة الصحيحة
          this.celebrateCorrectAnswer(selectedStudent);
          
          setTimeout(() => {
            this.showSuccessModal(selectedStudent);
          }, 1500);
        } else {
          // إجابة خاطئة - تقليل المحاولات (إلا في حالة المحاولات اللانهائية)
          this.state.stats.wrongAnswers++;
          
          // تقليل المحاولات فقط إذا لم تكن لا نهائية
          if (this.state.maxLives !== -1) {
            this.state.stats.lives--;
          }
          
          this.soundSystem.play('wrong');
          
          // تأثير الاهتزاز للبطاقة الخاطئة
          this.shakeWrongAnswer(selectedStudent);
          
          // التحقق من نهاية اللعبة فقط إذا لم تكن المحاولات لا نهائية
          if (this.state.maxLives !== -1 && this.state.stats.lives <= 0) {
            // نفدت المحاولات - عرض نافذة احترافية للكشف
            setTimeout(() => {
              this.showRevealModal();
            }, 1500);
          } else {
            // عرض رسالة الخطأ
            if (this.state.maxLives === -1) {
              this.messages.show(`❌ إجابة خاطئة! محاولات لا نهائية متاحة`, 'error', 3000);
            } else {
              this.messages.show(`❌ إجابة خاطئة! المحاولات المتبقية: ${this.state.stats.lives}`, 'error', 3000);
            }
            
            // تحديث العرض وإعادة تعيين البطاقات
            setTimeout(() => {
              this.resetCardsVisual();
              this.updateManualStats();
            }, 2000);
          }
        }
      }

      checkRegularAnswer(selectedStudent) {
        const isCorrect = selectedStudent === this.state.targetStudent;
        
        // تأثير بصري
        const cards = document.querySelectorAll('.student-card');
        cards.forEach(card => {
          const cardName = card.querySelector('.student-name').textContent;
          if (cardName === selectedStudent) {
            card.classList.add(isCorrect ? 'correct' : 'wrong');
          }
          if (cardName === this.state.targetStudent && !isCorrect) {
            card.classList.add('correct');
          }
        });

        if (isCorrect) {
          this.soundSystem.play('correct');
          this.state.updateStats(true);
          this.messages.show('🎉 ممتاز! إجابة صحيحة', 'success', 3000);
        } else {
          this.soundSystem.play('wrong');
          this.state.updateStats(false);
          this.messages.show(`❌ خطأ! الإجابة الصحيحة: ${this.state.targetStudent}`, 'error', 5000);
        }

        setTimeout(() => {
          // التحقق من نهاية اللعبة فقط إذا لم تكن المحاولات لا نهائية
          if (this.state.maxLives === -1 || this.state.stats.lives > 0) {
            this.newRound();
          } else {
            this.endGame();
          }
        }, 3000);
      }

      endGame() {
        this.soundSystem.play('notification');
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="result-display">
            🏆 انتهت اللعبة!
            <br><br>
            النقاط: ${this.state.stats.score}
            <br>
            الإجابات الصحيحة: ${this.state.stats.correctAnswers}
            <br>
            الإجابات الخاطئة: ${this.state.stats.wrongAnswers}
            <br>
            معدل النجاح: ${this.state.getSuccessRate()}%
          </div>
          
          <div class="game-buttons">
            <button onclick="game.resetGame()" class="btn btn-primary">
              🔄 لعبة جديدة
            </button>
          </div>
        `;
      }

      resetGame() {
        this.state.reset();
        const gameArea = document.getElementById('gameArea');
        gameArea.innerHTML = '<p><i class="fas fa-info-circle"></i> اختر الصف ونمط اللعبة لبدء التحدي</p>';
        this.messages.show('🎮 جاهز للعبة جديدة!', 'info', 3000);
      }

      showSuccessModal(winnerName) {
        const modal = document.createElement('div');
        modal.className = 'success-modal modal-overlay';
        modal.innerHTML = `
          <div class="modal-content success-content">
            <div class="success-animation">
              <div class="success-icon">🏆</div>
              <div class="success-confetti"></div>
            </div>
            <div class="success-title">مبروك!</div>
            <div class="winner-name">${winnerName}</div>
            <div class="success-message">تمكن من العثور على الطالب المستهدف!</div>
            <div class="success-stats">
              <div class="stat">
                <span class="stat-label">المحاولات المستخدمة:</span>
                <span class="stat-value">${this.state.stats.gamesPlayed}</span>
              </div>
            </div>
            <div class="modal-buttons">
              <button onclick="game.newManualRound(); game.closeModal()" class="btn btn-primary">
                🔄 جولة جديدة
              </button>
              <button onclick="game.resetGame(); game.closeModal()" class="btn btn-cosmic">
                🏠 إنهاء اللعبة
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        this.soundSystem.play('success');
        
        // إطلاق الألعاب النارية
        if (typeof confetti !== 'undefined') {
          confetti({
            particleCount: 200,
            spread: 100,
            origin: { y: 0.4 }
          });
        }
      }

      showRevealModal() {
        const modal = document.createElement('div');
        modal.className = 'reveal-modal modal-overlay';
        modal.innerHTML = `
          <div class="modal-content reveal-content">
            <div class="reveal-animation">
              <div class="reveal-icon">🎭</div>
            </div>
            <div class="reveal-title">انتهت المحاولات!</div>
            <div class="revealed-name">${this.state.targetStudent}</div>
            <div class="reveal-message">هذا هو الطالب المستهدف</div>
            <div class="reveal-stats">
              <div class="stat">
                <span class="stat-label">إجمالي المحاولات:</span>
                <span class="stat-value">${this.state.stats.gamesPlayed}</span>
              </div>
              <div class="stat">
                <span class="stat-label">الإجابات الصحيحة:</span>
                <span class="stat-value">${this.state.stats.correctAnswers}</span>
              </div>
            </div>
            <div class="modal-buttons">
              <button onclick="game.newManualRound(); game.closeModal()" class="btn btn-primary">
                🔄 جولة جديدة
              </button>
              <button onclick="game.resetGame(); game.closeModal()" class="btn btn-cosmic">
                🏠 إنهاء اللعبة
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        this.soundSystem.play('reveal');
      }

      closeModal() {
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
          modal.style.animation = 'fadeOut 0.3s ease-out';
          setTimeout(() => {
            if (modal.parentNode) {
              modal.parentNode.removeChild(modal);
            }
          }, 300);
        });
      }

      newManualRound() {
        // إعادة تعيين المحاولات للجولة الجديدة
        this.state.stats.lives = this.state.maxLives;
        this.state.stats.gamesPlayed = 0;
        this.state.stats.correctAnswers = 0;
        this.state.stats.wrongAnswers = 0;
        
        // التحقق من الوضع الحالي
        if (this.state.gameMode === 'random') {
          // في الوضع العشوائي، اختيار طالب جديد تلقائياً
          this.startRandomMode();
        } else {
          // في الوضع الانتقائي، عرض نافذة اختيار طالب جديد
          this.showStudentSelection();
        }
      }

      updateManualStats() {
        // تحديث الإحصائيات في الواجهة
        const livesElement = document.querySelector('.stat-card.lives .stat-value');
        const attemptsElement = document.querySelector('.stat-card.attempts .stat-value');
        const correctElement = document.querySelector('.stat-card.correct .stat-value');
        
        // عرض ∞ للمحاولات اللانهائية
        if (livesElement) {
          livesElement.textContent = this.state.maxLives === -1 ? '∞' : this.state.stats.lives;
        }
        if (attemptsElement) attemptsElement.textContent = this.state.stats.gamesPlayed;
        if (correctElement) correctElement.textContent = this.state.stats.correctAnswers;
        
        // تحديث مؤشر التقدم في الوضع العشوائي
        if (this.state.gameMode === 'random') {
          const progressElement = document.querySelector('.random-progress');
          if (progressElement) {
            const remaining = this.state.allStudents.length - this.state.usedStudents.length;
            progressElement.textContent = `الجولة ${this.state.usedStudents.length} من ${this.state.allStudents.length} • ${remaining} متبقي`;
          }
        }
      }

      revealTarget() {
        const hiddenTarget = document.getElementById('hiddenTarget');
        if (hiddenTarget) {
          hiddenTarget.innerHTML = `
            <div class="revealed-target">
              <div class="target-name">${this.state.targetStudent}</div>
              <button onclick="game.hideTarget()" class="hide-btn">
                <i class="fas fa-eye-slash"></i>
                إخفاء مرة أخرى
              </button>
            </div>
          `;
          this.soundSystem.play('notification');
        }
      }

      hideTarget() {
        const hiddenTarget = document.getElementById('hiddenTarget');
        if (hiddenTarget) {
          hiddenTarget.innerHTML = `
            <div class="secret-icon">🔒</div>
            <div class="secret-text">مخفي عن الطلاب</div>
            <button onclick="game.revealTarget()" class="reveal-btn">
              <i class="fas fa-eye"></i>
              كشف للمعلم
            </button>
          `;
          this.soundSystem.play('click');
        }
      }

      celebrateCorrectAnswer(studentName) {
        const cards = document.querySelectorAll('.student-card');
        cards.forEach(card => {
          const cardName = card.querySelector('.student-name').textContent;
          if (cardName === studentName) {
            // تأثير الوميض الذهبي
            card.style.animation = 'correctPulse 0.8s ease-in-out 3';
            
            // إضافة جزيئات متحركة
            this.addCelebrationParticles(card);
          }
        });
      }

      shakeWrongAnswer(studentName) {
        const cards = document.querySelectorAll('.student-card');
        cards.forEach(card => {
          const cardName = card.querySelector('.student-name').textContent;
          if (cardName === studentName) {
            // تأثير الاهتزاز
            card.style.animation = 'wrongShake 0.6s ease-in-out 2';
          }
        });
      }

      addCelebrationParticles(card) {
        for (let i = 0; i < 6; i++) {
          const particle = document.createElement('div');
          particle.className = 'celebration-particle';
          particle.style.left = Math.random() * 100 + '%';
          particle.style.animationDelay = Math.random() * 0.5 + 's';
          card.appendChild(particle);
          
          // إزالة الجزيئات بعد انتهاء الحركة
          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 2000);
        }
      }

      resetCardsVisual() {
        const cards = document.querySelectorAll('.student-card');
        cards.forEach(card => {
          // إزالة جميع الكلاسات والتأثيرات
          card.classList.remove('selected-answer', 'correct-answer', 'wrong-answer');
          card.style.animation = '';
          
          // إزالة أيقونات النتيجة
          const resultIcon = card.querySelector('.answer-result-icon');
          if (resultIcon) {
            resultIcon.remove();
          }
          
          // إزالة الجزيئات إن وجدت
          const particles = card.querySelectorAll('.celebration-particle');
          particles.forEach(particle => particle.remove());
        });
      }
    }

    // إنشاء مثيل اللعبة
    let game;
    let nameAssembly;

    // بدء اللعبة عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', () => {
      game = new WhoIsItGame();
      nameAssembly = game.nameAssembly;
      
      // إضافة تأثيرات تفاعلية
      document.addEventListener('click', (e) => {
        if (game && game.soundSystem) {
          game.soundSystem.play('click');
        }
      });
    });
  </script>
</body>
</html>
