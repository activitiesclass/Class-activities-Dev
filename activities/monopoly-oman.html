<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="مونوبولي سلطنة عُمان - لعبة العقارات التعليمية">
    <title>مونوبولي سلطنة عُمان - لعبة العقارات العُمانية</title>
    
    <!-- الخطوط والأيقونات -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- المكتبات الخارجية -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <!-- الأنماط والسكريبت الموحد -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/activityUtils.js"></script>

    <style>
        /* ===========================================
           نظام الألوان العُماني المتقدم
        =========================================== */
        :root {
            /* الألوان العُمانية الرئيسية */
            --oman-red: #DC143C;
            --oman-green: #228B22;
            --oman-white: #FFFFFF;
            --accent-gold: #FFD700;
            
            /* تدرجات مونوبولي مخصصة */
            --gradient-red: linear-gradient(135deg, var(--oman-red) 0%, #B71C1C 100%);
            --gradient-green: linear-gradient(135deg, var(--oman-green) 0%, #1B5E20 100%);
            --gradient-gold: linear-gradient(135deg, var(--accent-gold) 0%, #F57C00 100%);
            --gradient-background: linear-gradient(135deg, #0F172A 0%, #1E293B 25%, #334155 50%, #475569 75%, #64748B 100%);
            
            /* ألوان المونوبولي التقليدية */
            --property-brown: #8B4513;
            --property-light-blue: #87CEEB;
            --property-pink: #FF1493;
            --property-orange: #FF8C00;
            --property-red: var(--oman-red);
            --property-yellow: #FFD700;
            --property-green: var(--oman-green);
            --property-dark-blue: #191970;
            --utility-color: #F0F8FF;
            --railroad-color: #2F4F4F;
            
            /* ألوان النظام */
            --success-color: #22C55E;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --info-color: #3B82F6;
            
            /* ألوان النص والخلفيات */
            --text-primary: #FFFFFF;
            --text-secondary: #E2E8F0;
            --text-muted: #94A3B8;
            --text-dark: #1E293B;
            --text-board: #1F2937;
            
            /* خلفيات وأسطح */
            --background-primary: #0F172A;
            --background-secondary: #1E293B;
            --surface-elevated: rgba(255, 255, 255, 0.1);
            --surface-glass: rgba(255, 255, 255, 0.05);
            --surface-board: rgba(255, 255, 255, 0.98);
            
            /* ظلال وتأثيرات */
            --shadow-small: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.25);
            --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.35);
            --shadow-glow-red: 0 0 24px rgba(220, 20, 60, 0.4);
            --shadow-glow-green: 0 0 24px rgba(34, 139, 34, 0.4);
            --shadow-glow-gold: 0 0 24px rgba(255, 215, 0, 0.4);
            --shadow-board: 0 12px 48px rgba(0, 0, 0, 0.4);
            
            /* أنصاف أقطار الحدود */
            --border-radius-small: 8px;
            --border-radius-medium: 12px;
            --border-radius-large: 16px;
            --border-radius-xl: 24px;
            
            /* انتقالات */
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===========================================
           الإعدادات العامة
        =========================================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--gradient-background);
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* خلفية متحركة متطورة */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(220, 20, 60, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(34, 139, 34, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.08) 0%, transparent 50%);
            animation: monopolyFlow 25s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes monopolyFlow {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                opacity: 0.6;
            }
            25% { 
                transform: scale(1.2) rotate(90deg);
                opacity: 0.8;
            }
            50% { 
                transform: scale(0.8) rotate(180deg);
                opacity: 0.4;
            }
            75% { 
                transform: scale(1.1) rotate(270deg);
                opacity: 0.7;
            }
        }

        /* ===========================================
           أزرار التحكم العلوية المحسّنة
        =========================================== */
        .top-controls-panel {
            position: fixed;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 2147483647;
            flex-direction: row-reverse;
        }

        .control-btn {
            font-size: 18px;
            background: var(--surface-glass);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-normal);
            padding: 12px;
            border-radius: 50%;
            backdrop-filter: blur(16px);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-medium);
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        
        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .control-btn:hover::before {
            transform: translateX(100%);
        }
        
        .control-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        #returnToIndex {
            background: linear-gradient(135deg, #2193b0, #6dd5ed);
            border-color: #2193b0;
        }

        #returnToIndex:hover {
            background: linear-gradient(135deg, #1e8397, #5bc3d0);
            box-shadow: 0 8px 25px rgba(33, 147, 176, 0.4);
        }

        #soundToggle {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        #soundToggle:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        #fullscreenToggle {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            border-color: #f093fb;
        }

        #fullscreenToggle:hover {
            background: linear-gradient(135deg, #e87ee8, #e8455a);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        }

        #gameInfo {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-color: #4facfe;
        }

        #gameInfo:hover {
            background: linear-gradient(135deg, #3d8bfe, #00d9fe);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        /* نافذة معلومات اللعبة */
        .game-info-content {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .info-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--oman-red);
        }

        .info-section h3 {
            margin: 0 0 10px 0;
            color: var(--oman-red);
            font-size: 16px;
        }

        .info-section p {
            margin: 0;
            color: #495057;
            line-height: 1.5;
        }

        .modal-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        /* تحسينات للأجهزة المحمولة */
        @media (max-width: 768px) {
            .top-controls-panel {
                top: 10px;
                right: 10px;
                gap: 8px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
                padding: 8px;
            }

            .top-controls-panel {
                flex-direction: column;
                position: fixed;
                top: 10px;
                right: 10px;
            }
        }

        @media (max-width: 480px) {
            .control-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
                padding: 6px;
            }
        }

        /* ===========================================
           الحاوية الرئيسية
        =========================================== */
        .monopoly-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* العنوان الرئيسي */
        .game-title {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--surface-glass);
            border-radius: var(--border-radius-xl);
            backdrop-filter: blur(16px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-large);
        }

        .game-title h1 {
            font-size: 3rem;
            font-weight: 700;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-title p {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* ===========================================
           لوحة اللعبة العصرية
        =========================================== */
        .game-board {
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            aspect-ratio: 1;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.3),
                0 0 0 8px rgba(255,255,255,0.1),
                inset 0 0 50px rgba(255,255,255,0.1);
            position: relative;
            border: 6px solid var(--oman-red);
            overflow: visible;
            transform-style: preserve-3d;
            animation: boardGlow 3s ease-in-out infinite alternate;
        }

        @keyframes boardGlow {
            0% { 
                box-shadow: 
                    0 20px 40px rgba(0,0,0,0.3),
                    0 0 0 8px rgba(255,255,255,0.1),
                    inset 0 0 50px rgba(255,255,255,0.1),
                    0 0 60px rgba(220, 20, 60, 0.3);
            }
            100% { 
                box-shadow: 
                    0 25px 50px rgba(0,0,0,0.4),
                    0 0 0 12px rgba(255,255,255,0.15),
                    inset 0 0 80px rgba(255,255,255,0.15),
                    0 0 100px rgba(220, 20, 60, 0.5);
            }
        }

        /* مربعات اللوحة العصرية */
        .board-square {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 8px 4px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #2c3e50;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .board-square::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .board-square:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 
                0 15px 30px rgba(0,0,0,0.2),
                0 0 20px rgba(220, 20, 60, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.9);
            z-index: 10;
        }

        .board-square:hover::before {
            transform: translateX(100%);
        }

        .board-square:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
            z-index: 10;
        }

        /* مربعات الزوايا العصرية */
        .corner-square {
            width: 120px;
            height: 120px;
            border-radius: 18px !important;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%) !important;
            border: 4px solid #c44569 !important;
            color: white !important;
            font-size: 0.85rem !important;
            font-weight: 800 !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3) !important;
            box-shadow: 
                0 8px 16px rgba(0,0,0,0.2),
                inset 0 2px 0 rgba(255,255,255,0.3) !important;
        }

        .corner-square:hover {
            background: linear-gradient(135deg, #ff5252 0%, #d84315 100%) !important;
            transform: translateY(-10px) scale(1.08) !important;
        }

        /* مربعات الجانب العصرية */
        .side-square {
            width: 80px;
            height: 120px;
            border-radius: 14px !important;
        }

        /* ألوان المجموعات العصرية */
        .brown { 
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%) !important; 
            color: white !important;
            border-color: #5d2f0b !important;
        }
        .light-blue { 
            background: linear-gradient(135deg, #87ceeb 0%, #4fb3d9 100%) !important;
            color: #1e3c72 !important;
            border-color: #2980b9 !important;
        }
        .pink { 
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%) !important; 
            color: white !important;
            border-color: #c91d6b !important;
        }
        .orange { 
            background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%) !important;
            color: white !important;
            border-color: #d67700 !important;
        }
        .red { 
            background: linear-gradient(135deg, #dc143c 0%, #b71c1c 100%) !important; 
            color: white !important;
            border-color: #8b0000 !important;
        }
        .yellow { 
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%) !important;
            color: #2c3e50 !important;
            border-color: #e6ac00 !important;
        }
        .green { 
            background: linear-gradient(135deg, #32cd32 0%, #228b22 100%) !important; 
            color: white !important;
            border-color: #1a5d1a !important;
        }
        .dark-blue { 
            background: linear-gradient(135deg, #191970 0%, #000080 100%) !important; 
            color: white !important;
            border-color: #0a0a3a !important;
        }
        .utility { 
            background: linear-gradient(135deg, #708090 0%, #2f4f4f 100%) !important;
            color: white !important;
            border-color: #1c2b2b !important;
        }
        .railroad { 
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important; 
            color: white !important;
            border-color: #1a252f !important;
        }
        .special {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%) !important;
            color: white !important;
            border-color: #c44569 !important;
        }

        /* مواضع المربعات المحسنة */
        /* الصف السفلي */
        .square-0 { bottom: 0; right: 0; }
        .square-1 { bottom: 0; right: 130px; }
        .square-2 { bottom: 0; right: 220px; }
        .square-3 { bottom: 0; right: 310px; }
        .square-4 { bottom: 0; right: 400px; }
        .square-5 { bottom: 0; right: 490px; }
        .square-6 { bottom: 0; right: 580px; }
        .square-7 { bottom: 0; right: 670px; }
        .square-8 { bottom: 0; right: 760px; }
        .square-9 { bottom: 0; right: 850px; }
        .square-10 { bottom: 0; left: 0; }

        /* الصف الأيسر */
        .square-11 { left: 0; bottom: 130px; transform: rotate(90deg); }
        .square-12 { left: 0; bottom: 220px; transform: rotate(90deg); }
        .square-13 { left: 0; bottom: 310px; transform: rotate(90deg); }
        .square-14 { left: 0; bottom: 400px; transform: rotate(90deg); }
        .square-15 { left: 0; bottom: 490px; transform: rotate(90deg); }
        .square-16 { left: 0; bottom: 580px; transform: rotate(90deg); }
        .square-17 { left: 0; bottom: 670px; transform: rotate(90deg); }
        .square-18 { left: 0; bottom: 760px; transform: rotate(90deg); }
        .square-19 { left: 0; bottom: 850px; transform: rotate(90deg); }
        .square-20 { top: 0; left: 0; }

        /* الصف العلوي */
        .square-21 { top: 0; left: 130px; transform: rotate(180deg); }
        .square-22 { top: 0; left: 220px; transform: rotate(180deg); }
        .square-23 { top: 0; left: 310px; transform: rotate(180deg); }
        .square-24 { top: 0; left: 400px; transform: rotate(180deg); }
        .square-25 { top: 0; left: 490px; transform: rotate(180deg); }
        .square-26 { top: 0; left: 580px; transform: rotate(180deg); }
        .square-27 { top: 0; left: 670px; transform: rotate(180deg); }
        .square-28 { top: 0; left: 760px; transform: rotate(180deg); }
        .square-29 { top: 0; left: 850px; transform: rotate(180deg); }
        .square-30 { top: 0; right: 0; }

        /* الصف الأيمن */
        .square-31 { right: 0; top: 130px; transform: rotate(270deg); }
        .square-32 { right: 0; top: 220px; transform: rotate(270deg); }
        .square-33 { right: 0; top: 310px; transform: rotate(270deg); }
        .square-34 { right: 0; top: 400px; transform: rotate(270deg); }
        .square-35 { right: 0; top: 490px; transform: rotate(270deg); }
        .square-36 { right: 0; top: 580px; transform: rotate(270deg); }
        .square-37 { right: 0; top: 670px; transform: rotate(270deg); }
        .square-38 { right: 0; top: 760px; transform: rotate(270deg); }
        .square-39 { right: 0; top: 850px; transform: rotate(270deg); }

        /* مركز اللوحة مع شعار عُمان */
        .game-board::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 45%;
            height: 45%;
            background: 
                radial-gradient(circle at center, rgba(220, 20, 60, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(220, 20, 60, 0.05) 100%);
            border-radius: 50%;
            border: 4px solid rgba(220, 20, 60, 0.3);
            backdrop-filter: blur(20px);
            box-shadow: 
                inset 0 0 30px rgba(255,255,255,0.1),
                0 0 40px rgba(220, 20, 60, 0.2);
        }

        .game-board::before {
            content: '🇴🇲';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            z-index: 5;
            text-shadow: 0 0 20px rgba(0,0,0,0.3);
            animation: flagWave 4s ease-in-out infinite;
        }

        @keyframes flagWave {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        /* ===========================================
           عناصر تحكم اللعبة
        =========================================== */
        .game-controls {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: var(--surface-glass);
            border-radius: var(--border-radius-large);
            backdrop-filter: blur(16px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .control-button {
            background: var(--gradient-red);
            color: var(--text-primary);
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: var(--border-radius-medium);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: 'Cairo', sans-serif;
            box-shadow: var(--shadow-medium);
        }

        .control-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-glow-red);
        }

        .control-button.green {
            background: var(--gradient-green);
        }

        .control-button.green:hover {
            box-shadow: var(--shadow-glow-green);
        }

        .control-button.gold {
            background: var(--gradient-gold);
            color: var(--text-dark);
        }

        .control-button.gold:hover {
            box-shadow: var(--shadow-glow-gold);
        }

        /* ===========================================
           معلومات اللاعبين
        =========================================== */
        .players-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .player-card {
            background: var(--surface-glass);
            border-radius: var(--border-radius-large);
            padding: 20px;
            backdrop-filter: blur(16px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition-normal);
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-large);
            border-color: var(--oman-red);
        }

        .player-card h3 {
            color: var(--accent-gold);
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        /* ===========================================
           أدوات التحكم (مطابقة لباقي الأنشطة)
        =========================================== */
        .game-controls {
            background: var(--surface-glass);
            border-radius: var(--border-radius-xl);
            padding: 30px;
            margin: 30px 0;
            backdrop-filter: blur(16px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-large);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-medium);
            background: var(--surface-board);
            color: var(--text-dark);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: var(--transition-normal);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
        }

        .form-control:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .game-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-medium);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            justify-content: center;
            box-shadow: var(--shadow-medium);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:not(:disabled):hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-large);
        }

        .btn-primary {
            background: var(--gradient-red);
            color: var(--text-primary);
        }

        .btn-primary:not(:disabled):hover {
            box-shadow: var(--shadow-glow-red);
        }

        .btn-success {
            background: var(--gradient-green);
            color: var(--text-primary);
        }

        .btn-success:not(:disabled):hover {
            box-shadow: var(--shadow-glow-green);
        }

        .btn-warning {
            background: var(--gradient-gold);
            color: var(--text-dark);
        }

        .btn-warning:not(:disabled):hover {
            box-shadow: var(--shadow-glow-gold);
        }

        .btn-info {
            background: var(--gradient-red);
            color: var(--text-primary);
        }

        .btn-info:hover {
            box-shadow: var(--shadow-glow-red);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            box-shadow: 0 0 20px rgba(108, 117, 125, 0.4);
        }

        /* ===========================================
           واجهة اختيار اللاعبين الذكية
        =========================================== */
        .smart-player-selection {
            background: var(--surface-glass);
            border-radius: var(--border-radius-xl);
            padding: 0;
            margin: 30px 0;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-large);
            overflow: hidden;
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .selection-header {
            background: linear-gradient(135deg, var(--oman-red) 0%, #B71C1C 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .selection-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a" cx="50%" cy="50%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><circle cx="10" cy="10" r="10" fill="url(%23a)"><animate attributeName="cx" values="10;90;10" dur="3s" repeatCount="indefinite"/></circle></svg>');
            opacity: 0.3;
            animation: headerFlow 6s ease-in-out infinite;
        }

        @keyframes headerFlow {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .icon-wrapper {
            display: inline-block;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .icon-wrapper i {
            font-size: 2.5rem;
            color: white;
        }

        .selection-header h2 {
            margin: 0 0 10px 0;
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold) 0%, #FFA000 100%);
            width: 0%;
            transition: width 0.5s ease-out;
            border-radius: 3px;
        }

        .selection-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .selected-count {
            font-size: 1.8rem;
            color: var(--accent-gold);
            font-weight: 800;
        }

        .selection-modes {
            padding: 20px 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .mode-switcher {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            padding: 12px 20px;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: var(--gradient-gold);
            border-color: var(--accent-gold);
            color: var(--text-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-gold);
        }

        .smart-selection-container {
            padding: 30px;
        }

        .smart-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-medium);
            padding: 20px;
            cursor: pointer;
            transition: var(--transition-normal);
            text-align: center;
        }

        .feature-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .feature-card.active {
            background: var(--gradient-green);
            border-color: var(--oman-green);
            color: white;
            transform: translateY(-3px);
            box-shadow: var(--shadow-glow-green);
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.5rem;
        }

        .feature-card.active .feature-icon {
            background: rgba(255, 255, 255, 0.2);
        }

        .feature-content h4 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .feature-content p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .search-and-sort {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .search-box {
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-medium);
            background: var(--surface-board);
            color: var(--text-dark);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: var(--transition-normal);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
        }

        .students-interactive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            padding: 0 30px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 30px;
        }

        .student-interactive-card {
            background: var(--surface-board);
            border: 2px solid transparent;
            border-radius: var(--border-radius-medium);
            padding: 20px;
            cursor: pointer;
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .student-interactive-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .student-interactive-card:hover::before {
            left: 100%;
        }

        .student-interactive-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
            border-color: var(--oman-red);
        }

        .student-interactive-card.selected {
            background: var(--gradient-green);
            color: white;
            border-color: var(--oman-green);
            transform: translateY(-5px);
            box-shadow: var(--shadow-glow-green);
        }

        .student-interactive-card.selected .student-avatar {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        .student-avatar {
            width: 60px;
            height: 60px;
            background: var(--gradient-red);
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.5rem;
            color: white;
            font-weight: 700;
        }

        .student-name {
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .student-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .student-interactive-card.selected .student-stats {
            opacity: 1;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .selected-players-preview {
            padding: 0 30px 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
        }

        .selected-players-preview h3 {
            color: var(--accent-gold);
            margin: 20px 0 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selected-players-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            min-height: 100px;
        }

        .selected-player-card {
            background: var(--gradient-green);
            color: white;
            border-radius: var(--border-radius-medium);
            padding: 15px;
            text-align: center;
            position: relative;
            animation: slideInScale 0.3s ease-out;
        }

        @keyframes slideInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .selected-player-card .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            color: white;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .selected-player-card .remove-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .manual-selection-container {
            padding: 30px;
        }

        .manual-selectors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .manual-selector {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-medium);
            padding: 20px;
        }

        .manual-selector label {
            display: block;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .selection-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.03);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn {
            padding: 15px 30px;
            border: none;
            border-radius: var(--border-radius-medium);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            justify-content: center;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .action-btn:not(:disabled):hover {
            transform: translateY(-3px);
        }

        .action-btn.primary {
            background: var(--gradient-green);
            color: white;
        }

        .action-btn.primary:not(:disabled):hover {
            box-shadow: var(--shadow-glow-green);
        }

        .action-btn.secondary {
            background: var(--gradient-gold);
            color: var(--text-dark);
        }

        .action-btn.secondary:hover {
            box-shadow: var(--shadow-glow-gold);
        }

        .action-btn.danger {
            background: var(--gradient-red);
            color: white;
        }

        .action-btn.danger:hover {
            box-shadow: var(--shadow-glow-red);
        }

        .selection-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .selection-header h2 {
            color: var(--accent-gold);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .selection-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            align-items: end;
        }

        .class-selector, .student-select {
            background: var(--surface-board);
            border: 2px solid var(--oman-red);
            border-radius: var(--border-radius-medium);
            padding: 12px;
            font-size: 1rem;
            color: var(--text-dark);
            font-family: 'Cairo', sans-serif;
            width: 100%;
            transition: var(--transition-normal);
        }

        .class-selector:focus, .student-select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
        }

        .selection-mode-controls {
            text-align: center;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .mode-btn {
            background: var(--surface-glass);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
        }

        .mode-btn.active, .mode-btn:hover {
            background: var(--gradient-red);
            border-color: var(--oman-red);
            color: var(--oman-white);
        }

        .player-selectors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .player-selector {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: var(--border-radius-medium);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .player-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .students-grid-container {
            margin: 20px 0;
        }

        .selected-students {
            background: var(--surface-elevated);
            padding: 15px;
            border-radius: var(--border-radius-medium);
            margin-bottom: 20px;
            border: 2px solid var(--oman-green);
        }

        .selected-students h4 {
            color: var(--oman-green);
            margin-bottom: 10px;
        }

        .selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .selected-student {
            background: var(--gradient-green);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--border-radius-medium);
        }

        .student-card {
            background: var(--surface-board);
            color: var(--text-dark);
            padding: 15px;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            transition: var(--transition-normal);
            border: 2px solid transparent;
            text-align: center;
            font-weight: 600;
        }

        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
            border-color: var(--oman-red);
        }

        .student-card.selected {
            background: var(--gradient-green);
            color: white;
            border-color: var(--oman-green);
            box-shadow: var(--shadow-glow-green);
        }

        .selection-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        /* ===========================================
           النوافذ المنبثقة
        =========================================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--surface-board);
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius-xl);
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: var(--shadow-large);
            color: var(--text-dark);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .close {
            color: var(--text-muted);
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .close:hover {
            color: var(--oman-red);
            transform: scale(1.1);
        }

        /* ===========================================
           الاستجابة العصرية للأجهزة المختلفة
        =========================================== */
        
        /* الشاشات الكبيرة */
        @media (min-width: 1200px) {
            .game-board {
                max-width: 1000px;
            }
            
            .corner-square {
                width: 140px;
                height: 140px;
            }
            
            .side-square {
                width: 90px;
                height: 140px;
            }
        }

        /* الأجهزة اللوحية */
        @media (max-width: 1024px) {
            .monopoly-container {
                padding: 15px;
            }

            .game-board {
                max-width: 800px;
            }

            .corner-square {
                width: 100px;
                height: 100px;
                font-size: 0.7rem !important;
            }

            .side-square {
                width: 65px;
                height: 100px;
            }

            .board-square {
                font-size: 0.65rem;
                padding: 6px 3px;
            }
        }

        /* الهواتف الذكية */
        @media (max-width: 768px) {
            .monopoly-container {
                padding: 8px;
            }

            .game-title h1 {
                font-size: 1.8rem;
            }

            .game-title p {
                font-size: 0.9rem;
            }

            .game-board {
                max-width: 100%;
                margin: 15px auto;
                border-radius: 15px;
            }

            .corner-square {
                width: 70px;
                height: 70px;
                font-size: 0.6rem !important;
                border-radius: 12px !important;
            }

            .side-square {
                width: 45px;
                height: 70px;
                border-radius: 10px !important;
            }

            .board-square {
                font-size: 0.55rem;
                padding: 4px 2px;
                border-width: 2px;
            }

            .property-content {
                transform: scale(0.9);
            }

            .game-board::before {
                font-size: 50px !important;
            }
        }

        /* الهواتف الصغيرة */
        @media (max-width: 480px) {
            .game-board {
                border-radius: 12px;
                border-width: 4px;
            }

            .corner-square {
                width: 60px;
                height: 60px;
                font-size: 0.5rem !important;
            }

            .side-square {
                width: 35px;
                height: 60px;
            }

            .board-square {
                font-size: 0.45rem;
                padding: 2px 1px;
            }

            .game-board::before {
                font-size: 35px !important;
            }

            .game-board::after {
                width: 40%;
                height: 40%;
                border-width: 2px;
            }

            /* إعادة تموضع المربعات للشاشات الصغيرة */
            .square-1 { right: 80px; }
            .square-2 { right: 130px; }
            .square-3 { right: 180px; }
            .square-4 { right: 230px; }
            .square-5 { right: 280px; }
            .square-6 { right: 330px; }
            .square-7 { right: 380px; }
            .square-8 { right: 430px; }
            .square-9 { right: 480px; }

            .control-button {
                padding: 12px 24px;
                font-size: 1rem;
                margin: 8px;
            }

            .players-info {
                grid-template-columns: 1fr;
            }

            /* أدوات التحكم للأجهزة المحمولة */
            .control-group {
                grid-template-columns: 1fr;
            }

            .game-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                min-width: auto;
            }

            /* واجهة اختيار اللاعبين للأجهزة المحمولة */
            .smart-features {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }

            .feature-card {
                padding: 15px;
            }

            .feature-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                margin-bottom: 10px;
            }

            .search-and-sort {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .students-interactive-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 10px;
                padding: 0 15px;
            }

            .student-interactive-card {
                padding: 15px;
            }

            .student-avatar {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
                margin-bottom: 10px;
            }

            .selected-players-list {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }

            .selection-actions {
                flex-direction: column;
                gap: 10px;
            }

            .action-btn {
                width: 100%;
                min-width: auto;
            }

            .mode-switcher {
                flex-direction: column;
                gap: 8px;
            }

            .mode-btn {
                min-width: auto;
            }

            /* واجهة اختيار الطلاب للأجهزة المحمولة */
            .selection-controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .mode-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .player-selectors {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .students-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
            }

            .student-card {
                padding: 10px;
                font-size: 0.9rem;
            }

            .selection-actions {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                padding: 20px;
            }

            .game-title h1 {
                font-size: 1.5rem;
            }

            .corner-square {
                width: 60px;
                height: 60px;
            }

            .side-square {
                width: 40px;
                height: 60px;
            }

            .board-square {
                font-size: 0.5rem;
                padding: 2px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
                top: 10px;
            }

            #returnToIndex {
                right: 10px;
            }

            #soundToggle {
                right: 60px;
            }

            .student-selection-container {
                padding: 15px;
            }

            .students-grid {
                grid-template-columns: 1fr;
                max-height: 300px;
            }
        }

        /* تأثيرات مثيرة للمونوبولي */
        @keyframes landingEffect {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 215, 0, 0.3); }
            100% { transform: scale(1); box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
        }

        .landing-effect {
            animation: landingEffect 1s ease-out;
        }

        @keyframes cardSlideIn {
            0% { 
                transform: translateY(-100vh) rotateX(90deg);
                opacity: 0;
            }
            50% {
                transform: translateY(0) rotateX(45deg);
                opacity: 0.7;
            }
            100% { 
                transform: translateY(0) rotateX(0deg);
                opacity: 1;
            }
        }

        @keyframes cardSlideOut {
            0% { 
                transform: translateY(0) rotateX(0deg) scale(1);
                opacity: 1;
            }
            100% { 
                transform: translateY(-50px) rotateX(-15deg) scale(0.9);
                opacity: 0;
            }
        }

        .card-modal {
            perspective: 1000px;
            backdrop-filter: blur(5px);
        }

        .card-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 20px;
            border: 3px solid;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            max-width: 450px;
            transform-style: preserve-3d;
            color: white;
        }

        .card-content h2 {
            color: white !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .card-text {
            font-size: 1.3em;
            margin: 20px 0;
            padding: 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            border-left: 5px solid #ffd700;
            color: #ffffff;
            font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }

        .card-player {
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #2c3e50;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.2em;
            text-shadow: none;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .btn-execute {
            padding: 15px 35px;
            border: none;
            border-radius: 30px;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
        }

        .btn-execute:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .purchase-modal {
            backdrop-filter: blur(10px);
        }

        .purchase-content {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            max-width: 450px;
            border: 3px solid #28a745;
        }

        .property-details {
            background: rgba(40, 167, 69, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }

        .property-details p {
            margin: 10px 0;
            font-weight: 500;
        }

        .purchase-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn-purchase, .btn-decline {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .btn-purchase {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-decline {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-purchase:hover, .btn-decline:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse-effect {
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }

        .message-achievement {
            background: linear-gradient(135deg, #FFD700, #FFA500) !important;
            border-left: 5px solid #FF8C00 !important;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4) !important;
        }

        .message-success {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3) !important;
        }

        .message-error {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3) !important;
        }

        .game-board {
            position: relative;
            overflow: visible;
        }

        /* تحسينات إضافية للبطاقات */
        .card-modal .card-content[style*="border-color: #e74c3c"] {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            box-shadow: 0 25px 50px rgba(231, 76, 60, 0.4);
        }

        .card-modal .card-content[style*="border-color: #3498db"] {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            box-shadow: 0 25px 50px rgba(52, 152, 219, 0.4);
        }

        .card-content .card-text {
            text-align: center;
            line-height: 1.6;
            letter-spacing: 0.5px;
        }

        .card-content .card-text p {
            margin: 0;
            color: white !important;
            font-size: 1.1em;
        }

        .btn-execute:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }

        .btn-execute:active {
            transform: translateY(-2px) scale(1.02);
        }

        /* تحسينات العقارات القابلة للشراء */
        .property-square.available {
            animation: availableProperty 2s infinite;
        }

        @keyframes availableProperty {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
                border-color: #2ecc71;
            }
            50% { 
                box-shadow: 0 0 0 8px rgba(46, 204, 113, 0.3);
                border-color: #27ae60;
            }
        }

        .property-square.owned {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: 3px solid #c0392b;
        }

        .property-square.owned::after {
            content: "مملوك";
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        /* تحسين نافذة الشراء */
        .purchase-content h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .property-details {
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #27ae60;
        }

        .property-details p {
            margin: 8px 0;
            font-weight: 600;
            color: #2c3e50;
        }

        /* تحسينات بطاقة اللاعب الحالي */
        .player-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: #2c3e50;
        }

        .player-card h3 {
            color: #2c3e50 !important;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .player-card .stats-grid {
            color: #34495e !important;
        }

        .player-card .stats-grid .stat-label {
            color: #7f8c8d !important;
            font-weight: 600;
        }

        .player-card .stats-grid .stat-value {
            color: #2c3e50 !important;
            font-weight: bold;
        }

        /* إضافة تنسيق للنصوص الأخرى في البطاقة */
        .player-card .player-info {
            color: #2c3e50 !important;
        }

        .player-card .player-position-indicator {
            color: #34495e !important;
            font-weight: bold !important;
        }

        .player-card .stat-item div {
            color: #2c3e50 !important;
        }

        .player-card .stat-item div:last-child {
            color: #7f8c8d !important;
        }

        /* تأكد من وضوح النصوص في البطاقة النشطة */
        .player-card.current-player .stat-item div {
            color: #fff !important;
        }

        .player-card.current-player .stat-item div:last-child {
            color: #ecf0f1 !important;
        }

        .player-card.current-player .player-info {
            color: #fff !important;
        }

        .player-card.current-player .player-position-indicator {
            color: #ecf0f1 !important;
        }

        /* تنسيق البطاقة المفلسة */
        .player-card.bankrupt-player {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6) !important;
            opacity: 0.6 !important;
            border: 3px solid #e74c3c !important;
            filter: grayscale(80%) !important;
            position: relative;
        }

        .player-card.bankrupt-player::after {
            content: "💔 مُفلِس";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
            border: 2px solid #c0392b;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .player-card.bankrupt-player h3,
        .player-card.bankrupt-player .stat-item div,
        .player-card.bankrupt-player .player-info {
            color: #7f8c8d !important;
        }

        .player-card.current-player {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5, #667eea);
            border: 4px solid #fff;
            box-shadow: 0 0 40px rgba(0, 210, 255, 0.8), 0 0 80px rgba(58, 123, 213, 0.5);
            transform: scale(1.1);
            animation: currentPlayerPulse 2s infinite, bounce 1.5s ease-in-out infinite;
            z-index: 1000;
            position: relative;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* تأثير للبطاقات الأخرى */
        .player-card:not(.current-player) {
            opacity: 0.75;
            transform: scale(0.95);
            transition: all 0.6s ease;
            filter: grayscale(15%) brightness(0.9);
        }

        .player-card:not(.current-player):hover {
            opacity: 0.9;
            transform: scale(1);
            filter: grayscale(0%) brightness(1);
        }

        @keyframes currentPlayerPulse {
            0%, 100% { 
                box-shadow: 0 0 40px rgba(0, 210, 255, 0.8), 0 0 80px rgba(58, 123, 213, 0.5);
                border-color: #fff;
            }
            50% { 
                box-shadow: 0 0 60px rgba(0, 210, 255, 1), 0 0 120px rgba(58, 123, 213, 0.8);
                border-color: #00d2ff;
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: scale(1.1) translateY(0);
            }
            40% {
                transform: scale(1.12) translateY(-5px);
            }
            60% {
                transform: scale(1.12) translateY(-3px);
            }
        }

        @keyframes floatDown {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-30px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes glow {
            0% {
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            }
            100% {
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 30px rgba(255, 107, 107, 0.6);
            }
        }

        .player-card.current-player::before {
            content: "🎯 الدور الآن";
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ff6b6b, #ffa500, #ff6b6b);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            animation: floatDown 1s ease-out, glow 2s ease-in-out infinite alternate;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
            z-index: 1001;
            border: 2px solid white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        @keyframes borderRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .player-card.current-player h3 {
            color: #fff;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            font-size: 1.4em;
            animation: textGlow 2s ease-in-out infinite alternate;
        }

        @keyframes textGlow {
            0% {
                text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            }
            100% {
                text-shadow: 2px 2px 4px rgba(0,0,0,0.7), 0 0 15px rgba(255,255,255,0.6);
            }
        }

        @keyframes infoGlow {
            0% {
                box-shadow: 0 10px 30px rgba(0, 210, 255, 0.4);
            }
            100% {
                box-shadow: 0 15px 40px rgba(0, 210, 255, 0.7), 0 0 60px rgba(58, 123, 213, 0.3);
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        /* أنماط البطاقات المحسّنة */
        .student-card.interactive.enhanced {
            position: relative;
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid #e9ecef;
            overflow: hidden;
            min-height: 200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-card.interactive.enhanced:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .student-card.interactive.enhanced.selected {
            border-color: #4CAF50;
            background: linear-gradient(145deg, #f8fff8, #ffffff);
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
        }

        .card-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            opacity: 0.1;
            z-index: 0;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .student-avatar-enhanced {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .avatar-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b35;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.4);
        }

        .selection-indicator {
            position: relative;
        }

        .selection-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .student-card.selected .selection-circle {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            transform: scale(1.1);
        }

        .card-content {
            text-align: center;
            margin: 15px 0;
            position: relative;
            z-index: 1;
        }

        .student-name-enhanced {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 8px 0;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .student-meta {
            color: #6c757d;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .card-footer {
            position: relative;
            z-index: 1;
            margin-top: auto;
        }

        .action-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #495057;
        }

        .student-card.selected .action-button {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }

        .action-text {
            font-weight: 500;
        }

        .action-icon {
            font-size: 12px;
        }

        .card-effects {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            border-radius: inherit;
            overflow: hidden;
        }

        .ripple-effect {
            position: absolute;
            background: rgba(76, 175, 80, 0.3);
            border-radius: 50%;
            transform: scale(0);
            pointer-events: none;
        }

        .ripple-effect.animate {
            animation: rippleAnimation 0.6s ease-out;
        }

        @keyframes rippleAnimation {
            to {
                transform: scale(1);
                opacity: 0;
            }
        }

        .success-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #4CAF50;
            display: none;
            align-items: center;
            justify-content: center;
            animation: successPop 1s ease-out;
        }

        @keyframes successPop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        @keyframes cardShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes bounceIn {
            0% {
                transform: translate(-50%, -50%) scale(0.3);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        .game-ready-notification {
            font-family: 'Cairo', sans-serif;
        }

        .notification-content {
            text-align: center;
        }

        .notification-icon {
            font-size: 48px;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        .notification-text h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .notification-text p {
            margin: 0 0 15px 0;
            opacity: 0.9;
        }

        .ready-players {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin: 15px 0;
        }

        .ready-player {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .notification-start-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .notification-start-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* أنماط اختيار عدد اللاعبين المحسّن */
        .players-count-selector {
            margin-top: 10px;
        }

        .players-count-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .player-count-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .player-count-option:hover {
            border-color: #007bff;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
        }

        .player-count-option.selected {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            transform: scale(1.05);
        }

        .player-count-option.selected::before {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 8px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .option-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .option-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }

        .option-number {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .player-count-option.selected .option-label,
        .player-count-option.selected .option-number {
            color: #155724;
        }

        /* تنسيق نافذة السجن */
        .jail-modal {
            animation: fadeIn 0.3s ease-out;
        }

        .jail-content {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 90%;
            border: 3px solid #e74c3c;
        }

        .jail-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .jail-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .jail-btn-try {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .jail-btn-try:hover {
            background: linear-gradient(45deg, #2980b9, #1f639b);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .jail-btn-pay {
            background: linear-gradient(45deg, #e67e22, #d35400);
            color: white;
        }

        .jail-btn-pay:hover {
            background: linear-gradient(45deg, #d35400, #bf4f00);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(230, 126, 34, 0.4);
        }

        .jail-btn small {
            display: block;
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }

        /* تنسيق نوافذ الإفلاس */
        .bankruptcy-modal {
            animation: bankruptcySlideIn 0.5s ease-out;
        }

        .bankruptcy-content {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            max-width: 600px;
            width: 90%;
            border: 3px solid #e74c3c;
        }

        .bankruptcy-header h2 {
            margin: 0 0 10px 0;
            font-size: 2em;
        }

        .bankruptcy-warning {
            background: rgba(231, 76, 60, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e74c3c;
            font-weight: bold;
        }

        .bankruptcy-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        .debt-info, .assets-info, .current-money {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .debt-amount, .assets-amount, .money-amount {
            font-weight: bold;
            font-size: 1.2em;
        }

        .debt-amount {
            color: #e74c3c;
        }

        .assets-amount {
            color: #f39c12;
        }

        .money-amount.negative {
            color: #e74c3c;
        }

        .bankruptcy-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .bankruptcy-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sell-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .sell-btn:hover {
            background: linear-gradient(45deg, #e67e22, #d35400);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4);
        }

        .bankrupt-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .bankrupt-btn:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .bankruptcy-btn small {
            display: block;
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .bankruptcy-help {
            background: rgba(52, 152, 219, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 2px solid #3498db;
            font-size: 14px;
        }

        @keyframes bankruptcySlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        @keyframes bankruptcyExplosion {
            0% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.5); 
            }
            20% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.2); 
            }
            80% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.8); 
            }
        }

        .current-player-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }

        .player-turn-status {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .player-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .action-hint {
            background: rgba(52, 152, 219, 0.1);
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #2c3e50;
            font-weight: 600;
            animation: hintBlink 2s infinite;
        }

        @keyframes hintBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .player-stats-enhanced {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .current-player .stat-item {
            background: rgba(255,255,255,0.9);
            border-left-color: #e74c3c;
        }

        .player-position-indicator {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-top: 5px;
            display: inline-block;
        }

        /* لوحة القيادة المحترفة */
        .leaderboard-header {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }

        .leaderboard-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }

        .leaderboard-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .leaderboard-player {
            background: white;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .leaderboard-player.first {
            border-color: #FFD700;
            background: linear-gradient(135deg, #fff9e6, #fff);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.2);
        }

        .leaderboard-player.second {
            border-color: #C0C0C0;
            background: linear-gradient(135deg, #f8f9fa, #fff);
        }

        .leaderboard-player.third {
            border-color: #CD7F32;
            background: linear-gradient(135deg, #fdf7f0, #fff);
        }

        .leaderboard-player.other {
            border-color: #6c757d;
        }

        .leaderboard-player.current-player {
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(0, 123, 255, 0.3);
            border-color: #007bff;
        }

        .leaderboard-player::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #0056b3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .leaderboard-player.current-player::before {
            opacity: 1;
        }

        .player-rank {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .rank-emoji {
            font-size: 2em;
        }

        .rank-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #666;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .player-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            color: #333;
        }

        .stat-value.total-worth {
            color: #28a745;
            font-size: 1.1em;
        }

        .player-achievements {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .achievement {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        }

        @media (max-width: 768px) {
            .player-stats {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-stats {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>

<body>
    <!-- أزرار التحكم العلوية المحسّنة -->
    <div class="top-controls-panel">
        <button id="returnToIndex" class="control-btn" title="العودة للصفحة الرئيسية">
            <i class="fas fa-home"></i>
        </button>
        <button id="soundToggle" class="control-btn" title="تشغيل/إيقاف الصوت">
            <i class="fas fa-volume-up"></i>
        </button>
        <button id="fullscreenToggle" class="control-btn" title="ملء الشاشة">
            <i class="fas fa-expand"></i>
        </button>
        <button id="gameInfo" class="control-btn" title="معلومات اللعبة">
            <i class="fas fa-info-circle"></i>
        </button>
    </div>

    <!-- الحاوية الرئيسية -->
    <div class="monopoly-container">
        <!-- العنوان الرئيسي -->
        <div class="game-title">
            <h1><i class="fas fa-building"></i> مونوبولي سلطنة عُمان</h1>
            <p>لعبة العقارات العُمانية التعليمية - استكشف معالم سلطنة عُمان الجميلة</p>
        </div>

        <!-- لوحة اللعبة -->
        <div class="game-board" id="gameBoard">
            <!-- مربعات اللوحة سيتم إنشاؤها بواسطة JavaScript -->
        </div>

        <!-- أدوات التحكم الرئيسية -->
        <div class="game-controls">
            <div class="control-group">
                <div class="form-group">
                    <label for="classSelect">📚 اختيار الصف</label>
                    <select id="classSelect" class="form-control">
                        <option value="">اختر الصف الدراسي</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="playersCount">👥 عدد اللاعبين</label>
                    <div class="players-count-selector">
                        <div class="players-count-options">
                            <div class="player-count-option" data-count="2">
                                <div class="option-icon">👥</div>
                                <div class="option-label">لاعبان</div>
                                <div class="option-number">2</div>
                            </div>
                            <div class="player-count-option" data-count="3">
                                <div class="option-icon">👥👤</div>
                                <div class="option-label">ثلاثة</div>
                                <div class="option-number">3</div>
                            </div>
                            <div class="player-count-option" data-count="4">
                                <div class="option-icon">👥👥</div>
                                <div class="option-label">أربعة</div>
                                <div class="option-number">4</div>
                            </div>
                            <div class="player-count-option" data-count="5">
                                <div class="option-icon">👥👥👤</div>
                                <div class="option-label">خمسة</div>
                                <div class="option-number">5</div>
                            </div>
                            <div class="player-count-option" data-count="6">
                                <div class="option-icon">👥👥👥</div>
                                <div class="option-label">ستة</div>
                                <div class="option-number">6</div>
                            </div>
                        </div>
                    </div>
                    <select id="playersCount" class="form-control" style="display: none;">
                        <option value="2">👥 لاعبان</option>
                        <option value="3">👥👤 ثلاثة لاعبين</option>
                        <option value="4">👥👥 أربعة لاعبين</option>
                        <option value="5">👥👥👤 خمسة لاعبين</option>
                        <option value="6">👥👥👥 ستة لاعبين</option>
                    </select>
                </div>
            </div>

            <!-- أزرار بدء اللعبة -->
            <div class="game-buttons">
                <button id="setupPlayersBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-users-cog"></i>
                    ⚙️ إعداد اللاعبين
                </button>
                <button id="startGameBtn" class="btn btn-success" disabled>
                    <i class="fas fa-play"></i>
                    🎲 بدء اللعبة
                </button>
                <button id="rollDice" class="btn btn-warning" disabled>
                    <i class="fas fa-dice"></i>
                    🎲 رمي النرد
                </button>
                <button id="endTurn" class="btn btn-info" disabled>
                    <i class="fas fa-exchange-alt"></i>
                    🔄 إنهاء الدور
                </button>
                <button id="showRules" class="btn btn-secondary">
                    <i class="fas fa-book"></i>
                    📖 قواعد اللعبة
                </button>
                <button id="testCards" class="btn btn-secondary" onclick="testCardDemo()">
                    <i class="fas fa-vial"></i>
                    🧪 اختبار البطاقات
                </button>
                <button id="testJail" class="btn btn-secondary" onclick="testJailDemo()">
                    <i class="fas fa-building"></i>
                    🏛️ اختبار السجن
                </button>
                <button id="testBankruptcy" class="btn btn-secondary" onclick="testBankruptcyDemo()">
                    <i class="fas fa-exclamation-triangle"></i>
                    💔 اختبار الإفلاس
                </button>
            </div>
        </div>

        <!-- واجهة اختيار اللاعبين المبسطة -->
        <div class="smart-player-selection" id="smartPlayerSelection" style="display: none;">
            <div class="selection-header">
                <div class="header-content">
                    <div class="icon-wrapper">
                        <i class="fas fa-users"></i>
                    </div>
                    <h2>اختيار اللاعبين</h2>
                    <p class="subtitle">انقر على الطلاب لاختيارهم في اللعبة</p>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="selectionProgress"></div>
                </div>
                <div class="selection-counter">
                    <span class="selected-count" id="selectedPlayersCount">0</span>
                    <span class="separator">/</span>
                    <span class="total-count" id="totalPlayersNeeded">2</span>
                    <span class="label">لاعبين محددين</span>
                </div>
            </div>

            <!-- شبكة الطلاب التفاعلية -->
            <div class="students-interactive-grid" id="studentsInteractiveGrid">
                <!-- سيتم ملؤها بواسطة JavaScript -->
            </div>

            <!-- عرض اللاعبين المختارين -->
            <div class="selected-players-preview" id="selectedPlayersPreview">
                <h3>
                    <i class="fas fa-check-circle"></i>
                    اللاعبون المختارون
                </h3>
                <div class="selected-players-list" id="selectedPlayersList">
                    <div class="empty-state">
                        <i class="fas fa-user-plus"></i>
                        <p>انقر على الطلاب لاختيارهم</p>
                    </div>
                </div>
            </div>

            <!-- أزرار التحكم -->
            <div class="selection-actions">
                <button class="action-btn secondary" id="clearSelection">
                    <i class="fas fa-undo"></i>
                    إعادة تعيين
                </button>
                <button class="action-btn primary" id="confirmPlayerSelection" disabled>
                    <i class="fas fa-check"></i>
                    تأكيد الاختيار
                </button>
                <button class="action-btn danger" id="cancelPlayerSelection">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>

        <!-- معلومات اللاعبين -->
        <div class="players-info" id="playersInfo">
            <!-- معلومات اللاعبين سيتم إنشاؤها بواسطة JavaScript -->
        </div>
    </div>

    <!-- النوافذ المنبثقة -->
    <!-- نافذة قواعد اللعبة -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <span class="close" data-modal="rulesModal">&times;</span>
            <h2><i class="fas fa-book"></i> قواعد لعبة مونوبولي عُمان</h2>
            <div style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
                <h3>🎯 الهدف من اللعبة:</h3>
                <p>شراء العقارات العُمانية وتطويرها لتحقيق أكبر ربح ممكن.</p>
                
                <h3>🎲 كيفية اللعب:</h3>
                <ul>
                    <li>كل لاعب يبدأ بمبلغ 1500 ريال عُماني</li>
                    <li>ارمي النرد وتحرك على اللوحة</li>
                    <li>اشتر العقارات التي تهبط عليها</li>
                    <li>اجمع الإيجار من اللاعبين الآخرين</li>
                    <li>طور عقاراتك لزيادة الإيجار</li>
                </ul>
                
                <h3>🏠 أنواع المربعات:</h3>
                <ul>
                    <li><strong>العقارات:</strong> يمكن شراؤها وتطويرها</li>
                    <li><strong>المحطات:</strong> شركات النقل العُمانية</li>
                    <li><strong>المرافق:</strong> الكهرباء والمياه</li>
                    <li><strong>الضرائب:</strong> ادفع المبلغ المحدد</li>
                    <li><strong>الفرصة والصندوق:</strong> اسحب بطاقة</li>
                </ul>
                
                <h3>🏆 الفوز:</h3>
                <p>آخر لاعب يبقى في اللعبة (لم يفلس) يكون الفائز!</p>
            </div>
        </div>
    </div>

    <!-- نافذة معلومات العقار -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <span class="close" data-modal="propertyModal">&times;</span>
            <div id="propertyInfo">
                <!-- معلومات العقار سيتم عرضها هنا -->
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ===========================================
        // بيانات اللعبة الأساسية
        // ===========================================
        
        // بيانات العقارات العُمانية
        const omanProperties = [
            // الصف السفلي
            { id: 0, name: "البداية", type: "start", price: 0, color: "special" },
            { id: 1, name: "صحار", type: "property", price: 60, color: "brown", rent: [2, 10, 30, 90, 160, 250] },
            { id: 2, name: "صندوق المجتمع", type: "community", price: 0, color: "special" },
            { id: 3, name: "الرستاق", type: "property", price: 60, color: "brown", rent: [4, 20, 60, 180, 320, 450] },
            { id: 4, name: "ضريبة الدخل", type: "tax", price: 200, color: "special" },
            { id: 5, name: "مطار مسقط", type: "airport", price: 200, color: "railroad", rent: [25, 50, 100, 200] },
            { id: 6, name: "مطرح", type: "property", price: 100, color: "light-blue", rent: [6, 30, 90, 270, 400, 550] },
            { id: 7, name: "الفرصة", type: "chance", price: 0, color: "special" },
            { id: 8, name: "الخوير", type: "property", price: 100, color: "light-blue", rent: [6, 30, 90, 270, 400, 550] },
            { id: 9, name: "القرم", type: "property", price: 120, color: "light-blue", rent: [8, 40, 100, 300, 450, 600] },
            
            // الصف الأيسر
            { id: 10, name: "السجن/الزيارة", type: "jail", price: 0, color: "special" },
            { id: 11, name: "صلالة", type: "property", price: 140, color: "pink", rent: [10, 50, 150, 450, 625, 750] },
            { id: 12, name: "شركة الكهرباء", type: "utility", price: 150, color: "utility", rent: [4, 10] },
            { id: 13, name: "طاقة", type: "property", price: 140, color: "pink", rent: [10, 50, 150, 450, 625, 750] },
            { id: 14, name: "مرباط", type: "property", price: 160, color: "pink", rent: [12, 60, 180, 500, 700, 900] },
            { id: 15, name: "مطار صلالة", type: "airport", price: 200, color: "railroad", rent: [25, 50, 100, 200] },
            { id: 16, name: "نزوى", type: "property", price: 180, color: "orange", rent: [14, 70, 200, 550, 750, 950] },
            { id: 17, name: "صندوق المجتمع", type: "community", price: 0, color: "special" },
            { id: 18, name: "بهلا", type: "property", price: 180, color: "orange", rent: [14, 70, 200, 550, 750, 950] },
            { id: 19, name: "الحمراء", type: "property", price: 200, color: "orange", rent: [16, 80, 220, 600, 800, 1000] },
            
            // الصف العلوي
            { id: 20, name: "موقف مجاني", type: "free", price: 0, color: "special" },
            { id: 21, name: "صور", type: "property", price: 220, color: "red", rent: [18, 90, 250, 700, 875, 1050] },
            { id: 22, name: "الفرصة", type: "chance", price: 0, color: "special" },
            { id: 23, name: "الكامل والوافي", type: "property", price: 220, color: "red", rent: [18, 90, 250, 700, 875, 1050] },
            { id: 24, name: "جعلان بني بوعلي", type: "property", price: 240, color: "red", rent: [20, 100, 300, 750, 925, 1100] },
            { id: 25, name: "مطار صور", type: "airport", price: 200, color: "railroad", rent: [25, 50, 100, 200] },
            { id: 26, name: "الخابورة", type: "property", price: 260, color: "yellow", rent: [22, 110, 330, 800, 975, 1150] },
            { id: 27, name: "السويق", type: "property", price: 260, color: "yellow", rent: [22, 110, 330, 800, 975, 1150] },
            { id: 28, name: "شركة المياه", type: "utility", price: 150, color: "utility", rent: [4, 10] },
            { id: 29, name: "شناص", type: "property", price: 280, color: "yellow", rent: [24, 120, 360, 850, 1025, 1200] },
            
            // الصف الأيمن
            { id: 30, name: "اذهب للسجن", type: "go-to-jail", price: 0, color: "special" },
            { id: 31, name: "إبراء", type: "property", price: 300, color: "green", rent: [26, 130, 390, 900, 1100, 1275] },
            { id: 32, name: "القابل", type: "property", price: 300, color: "green", rent: [26, 130, 390, 900, 1100, 1275] },
            { id: 33, name: "صندوق المجتمع", type: "community", price: 0, color: "special" },
            { id: 34, name: "بدية", type: "property", price: 320, color: "green", rent: [28, 150, 450, 1000, 1200, 1400] },
            { id: 35, name: "مطار الدقم", type: "airport", price: 200, color: "railroad", rent: [25, 50, 100, 200] },
            { id: 36, name: "الفرصة", type: "chance", price: 0, color: "special" },
            { id: 37, name: "خصب", type: "property", price: 350, color: "dark-blue", rent: [35, 175, 500, 1100, 1300, 1500] },
            { id: 38, name: "ضريبة الترف", type: "tax", price: 100, color: "special" },
            { id: 39, name: "مسندم", type: "property", price: 400, color: "dark-blue", rent: [50, 200, 600, 1400, 1700, 2000] }
        ];

        // ===========================================
        // متغيرات اللعبة الرئيسية المطورة
        // ===========================================
        let gameState = {
            players: [],
            currentPlayer: 0,
            gameStarted: false,
            soundEnabled: true,
            turn: 1,
            doubles: 0,
            lastRoll: { dice1: 0, dice2: 0, total: 0 },
            gameMode: 'competitive', // تنافسي
            animations: true,
            leaderboard: [],
            achievements: {},
            gameHistory: []
        };

        let playerData = {};

        // ===========================================
        // أنظمة اللعبة الأساسية
        // ===========================================
        
        // نظام الصوت الاحترافي
        class SoundSystem {
            constructor() {
                this.sounds = {
                    dice: new Audio('../assets/media/sounds/Click.mp3'),
                    buy: new Audio('../assets/media/sounds/Notification.mp3'),
                    money: new Audio('../assets/media/sounds/select.mp3'),
                    win: new Audio('../assets/media/sounds/win.mp3'),
                    lose: new Audio('../assets/media/sounds/wrong_answer.mp3'),
                    select: new Audio('../assets/media/sounds/select.mp3'),
                    achievement: new Audio('../assets/media/sounds/kingdom-sounds/achievement-unlock.mp3'),
                    victory: new Audio('../assets/media/sounds/kingdom-sounds/battle-victory.mp3'),
                    bonus: new Audio('../assets/media/sounds/kingdom-sounds/bonus-collect.mp3'),
                    countdown: new Audio('../assets/media/sounds/kingdom-sounds/countdown-tick.mp3'),
                    explosion: new Audio('../assets/media/sounds/kingdom-sounds/cosmic-explosion.mp3'),
                    cheer: new Audio('../assets/media/sounds/kingdom-sounds/crowd-cheer.mp3'),
                    bell: new Audio('../assets/media/sounds/kingdom-sounds/ancient-bell.mp3')
                };
                this.enabled = true;
                this.volume = 0.7;
                this.setupVolume();
            }

            setupVolume() {
                Object.values(this.sounds).forEach(sound => {
                    sound.volume = this.volume;
                });
            }

            play(soundName, volume = 1.0) {
                if (this.enabled && this.sounds[soundName]) {
                    const sound = this.sounds[soundName];
                    sound.volume = this.volume * volume;
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log('خطأ في تشغيل الصوت:', e));
                }
            }

            playSequence(sounds, delay = 500) {
                sounds.forEach((sound, index) => {
                    setTimeout(() => this.play(sound), index * delay);
                });
            }

            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }

            setVolume(volume) {
                this.volume = Math.max(0, Math.min(1, volume));
                this.setupVolume();
            }
        }

        // نظام الرسائل الاحترافي
        class MessageSystem {
            static show(message, type = 'info', duration = 3000, isImportant = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `game-message ${type} ${isImportant ? 'important' : ''}`;
                
                // إضافة أيقونات للرسائل
                const icons = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️',
                    money: '💰',
                    achievement: '🏆',
                    dice: '🎲'
                };
                
                const icon = icons[type] || icons.info;
                messageDiv.innerHTML = `<span class="message-icon">${icon}</span><span class="message-text">${message}</span>`;
                
                messageDiv.style.cssText = `
                    position: fixed;
                    top: ${isImportant ? '50%' : '100px'};
                    ${isImportant ? 'left: 50%; transform: translateX(-50%) translateY(-50%);' : 'right: 20px;'}
                    background: ${isImportant ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'var(--surface-glass)'};
                    color: white;
                    padding: ${isImportant ? '25px 35px' : '15px 20px'};
                    border-radius: var(--border-radius-medium);
                    border: 2px solid var(--oman-${type === 'error' ? 'red' : 'green'});
                    backdrop-filter: blur(16px);
                    box-shadow: ${isImportant ? '0 20px 40px rgba(0,0,0,0.3)' : 'var(--shadow-medium)'};
                    z-index: ${isImportant ? '10002' : '10001'};
                    animation: ${isImportant ? 'bounceIn' : 'slideInRight'} 0.5s ease-out;
                    font-weight: 600;
                    font-size: ${isImportant ? '18px' : '14px'};
                    max-width: ${isImportant ? '400px' : '300px'};
                    text-align: center;
                `;

                document.body.appendChild(messageDiv);

                // تأثير خاص للرسائل المهمة
                if (isImportant) {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }

                setTimeout(() => {
                    messageDiv.style.animation = isImportant ? 'bounceOut 0.5s ease-in' : 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, isImportant ? 500 : 300);
                }, duration);
            }

            static showTurnAnnouncement(playerName, turnNumber) {
                this.show(`🎯 دور ${playerName} - الجولة ${turnNumber}`, 'info', 4000, true);
            }

            static showMoneyTransaction(player, amount, isReceiving = true) {
                const action = isReceiving ? 'حصل على' : 'دفع';
                const icon = isReceiving ? '💰⬆️' : '💰⬇️';
                this.show(`${icon} ${player} ${action} ${Math.abs(amount)} ر.ع`, 'money', 3000);
            }

            static showPropertyPurchase(player, property, price) {
                this.show(`🏠 ${player} اشترى ${property} مقابل ${price} ر.ع`, 'success', 4000);
            }

            static showRentPayment(payer, receiver, property, amount) {
                this.show(`🏘️ ${payer} دفع ${amount} ر.ع إيجار ${property} لـ ${receiver}`, 'warning', 4000);
            }

            static clear() {
                // إزالة جميع الرسائل الحالية
                const messages = document.querySelectorAll('.game-message');
                messages.forEach(message => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                });
            }
        }

        // إنشاء الأنظمة
        const soundSystem = new SoundSystem();

        // ===========================================
        // نظام الإنجازات والقيادة
        // ===========================================
        class AchievementSystem {
            static achievements = {
                'first_property': { name: 'أول عقار', description: 'اشتر أول عقار لك', icon: '🏠', unlocked: false },
                'monopoly_master': { name: 'سيد الاحتكار', description: 'امتلك مجموعة كاملة', icon: '👑', unlocked: false },
                'millionaire': { name: 'المليونير', description: 'احصل على 2000 ر.ع', icon: '💎', unlocked: false },
                'lucky_roller': { name: 'محظوظ النرد', description: 'احصل على زوجي 3 مرات متتالية', icon: '🎲', unlocked: false },
                'rent_collector': { name: 'جامع الإيجارات', description: 'اجمع 500 ر.ع من الإيجارات', icon: '💰', unlocked: false },
                'speed_buyer': { name: 'مشتري سريع', description: 'اشتر 3 عقارات في 3 أدوار', icon: '⚡', unlocked: false }
            };

            static checkAchievement(player, type, data = {}) {
                const playerId = player.name;
                if (!gameState.achievements[playerId]) {
                    gameState.achievements[playerId] = {};
                }

                switch (type) {
                    case 'first_property':
                        if (player.properties.length === 1 && !gameState.achievements[playerId].first_property) {
                            this.unlockAchievement(playerId, 'first_property');
                        }
                        break;
                    case 'millionaire':
                        if (player.money >= 2000 && !gameState.achievements[playerId].millionaire) {
                            this.unlockAchievement(playerId, 'millionaire');
                        }
                        break;
                    case 'monopoly_master':
                        if (this.hasMonopoly(player) && !gameState.achievements[playerId].monopoly_master) {
                            this.unlockAchievement(playerId, 'monopoly_master');
                        }
                        break;
                    case 'lucky_roller':
                        if (data.consecutiveDoubles >= 3 && !gameState.achievements[playerId].lucky_roller) {
                            this.unlockAchievement(playerId, 'lucky_roller');
                        }
                        break;
                }
            }

            static unlockAchievement(playerId, achievementId) {
                gameState.achievements[playerId][achievementId] = true;
                const achievement = this.achievements[achievementId];
                
                MessageSystem.show(`🏆 ${playerId} حصل على إنجاز: ${achievement.name}!`, 'achievement', 5000, true);
                soundSystem.play('achievement');
                
                // تأثير خاص للإنجاز
                confetti({
                    particleCount: 150,
                    spread: 120,
                    origin: { y: 0.6 },
                    colors: ['#FFD700', '#FFA500', '#FF6347']
                });
            }

            static hasMonopoly(player) {
                const colorGroups = {};
                player.properties.forEach(propId => {
                    const prop = omanProperties[propId];
                    if (prop.type === 'property') {
                        if (!colorGroups[prop.color]) colorGroups[prop.color] = 0;
                        colorGroups[prop.color]++;
                    }
                });

                const monopolyCounts = {
                    'brown': 2, 'light-blue': 3, 'pink': 3, 'orange': 3,
                    'red': 3, 'yellow': 3, 'green': 3, 'dark-blue': 2
                };

                return Object.keys(colorGroups).some(color => 
                    colorGroups[color] === monopolyCounts[color]
                );
            }
        }

        // نظام اللوحة القيادية المحترف
        class LeaderboardSystem {
            static updateLeaderboard() {
                const leaderboardDiv = document.getElementById('leaderboard');
                if (!leaderboardDiv) return;

                // حساب القيمة الصافية لكل لاعب
                const playersWithNetWorth = gameState.players.map((player, index) => {
                    // التحقق من صحة بيانات اللاعب
                    validatePlayerData(player);
                    
                    const propertyValue = this.calculatePropertyValue(player);
                    const netWorth = (player.money || 0) + propertyValue;
                    
                    return {
                        ...player,
                        index,
                        propertyValue,
                        netWorth,
                        propertiesCount: player.properties ? player.properties.length : 0
                    };
                });

                // ترتيب اللاعبين حسب القيمة الصافية
                playersWithNetWorth.sort((a, b) => b.netWorth - a.netWorth);

                // إنشاء HTML للوحة القيادية
                leaderboardDiv.innerHTML = `
                    <div class="leaderboard-header">
                        <h3>🏆 لوحة القيادة</h3>
                        <div class="leaderboard-stats">
                            <span>المرحلة: ${gameState.currentRound}</span>
                            <span>اللاعب الحالي: ${gameState.players[gameState.currentPlayer]?.name}</span>
                        </div>
                    </div>
                    <div class="leaderboard-list">
                        ${playersWithNetWorth.map((player, rank) => this.createPlayerCard(player, rank)).join('')}
                    </div>
                `;

                // تحديث الأرقام في بطاقات اللاعبين
                this.updatePlayerCards();
            }

            static calculatePropertyValue(player) {
                if (!player || !player.properties || !Array.isArray(player.properties)) {
                    return 0;
                }
                
                return player.properties.reduce((total, propertyId) => {
                    const property = omanProperties[propertyId];
                    if (property && typeof property.price === 'number') {
                        return total + property.price;
                    }
                    return total;
                }, 0);
            }

            static createPlayerCard(player, rank) {
                const rankEmoji = ['🥇', '🥈', '🥉', '🏅'][rank] || '🏅';
                const rankClass = ['first', 'second', 'third', 'other'][rank] || 'other';
                
                return `
                    <div class="leaderboard-player ${rankClass}" data-player="${player.index}">
                        <div class="player-rank">
                            <span class="rank-emoji">${rankEmoji}</span>
                            <span class="rank-number">#${rank + 1}</span>
                        </div>
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-stats">
                                <div class="stat">
                                    <span class="stat-label">💰 الأموال:</span>
                                    <span class="stat-value">${formatMoney(player.money)}</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">🏠 العقارات:</span>
                                    <span class="stat-value">${formatMoney(player.propertyValue)}</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">📊 القيمة الصافية:</span>
                                    <span class="stat-value total-worth">${formatMoney(player.netWorth)}</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">🏘️ عدد العقارات:</span>
                                    <span class="stat-value">${player.propertiesCount}</span>
                                </div>
                            </div>
                        </div>
                        <div class="player-achievements">
                            ${this.getPlayerAchievements(player)}
                        </div>
                    </div>
                `;
            }

            static getPlayerAchievements(player) {
                const achievements = [];
                
                if (player.properties.length >= 1) {
                    achievements.push('<span class="achievement">🏠 مالك عقار</span>');
                }
                
                if (player.money >= 1000) {
                    achievements.push('<span class="achievement">💰 مليونير</span>');
                }
                
                if (player.properties.length >= 5) {
                    achievements.push('<span class="achievement">🏘️ مطور عقاري</span>');
                }
                
                return achievements.join('');
            }

            static updatePlayerCards() {
                gameState.players.forEach((player, index) => {
                    // التحقق من صحة بيانات اللاعب
                    validatePlayerData(player);
                    
                    const playerElement = document.querySelector(`[data-player="${index}"]`);
                    if (playerElement) {
                        // تحديث المعلومات في بطاقة اللاعب
                        const moneyElement = playerElement.querySelector('.money');
                        if (moneyElement) {
                            moneyElement.textContent = formatMoney(player.money);
                        }
                        
                        const propertiesElement = playerElement.querySelector('.properties-count');
                        if (propertiesElement) {
                            propertiesElement.textContent = player.properties ? player.properties.length : 0;
                        }
                    }
                });
            }

            static highlightCurrentPlayer() {
                // إزالة التمييز من جميع اللاعبين
                document.querySelectorAll('.leaderboard-player').forEach(el => {
                    el.classList.remove('current-player');
                });
                
                // تمييز اللاعب الحالي
                const currentPlayerElement = document.querySelector(`[data-player="${gameState.currentPlayer}"]`);
                if (currentPlayerElement) {
                    currentPlayerElement.classList.add('current-player');
                }
            }

            static calculateNetWorth(player) {
                if (!player || typeof player.money !== 'number') {
                    return 0;
                }
                
                let netWorth = player.money || 0;
                
                if (player.properties && Array.isArray(player.properties)) {
                    player.properties.forEach(propId => {
                        const prop = omanProperties[propId];
                        if (prop && typeof prop.price === 'number') {
                            netWorth += prop.price;
                        }
                    });
                }
                
                return netWorth;
            }

            static showLeaderboard() {
                this.updateLeaderboard();
                const modal = document.getElementById('leaderboardModal');
                const content = document.getElementById('leaderboardContent');
                
                content.innerHTML = gameState.leaderboard.map(entry => `
                    <div class="leaderboard-entry rank-${entry.rank}">
                        <div class="rank">${entry.rank === 1 ? '👑' : entry.rank}</div>
                        <div class="player-name">${entry.name}</div>
                        <div class="net-worth">${entry.netWorth} ر.ع</div>
                        <div class="properties">${entry.properties} عقار</div>
                    </div>
                `).join('');
                
                modal.style.display = 'block';
            }
        }

        // ===========================================
        // نظام تحميل البيانات المبسط والفعال
        // ===========================================
        async function loadStudentData() {
            console.log('🔄 بدء تحميل بيانات الطلاب...');
            MessageSystem.show('جاري تحميل بيانات الطلاب...', 'info', 2000);
            
            try {
                // تحديد المسار الصحيح
                let dataURL;
                if (window.location.hostname.includes('github.io')) {
                    // مسار GitHub Pages
                    const pathParts = window.location.pathname.split('/');
                    const repoName = pathParts[1];
                    dataURL = `/${repoName}/data/studentData.json`;
                } else {
                    // مسار محلي
                    dataURL = '../data/studentData.json';
                }
                
                console.log(`📂 محاولة تحميل من: ${dataURL}`);
                
                const response = await fetch(dataURL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📋 البيانات المحملة:', data);
                
                // تحويل البيانات للتنسيق المطلوب
                const formattedData = {};
                for (const [className, students] of Object.entries(data)) {
                    if (Array.isArray(students) && students.length > 0) {
                        formattedData[className] = students.map((studentName, index) => ({
                            name: studentName,
                            id: `${className.replace(/ /g, '_')}_${index + 1}`,
                            gender: studentName.includes('فاطمة') || studentName.includes('سارة') || 
                                   studentName.includes('نورا') || studentName.includes('عائشة') || 
                                   studentName.includes('مريم') || studentName.includes('هدى') ? 'female' : 'male'
                        }));
                    }
                }
                
                playerData = formattedData;
                const totalStudents = Object.values(data).flat().length;
                const totalClasses = Object.keys(data).length;
                
                console.log(`✅ تم تحميل ${totalStudents} طالب من ${totalClasses} صف`);
                MessageSystem.clear();
                MessageSystem.show(`✅ تم تحميل ${totalStudents} طالب من ${totalClasses} صف`, 'success', 3000);
                
                return true;
                
            } catch (error) {
                console.error('❌ خطأ في تحميل البيانات:', error);
                
                // استخدام البيانات الاحتياطية
                console.log('🔄 تحميل البيانات الاحتياطية...');
                playerData = {
                    "5أ": [
                        { name: "أحمد محمد الشرقي", gender: "male", id: "5أ_1" },
                        { name: "سارة علي البوسعيدي", gender: "female", id: "5أ_2" },
                        { name: "محمد عبدالله الهنائي", gender: "male", id: "5أ_3" },
                        { name: "فاطمة سالم الفارسي", gender: "female", id: "5أ_4" },
                        { name: "يوسف خالد المعمري", gender: "male", id: "5أ_5" }
                    ],
                    "5ب": [
                        { name: "نورا حمد الحارثي", gender: "female", id: "5ب_1" },
                        { name: "سلطان راشد العبري", gender: "male", id: "5ب_2" },
                        { name: "عائشة سعيد الكندي", gender: "female", id: "5ب_3" },
                        { name: "زياد أحمد الرواحي", gender: "male", id: "5ب_4" }
                    ],
                    "6أ": [
                        { name: "مريم يوسف الغافري", gender: "female", id: "6أ_1" },
                        { name: "عبدالرحمن محمد الصالحي", gender: "male", id: "6أ_2" },
                        { name: "هدى سليمان الحبسي", gender: "female", id: "6أ_3" },
                        { name: "طارق فيصل الشحي", gender: "male", id: "6أ_4" }
                    ]
                };
                
                MessageSystem.clear();
                MessageSystem.show('⚠️ تم استخدام البيانات الاحتياطية', 'warning', 3000);
                console.log('✅ تم تحميل البيانات الاحتياطية');
                
                return false;
            }
        }

        // ===========================================
        // متغيرات وإدارة اختيار اللاعبين
        // ===========================================
        let selectedPlayers = [];
        let currentStudents = [];

        // ملء قائمة الصفوف الاحترافية
        function populateClassSelect() {
            console.log('📚 بدء ملء قائمة الصفوف...');
            const classSelect = document.getElementById('classSelect');
            const setupBtn = document.getElementById('setupPlayersBtn');
            
            if (!classSelect) {
                console.error('❌ لم يتم العثور على عنصر classSelect');
                return;
            }
            
            // تنظيف القائمة
            classSelect.innerHTML = '<option value="">اختر الصف الدراسي</option>';
            
            if (playerData && Object.keys(playerData).length > 0) {
                console.log(`📊 عدد الصفوف المتاحة: ${Object.keys(playerData).length}`);
                
                // إضافة خيارات الصفوف
                Object.keys(playerData).forEach(className => {
                    const studentCount = playerData[className].length;
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = `${className} (${studentCount} طالب)`;
                    classSelect.appendChild(option);
                    console.log(`➕ إضافة صف: ${className} - ${studentCount} طالب`);
                });
                
                console.log('✅ تم ملء قائمة الصفوف بنجاح');
            } else {
                console.warn('⚠️ لا توجد بيانات طلاب');
                // إذا لم تكن هناك بيانات، أضف رسالة تنبيه
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "❌ فشل تحميل بيانات الطلاب - تحقق من ملف studentData.json";
                option.disabled = true;
                classSelect.appendChild(option);
                
                MessageSystem.show('❌ لم يتم تحميل بيانات الطلاب! تأكد من وجود ملف data/studentData.json والاتصال بالخادم', 'error', 10000);
            }
            
            // إعداد حدث تغيير الصف
            classSelect.addEventListener('change', () => {
                if (setupBtn) {
                    const playersCount = document.getElementById('playersCount').value;
                    setupBtn.disabled = !classSelect.value || !playersCount;
                    
                    if (classSelect.value && playerData[classSelect.value]) {
                        const studentCount = playerData[classSelect.value].length;
                        MessageSystem.show(`📚 تم اختيار "${classSelect.value}" - يحتوي على ${studentCount} طالب`, 'success', 3000);
                    }
                }
            });
            
            console.log('🔧 تم إعداد مستمع أحداث تغيير الصف');
        }

        // إعداد واجهة اختيار اللاعبين البسيطة (مثل ملف 4.html)
        function setupSmartPlayerSelection() {
            const classValue = document.getElementById('classSelect').value;
            const playersCount = parseInt(document.getElementById('playersCount').value);
            
            console.log('🎯 إعداد اختيار اللاعبين للصف:', classValue, 'عدد اللاعبين:', playersCount);
            
            if (!classValue) {
                console.warn('⚠️ لم يتم اختيار صف');
                MessageSystem.show('يرجى اختيار الصف أولاً!', 'error');
                return;
            }

            if (!playersCount || playersCount < 2 || playersCount > 6) {
                MessageSystem.show('يرجى اختيار عدد اللاعبين (2-6)!', 'error');
                return;
            }

            if (!playerData || Object.keys(playerData).length === 0) {
                console.error('❌ playerData فارغ أو غير موجود');
                MessageSystem.show('❌ لا توجد بيانات طلاب! يجب تحميل ملف studentData.json أولاً', 'error', 10000);
                
                // محاولة إعادة تحميل البيانات
                console.log('🔄 محاولة إعادة تحميل البيانات...');
                loadStudentData().then((success) => {
                    if (success) {
                        console.log('✅ تم إعادة تحميل البيانات بنجاح');
                        populateClassSelect();
                        MessageSystem.show('✅ تم إعادة تحميل بيانات الطلاب! حاول مرة أخرى', 'success');
                    } else {
                        console.error('❌ فشل في إعادة تحميل البيانات');
                    }
                });
                return;
            }

            if (!playerData[classValue]) {
                console.error('❌ لا توجد بيانات للصف:', classValue);
                console.log('🔍 الصفوف المتاحة:', Object.keys(playerData));
                MessageSystem.show('لا توجد بيانات طلاب لهذا الصف!', 'error');
                return;
            }

            const students = playerData[classValue];
            if (students.length < playersCount) {
                MessageSystem.show(`الصف يحتوي على ${students.length} طالب فقط، لا يمكن اختيار ${playersCount} لاعبين!`, 'error');
                return;
            }

            // إعادة تعيين اختيار اللاعبين
            selectedPlayers = [];
            
            // تحديث عداد اللاعبين المطلوب
            document.getElementById('totalPlayersNeeded').textContent = playersCount;
            
            // عرض واجهة اختيار اللاعبين التفاعلية
            displayStudentsInteractiveGrid(students);
            
            // إظهار الواجهة
            const selectionDiv = document.getElementById('smartPlayerSelection');
            selectionDiv.style.display = 'block';
            
            MessageSystem.show(`اختر ${playersCount} طلاب من ${classValue} للمشاركة في اللعبة! �`, 'info', 4000);
            
            // التمرير إلى الواجهة
            setTimeout(() => {
                selectionDiv.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 100);
        }
        
        // عرض شبكة الطلاب التفاعلية
        function displayStudentsInteractiveGrid(students) {
            const gridContainer = document.getElementById('studentsInteractiveGrid');
            
            if (!gridContainer) {
                console.error('❌ لم يتم العثور على studentsInteractiveGrid');
                return;
            }
            
            // تنظيف الشبكة
            gridContainer.innerHTML = '';
            
            // إنشاء بطاقات الطلاب
            students.forEach((student, index) => {
                const card = createSimpleStudentCard(student, index);
                gridContainer.appendChild(card);
            });
            
            console.log(`✅ تم عرض ${students.length} بطاقة طالب`);
        }

        // دالة بدء اللعبة مع الطلاب المختارين
        function startGameWithStudents() {
            if (!gameState.players || gameState.players.length < 2) {
                MessageSystem.show('يجب إعداد اللاعبين أولاً!', 'error');
                return;
            }
            
            startGame();
        }

        // إنشاء بطاقة طالب محسّنة وتفاعلية
        function createSimpleStudentCard(student, index) {
            const card = document.createElement('div');
            card.className = 'student-card interactive enhanced';
            card.setAttribute('data-student-id', student.id || student.name);
            
            // ألوان متنوعة للبطاقات
            const cardColors = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
            ];
            
            const cardColor = cardColors[index % cardColors.length];
            
            card.innerHTML = `
                <div class="card-background" style="background: ${cardColor}; opacity: 0.1; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: inherit;"></div>
                <div class="card-header">
                    <div class="student-avatar-enhanced">
                        <div class="avatar-circle" style="background: ${cardColor};">
                            <span class="avatar-letter">${student.name.charAt(0)}</span>
                        </div>
                        <div class="avatar-badge">
                            <span>${index + 1}</span>
                        </div>
                    </div>
                    <div class="selection-indicator">
                        <div class="selection-circle">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <h4 class="student-name-enhanced" title="${student.name}">${student.name}</h4>
                    <div class="student-meta">
                        <span class="student-id">طالب رقم: ${index + 1}</span>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="action-button">
                        <span class="action-text">انقر للاختيار</span>
                        <i class="fas fa-hand-pointer action-icon"></i>
                    </div>
                </div>
                <div class="card-effects">
                    <div class="ripple-effect"></div>
                    <div class="success-animation">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            `;
            
            // إضافة تأثيرات تفاعلية
            card.addEventListener('mouseenter', () => {
                if (!card.classList.contains('selected')) {
                    card.style.transform = 'translateY(-8px) scale(1.02)';
                    card.style.boxShadow = '0 15px 35px rgba(0,0,0,0.2)';
                }
            });
            
            card.addEventListener('mouseleave', () => {
                if (!card.classList.contains('selected')) {
                    card.style.transform = 'translateY(0) scale(1)';
                    card.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                }
            });
            
            // إضافة حدث النقر مع تأثيرات
            card.addEventListener('click', (e) => {
                // تأثير الموجة عند النقر
                createRippleEffect(e, card);
                setTimeout(() => {
                    toggleEnhancedStudentSelection(card, student, index);
                }, 100);
            });
            
            return card;
        }

        // تبديل اختيار الطالب المحسّن
        function toggleEnhancedStudentSelection(card, student, index) {
            const playersNeeded = parseInt(document.getElementById('totalPlayersNeeded').textContent);
            const isSelected = selectedPlayers.some(p => p.id === (student.id || student.name));
            
            if (isSelected) {
                // إزالة الطالب مع تأثيرات
                deselectStudentCard(card, student);
            } else {
                // إضافة طالب مع تأثيرات
                if (selectedPlayers.length >= playersNeeded) {
                    showMaxPlayersReachedAnimation(card);
                    return;
                }
                
                selectStudentCard(card, student, index);
            }
            
            updateSelectionUI();
        }
        
        // إنشاء تأثير الموجة عند النقر
        function createRippleEffect(e, element) {
            const ripple = element.querySelector('.ripple-effect');
            const rect = element.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('animate');
            
            setTimeout(() => {
                ripple.classList.remove('animate');
            }, 600);
        }
        
        // اختيار بطاقة الطالب
        function selectStudentCard(card, student, index) {
            // إضافة للقائمة
            selectedPlayers.push({
                id: student.id || student.name,
                name: student.name,
                index: index
            });
            
            // تحديث مظهر البطاقة
            card.classList.add('selected');
            
            // تحديث الأيقونات والنصوص
            const selectionCircle = card.querySelector('.selection-circle');
            const actionText = card.querySelector('.action-text');
            const actionIcon = card.querySelector('.action-icon');
            const successAnimation = card.querySelector('.success-animation');
            
            selectionCircle.innerHTML = '<i class="fas fa-check"></i>';
            selectionCircle.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            actionText.textContent = 'تم الاختيار';
            actionIcon.className = 'fas fa-check action-icon';
            
            // تأثير النجاح
            successAnimation.style.display = 'flex';
            setTimeout(() => {
                successAnimation.style.display = 'none';
            }, 1000);
            
            // تأثيرات صوتية
            soundSystem.play('select');
            
            // تأثير بصري للبطاقة
            card.style.transform = 'translateY(-5px) scale(1.05)';
            card.style.boxShadow = '0 10px 30px rgba(76, 175, 80, 0.3)';
            
            // فحص اكتمال الاختيار
            const playersNeeded = parseInt(document.getElementById('totalPlayersNeeded').textContent);
            if (selectedPlayers.length === playersNeeded) {
                setTimeout(() => {
                    showSelectionCompleteAnimation();
                }, 500);
            }
        }
        
        // إلغاء اختيار بطاقة الطالب
        function deselectStudentCard(card, student) {
            // إزالة من القائمة
            selectedPlayers = selectedPlayers.filter(p => p.id !== (student.id || student.name));
            
            // تحديث مظهر البطاقة
            card.classList.remove('selected');
            
            // إعادة تعيين الأيقونات والنصوص
            const selectionCircle = card.querySelector('.selection-circle');
            const actionText = card.querySelector('.action-text');
            const actionIcon = card.querySelector('.action-icon');
            
            selectionCircle.innerHTML = '<i class="fas fa-plus"></i>';
            selectionCircle.style.background = 'linear-gradient(135deg, #6c757d, #495057)';
            actionText.textContent = 'انقر للاختيار';
            actionIcon.className = 'fas fa-hand-pointer action-icon';
            
            // إعادة تعيين التأثيرات البصرية
            card.style.transform = 'translateY(0) scale(1)';
            card.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
            
            // صوت الإلغاء
            soundSystem.play('Click');
        }
        
        // إظهار تأثير الوصول للحد الأقصى
        function showMaxPlayersReachedAnimation(card) {
            const playersNeeded = parseInt(document.getElementById('totalPlayersNeeded').textContent);
            
            // رسالة تحذيرية
            MessageSystem.show(`🚫 تم الوصول للحد الأقصى! يمكن اختيار ${playersNeeded} لاعبين فقط`, 'warning', 3000);
            
            // تأثير اهتزاز للبطاقة
            card.style.animation = 'cardShake 0.6s ease-in-out';
            card.style.borderColor = '#ff4757';
            
            setTimeout(() => {
                card.style.animation = '';
                card.style.borderColor = '';
            }, 600);
            
            // صوت خطأ
            soundSystem.play('wrong_answer');
        }
        
        // إظهار تأثير اكتمال الاختيار
        function showSelectionCompleteAnimation() {
            const playersNeeded = parseInt(document.getElementById('totalPlayersNeeded').textContent);
            
            // إخفاء البطاقات غير المختارة تدريجياً
            const allCards = document.querySelectorAll('.student-card:not(.selected)');
            allCards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '0.3';
                    card.style.transform = 'scale(0.9)';
                    card.style.filter = 'blur(2px)';
                    card.style.pointerEvents = 'none';
                }, index * 100);
            });
            
            // تأثيرات الكونفيتي
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#4CAF50', '#2196F3', '#FF9800', '#E91E63']
            });
            
            // رسالة النجاح
            MessageSystem.show(`🎉 ممتاز! تم اختيار ${playersNeeded} لاعبين بنجاح`, 'success', 4000);
            
            // صوت النجاح
            soundSystem.play('win');
            
            // تفعيل زر التأكيد مع تأثيرات
            const confirmBtn = document.getElementById('confirmPlayerSelection');
            confirmBtn.disabled = false;
            confirmBtn.style.animation = 'pulse 1s infinite';
            confirmBtn.innerHTML = '<i class="fas fa-rocket"></i> ابدأ اللعبة الآن!';
            
            // إظهار إشعار الجاهزية
            setTimeout(() => {
                showGameReadyNotification();
            }, 2000);
        }
        
        // إظهار إشعار جاهزية اللعبة
        function showGameReadyNotification() {
            const notification = document.createElement('div');
            notification.className = 'game-ready-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">
                        <i class="fas fa-gamepad"></i>
                    </div>
                    <div class="notification-text">
                        <h3>🚀 اللعبة جاهزة للبدء!</h3>
                        <p>تم اختيار جميع اللاعبين بنجاح</p>
                        <div class="ready-players">
                            ${selectedPlayers.map(player => `
                                <span class="ready-player">${player.name}</span>
                            `).join('')}
                        </div>
                    </div>
                    <button class="notification-start-btn" onclick="confirmPlayerSelection(); document.body.removeChild(this.closest('.game-ready-notification'));">
                        <i class="fas fa-play"></i>
                        ابدأ اللعبة
                    </button>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                z-index: 10003;
                text-align: center;
                min-width: 350px;
                animation: bounceIn 0.6s ease-out;
                font-family: 'Cairo', sans-serif;
            `;
            
            document.body.appendChild(notification);
            
            // إزالة الإشعار تلقائياً بعد 10 ثواني
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'fadeOut 0.5s ease-in';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 500);
                }
            }, 10000);
        }

        // ===========================================
        // واجهة الاختيار والتحديث
        // ===========================================
        function updateSelectionUI() {
            updateSimpleSelectionUI();
        }
        
        function updateSimplePlayerSelectionStatus() {
            updateSimpleSelectionUI();
        }

        // تحديث واجهة الاختيار البسيطة
        function updateSimpleSelectionUI() {
            const selectedCount = selectedPlayers.length;
            const totalNeeded = parseInt(document.getElementById('totalPlayersNeeded').textContent);
            
            // تحديث العداد
            document.getElementById('selectedPlayersCount').textContent = selectedCount;
            
            // تحديث شريط التقدم
            const progress = (selectedCount / totalNeeded) * 100;
            document.getElementById('selectionProgress').style.width = `${progress}%`;
            
            // تحديث زر التأكيد
            const confirmBtn = document.getElementById('confirmPlayerSelection');
            confirmBtn.disabled = selectedCount !== totalNeeded;
            
            // تحديث معاينة اللاعبين المختارين
            updateSimpleSelectedPlayersPreview();
        }

        // تحديث معاينة اللاعبين المختارين البسيطة
        function updateSimpleSelectedPlayersPreview() {
            const previewContainer = document.getElementById('selectedPlayersList');
            
            if (selectedPlayers.length === 0) {
                previewContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-plus"></i>
                        <p>انقر على الطلاب لاختيارهم</p>
                    </div>
                `;
                return;
            }
            
            previewContainer.innerHTML = '';
            selectedPlayers.forEach((player, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'selected-player-card';
                playerCard.innerHTML = `
                    <button class="remove-btn" onclick="removeSelectedPlayer('${player.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="student-avatar" style="width: 40px; height: 40px; margin: 0 auto 10px;">
                        ${player.name.charAt(0)}
                    </div>
                    <div class="student-name" style="font-size: 0.9rem;">${player.name}</div>
                    <div class="player-role">لاعب ${index + 1}</div>
                `;
                previewContainer.appendChild(playerCard);
            });
        }

        // إزالة لاعب مختار
        function removeSelectedPlayer(playerId) {
            selectedPlayers = selectedPlayers.filter(p => p.id !== playerId);
            
            // إزالة التحديد من البطاقة
            const cards = document.querySelectorAll('.student-interactive-card');
            cards.forEach(card => {
                if (card.dataset.studentId === playerId || card.dataset.studentName === playerId) {
                    card.classList.remove('selected');
                    
                    // تحديث حالة البطاقة
                    const statusElement = card.querySelector('.student-status');
                    statusElement.innerHTML = `
                        <i class="fas fa-plus-circle"></i>
                        <span>انقر للاختيار</span>
                    `;
                }
            });
            
            updateSimpleSelectionUI();
            soundSystem.play('Click');
        }

        // تأكيد اختيار اللاعبين
        function confirmPlayerSelection() {
            if (selectedPlayers.length === 0) {
                MessageSystem.show('يرجى اختيار اللاعبين أولاً!', 'error');
                return;
            }
            
            // ألوان مختلفة للاعبين
            const playerColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            
            // إعداد اللعبة
            gameState.players = selectedPlayers.map((player, index) => {
                const newPlayer = {
                    name: player.name || `اللاعب ${index + 1}`,
                    money: 1500,
                    position: 0,
                    properties: [],
                    color: playerColors[index % playerColors.length],
                    inJail: false,
                    jailTurns: 0
                };
                
                // التحقق من صحة البيانات
                validatePlayerData(newPlayer);
                return newPlayer;
            });
            
            gameState.gameStarted = false;
            gameState.currentPlayer = 0;
            
            // إخفاء واجهة الاختيار مع تأثير انتقالي
            const selectionDiv = document.getElementById('smartPlayerSelection');
            selectionDiv.style.transform = 'scale(0.95)';
            selectionDiv.style.opacity = '0';
            
            setTimeout(() => {
                selectionDiv.style.display = 'none';
                selectionDiv.style.transform = 'scale(1)';
                selectionDiv.style.opacity = '1';
            }, 300);
            
            // تفعيل زر بدء اللعبة
            document.getElementById('startGameBtn').disabled = false;
            
            // تحديث عرض اللاعبين
            updatePlayersDisplay();
            
            // إشعار بالجاهزية للعب
            MessageSystem.show(`🎮 تم إعداد ${selectedPlayers.length} لاعبين بنجاح! اللعبة جاهزة للبدء`, 'success', 5000);
            soundSystem.play('win');
            
            // تأثير الكونفيتي الكبير
            confetti({
                particleCount: 200,
                spread: 120,
                origin: { y: 0.6 }
            });
            
            // التمرير إلى أزرار التحكم
            setTimeout(() => {
                document.querySelector('.game-controls').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 500);
        }

        // إلغاء اختيار اللاعبين
        function cancelPlayerSelection() {
            const selectionDiv = document.getElementById('smartPlayerSelection');
            selectionDiv.style.transform = 'scale(0.95)';
            selectionDiv.style.opacity = '0';
            
            setTimeout(() => {
                selectionDiv.style.display = 'none';
                selectionDiv.style.transform = 'scale(1)';
                selectionDiv.style.opacity = '1';
            }, 300);
            
            selectedPlayers = [];
            MessageSystem.show('تم إلغاء اختيار اللاعبين', 'info');
        }

        // مسح الاختيار الحالي
        function clearSelection() {
            selectedPlayers = [];
            
            // إزالة التحديد من جميع البطاقات
            const cards = document.querySelectorAll('.student-interactive-card');
            cards.forEach(card => {
                card.classList.remove('selected');
                
                // تحديث حالة البطاقة
                const statusElement = card.querySelector('.student-status');
                if (statusElement) {
                    statusElement.innerHTML = `
                        <i class="fas fa-plus-circle"></i>
                        <span>انقر للاختيار</span>
                    `;
                }
            });
            
            updateSimpleSelectionUI();
            MessageSystem.show('تم مسح جميع الاختيارات', 'info');
            soundSystem.play('Click');
        }

        // بدء اللعبة مع الطلاب المختارين
        function startGameWithStudents() {
            const classValue = document.getElementById('classSelect').value;
            const playersCount = parseInt(document.getElementById('playersCount').value);

            if (!classValue) {
                MessageSystem.show('يرجى اختيار الصف أولاً!', 'error');
                return;
            }

            const studentsInClass = playerData[classValue];
            if (studentsInClass.length < playersCount) {
                MessageSystem.show(`الصف يحتوي على ${studentsInClass.length} طالب فقط، لا يمكن اختيار ${playersCount} لاعبين!`, 'error');
                return;
            }

            // اختيار طلاب عشوائيين من الصف
            const shuffled = [...studentsInClass].sort(() => 0.5 - Math.random());
            const selectedStudents = shuffled.slice(0, playersCount);

            // إعداد اللاعبين
            gameState.players = selectedStudents.map((student, index) => ({
                name: student.name,
                money: 1500,
                position: 0,
                properties: []
            }));

            gameState.gameStarted = true;
            gameState.currentPlayer = 0;
            
            // تحديث أزرار التحكم
            document.getElementById('startGameBtn').disabled = true;
            document.getElementById('rollDice').disabled = false;
            document.getElementById('endTurn').disabled = false;
            
            updatePlayersDisplay();
            MessageSystem.show(`بدأت اللعبة مع ${playersCount} لاعبين! حظاً موفقاً!`, 'success');
            soundSystem.play('win');
        }

        // ===========================================
        // إنشاء لوحة اللعبة العصرية
        // ===========================================
        function createGameBoard() {
            console.log('🏗️ بدء إنشاء لوحة اللعبة العصرية...');
            const board = document.getElementById('gameBoard');
            
            if (!board) {
                console.error('❌ لم يتم العثور على عنصر gameBoard!');
                return;
            }
            
            // منع التكرار - إذا كانت اللوحة تحتوي على مربعات بالفعل
            if (board.children.length > 0) {
                console.log('ℹ️ اللوحة موجودة بالفعل، إعادة إنشاء...');
                board.innerHTML = ''; // إعادة إنشاء لضمان التحديث
            }
            
            if (!omanProperties || omanProperties.length === 0) {
                console.error('❌ بيانات omanProperties غير متوفرة!');
                return;
            }
            
            console.log(`📊 عدد العقارات: ${omanProperties.length}`);

            // إنشاء المربعات مع التصميم الجديد
            omanProperties.forEach((property, index) => {
                const square = document.createElement('div');
                const isCorner = index % 10 === 0;
                
                square.className = `board-square ${property.color} ${isCorner ? 'corner-square' : 'side-square'} square-${index}`;
                square.id = `square-${index}`;
                
                // محتوى محسن للمربعات
                square.innerHTML = `
                    <div class="property-content">
                        <div class="property-name" style="font-weight: 800; font-size: ${isCorner ? '0.9rem' : '0.75rem'}; margin-bottom: 4px;">
                            ${property.name}
                        </div>
                        ${property.price > 0 ? `
                            <div class="property-price" style="background: rgba(0,0,0,0.2); color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; font-weight: 700;">
                                ${property.price} ر.ع
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // تأثيرات تفاعلية متقدمة
                square.addEventListener('mouseenter', () => {
                    square.style.transform += ' rotateY(5deg)';
                    square.style.boxShadow = '0 20px 40px rgba(0,0,0,0.3), 0 0 30px rgba(220, 20, 60, 0.4)';
                });
                
                square.addEventListener('mouseleave', () => {
                    square.style.transform = square.style.transform.replace(' rotateY(5deg)', '');
                    square.style.boxShadow = '';
                });
                
                square.addEventListener('click', () => {
                    // تأثير النقر
                    square.style.transform += ' scale(0.95)';
                    setTimeout(() => {
                        square.style.transform = square.style.transform.replace(' scale(0.95)', '');
                        showPropertyInfo(property);
                    }, 150);
                });
                
                board.appendChild(square);
                console.log(`✅ تم إنشاء مربع ${index}: ${property.name}`);
                
                // تأثير ظهور متدرج
                setTimeout(() => {
                    square.style.opacity = '0';
                    square.style.transform += ' translateY(20px)';
                    requestAnimationFrame(() => {
                        square.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                        square.style.opacity = '1';
                        square.style.transform = square.style.transform.replace(' translateY(20px)', '');
                    });
                }, index * 50); // تأخير تدريجي لكل مربع
            });
            
            console.log('🎯 تم الانتهاء من إنشاء لوحة اللعبة العصرية!');
            
            // تأثير نهاية الإنشاء
            setTimeout(() => {
                board.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    board.style.transform = 'scale(1)';
                }, 300);
            }, omanProperties.length * 50 + 500);
        }

        // ===========================================
        // معلومات العقار
        // ===========================================
        function showPropertyInfo(property) {
            const modal = document.getElementById('propertyModal');
            const propertyInfo = document.getElementById('propertyInfo');
            
            let infoHTML = `
                <h2><i class="fas fa-building"></i> ${property.name}</h2>
                <div style="margin-top: 20px;">
            `;

            if (property.type === 'property') {
                infoHTML += `
                    <p><strong>النوع:</strong> عقار</p>
                    <p><strong>السعر:</strong> ${property.price} ريال عُماني</p>
                    <p><strong>المجموعة:</strong> ${getGroupName(property.color)}</p>
                    <h3>الإيجارات:</h3>
                    <ul>
                        <li>أرض فارغة: ${property.rent[0]} ر.ع</li>
                        <li>منزل واحد: ${property.rent[1]} ر.ع</li>
                        <li>منزلان: ${property.rent[2]} ر.ع</li>
                        <li>ثلاثة منازل: ${property.rent[3]} ر.ع</li>
                        <li>أربعة منازل: ${property.rent[4]} ر.ع</li>
                        <li>فندق: ${property.rent[5]} ر.ع</li>
                    </ul>
                `;
            } else if (property.type === 'airport') {
                infoHTML += `
                    <p><strong>النوع:</strong> مطار</p>
                    <p><strong>السعر:</strong> ${property.price} ريال عُماني</p>
                    <h3>الإيجارات:</h3>
                    <ul>
                        <li>مطار واحد: ${property.rent[0]} ر.ع</li>
                        <li>مطاران: ${property.rent[1]} ر.ع</li>
                        <li>ثلاثة مطارات: ${property.rent[2]} ر.ع</li>
                        <li>أربعة مطارات: ${property.rent[3]} ر.ع</li>
                    </ul>
                `;
            } else if (property.type === 'utility') {
                infoHTML += `
                    <p><strong>النوع:</strong> مرفق عام</p>
                    <p><strong>السعر:</strong> ${property.price} ريال عُماني</p>
                    <p><strong>الإيجار:</strong> 4 مرات نتيجة النرد (مرفق واحد) أو 10 مرات (مرفقان)</p>
                `;
            } else {
                infoHTML += `<p><strong>النوع:</strong> ${getSquareTypeName(property.type)}</p>`;
            }

            infoHTML += '</div>';
            propertyInfo.innerHTML = infoHTML;
            modal.style.display = 'block';
        }

        function getGroupName(color) {
            const groups = {
                'brown': 'المجموعة البنية',
                'light-blue': 'المجموعة الزرقاء الفاتحة',
                'pink': 'المجموعة الوردية',
                'orange': 'المجموعة البرتقالية',
                'red': 'المجموعة الحمراء',
                'yellow': 'المجموعة الصفراء',
                'green': 'المجموعة الخضراء',
                'dark-blue': 'المجموعة الزرقاء الداكنة',
                'railroad': 'المطارات',
                'utility': 'المرافق العامة'
            };
            return groups[color] || 'غير محدد';
        }

        function getSquareTypeName(type) {
            const types = {
                'start': 'نقطة البداية',
                'jail': 'السجن/الزيارة',
                'free': 'موقف مجاني',
                'go-to-jail': 'اذهب للسجن',
                'tax': 'ضريبة',
                'chance': 'الفرصة',
                'community': 'صندوق المجتمع'
            };
            return types[type] || 'غير محدد';
        }

        // ===========================================
        // إدارة اللاعبين
        // ===========================================
        function initializePlayers(playerNames = null) {
            if (playerNames && playerNames.length > 0) {
                // استخدام أسماء مخصصة
                gameState.players = playerNames.map((name, index) => ({
                    name: name || `اللاعب ${index + 1}`,
                    money: 1500,
                    position: 0,
                    properties: []
                }));
            } else {
                // إنشاء لاعبين افتراضيين
                gameState.players = [
                    { name: 'اللاعب الأول', money: 1500, position: 0, properties: [] },
                    { name: 'اللاعب الثاني', money: 1500, position: 0, properties: [] }
                ];
            }
            
            updatePlayersDisplay();
            MessageSystem.show(`تم إعداد ${gameState.players.length} لاعبين`, 'success');
        }

        function updatePropertyDisplay() {
            omanProperties.forEach((property, index) => {
                if (property.type === 'property' || property.type === 'airport' || property.type === 'utility') {
                    const squareElement = document.getElementById(`square-${index}`);
                    if (squareElement) {
                        // التحقق من الملكية
                        const owner = gameState.players.find(p => p.properties.includes(index));
                        
                        if (owner) {
                            // العقار مملوك
                            squareElement.classList.remove('available');
                            squareElement.classList.add('owned');
                            squareElement.style.backgroundColor = owner.color || '#e74c3c';
                            
                            // إضافة اسم المالك
                            let ownerLabel = squareElement.querySelector('.owner-label');
                            if (!ownerLabel) {
                                ownerLabel = document.createElement('div');
                                ownerLabel.className = 'owner-label';
                                ownerLabel.style.cssText = `
                                    position: absolute;
                                    bottom: 2px;
                                    left: 2px;
                                    right: 2px;
                                    background: rgba(0,0,0,0.8);
                                    color: white;
                                    font-size: 8px;
                                    text-align: center;
                                    border-radius: 3px;
                                    padding: 1px;
                                `;
                                squareElement.appendChild(ownerLabel);
                            }
                            ownerLabel.textContent = owner.name;
                        } else {
                            // العقار متاح للشراء
                            squareElement.classList.remove('owned');
                            squareElement.classList.add('available');
                            squareElement.style.backgroundColor = '';
                            
                            // إزالة تسمية المالك
                            const ownerLabel = squareElement.querySelector('.owner-label');
                            if (ownerLabel) ownerLabel.remove();
                        }
                    }
                }
            });
        }

        // دالة مساعدة لعرض المال بشكل آمن
        function formatMoney(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                console.warn('⚠️ قيمة مال غير صحيحة:', amount);
                return '0 ر.ع';
            }
            return `${Math.round(amount)} ر.ع`;
        }

        // دالة مساعدة للتأكد من صحة بيانات اللاعب
        function validatePlayerData(player) {
            if (!player) {
                console.error('❌ بيانات لاعب مفقودة');
                return false;
            }
            
            // التأكد من وجود المال كرقم
            if (typeof player.money !== 'number' || isNaN(player.money)) {
                console.warn('⚠️ إصلاح مال اللاعب:', player.name, 'من', player.money, 'إلى 1500');
                player.money = 1500; // إعادة تعيين المال الافتراضي
            }
            
            // التأكد من وجود الموقع كرقم
            if (typeof player.position !== 'number' || isNaN(player.position)) {
                console.warn('⚠️ إصلاح موقع اللاعب:', player.name, 'من', player.position, 'إلى 0');
                player.position = 0;
            }
            
            // التأكد من وجود قائمة العقارات
            if (!Array.isArray(player.properties)) {
                console.warn('⚠️ إصلاح قائمة عقارات اللاعب:', player.name);
                player.properties = [];
            }
            
            return true;
        }

        function updatePlayersDisplay() {
            const playersInfo = document.getElementById('playersInfo');
            if (!playersInfo) return;
            
            playersInfo.innerHTML = '';

            gameState.players.forEach((player, index) => {
                // التحقق من صحة بيانات اللاعب
                validatePlayerData(player);
                
                const isCurrentPlayer = index === gameState.currentPlayer;
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${isCurrentPlayer ? 'current-player' : ''} ${player.isBankrupt ? 'bankrupt-player' : ''}`;
                playerCard.setAttribute('data-player', index);
                
                const currentPosition = player.position >= 0 && player.position < omanProperties.length ? 
                    player.position : 0;
                
                // حساب القيمة الصافية
                const netWorth = LeaderboardSystem.calculateNetWorth(player);
                const propertyValue = LeaderboardSystem.calculatePropertyValue(player);
                
                // تحديد حالة اللاعب
                let playerStatus = '';
                if (isCurrentPlayer) {
                    if (!gameState.gameStarted) {
                        playerStatus = '<div class="player-turn-status">🎮 في انتظار بدء اللعبة</div>';
                    } else {
                        playerStatus = '<div class="player-turn-status">🎯 دورك الآن!</div>';
                        playerStatus += '<div class="action-hint">💡 اضغط "رمي النرد" للعب</div>';
                    }
                }
                
                playerCard.innerHTML = `
                    ${isCurrentPlayer ? '<div class="current-player-indicator">دورك الآن</div>' : ''}
                    
                    <h3 style="color: ${isCurrentPlayer ? '#fff' : '#2c3e50'};">
                        ${player.name || `اللاعب ${index + 1}`} 
                        ${player.isBankrupt ? '💔' : ''}
                        ${player.inJail ? '🏛️' : ''}
                        ${isCurrentPlayer ? '👑' : ''}
                        ${isCurrentPlayer ? '<span style="color: #ffeb3b;">◀ دورك</span>' : ''}
                        ${player.inJail ? '<span style="color: #e74c3c; font-size: 0.8em;">في السجن</span>' : ''}
                        ${player.isBankrupt ? '<span style="color: #e74c3c; font-size: 0.8em; font-weight: bold;">مُفلِس</span>' : ''}
                    </h3>
                    
                    ${playerStatus}
                    
                    <div class="player-stats-enhanced">
                        <div class="stat-item">
                            <div style="font-size: 1.2em; color: #27ae60;">💰</div>
                            <div style="font-weight: bold; color: ${isCurrentPlayer ? '#fff' : '#2c3e50'};">${formatMoney(player.money)}</div>
                            <div style="font-size: 0.8em; color: ${isCurrentPlayer ? '#ecf0f1' : '#7f8c8d'};">الأموال</div>
                        </div>
                        
                        <div class="stat-item">
                            <div style="font-size: 1.2em; color: #3498db;">🏠</div>
                            <div style="font-weight: bold; color: ${isCurrentPlayer ? '#fff' : '#2c3e50'};">${player.properties ? player.properties.length : 0}</div>
                            <div style="font-size: 0.8em; color: ${isCurrentPlayer ? '#ecf0f1' : '#7f8c8d'};">العقارات</div>
                        </div>
                        
                        <div class="stat-item">
                            <div style="font-size: 1.2em; color: #9b59b6;">📊</div>
                            <div style="font-weight: bold; color: ${isCurrentPlayer ? '#fff' : '#2c3e50'};">${formatMoney(netWorth)}</div>
                            <div style="font-size: 0.8em; color: ${isCurrentPlayer ? '#ecf0f1' : '#7f8c8d'};">القيمة الصافية</div>
                        </div>
                        
                        <div class="stat-item">
                            <div style="font-size: 1.2em; color: #e67e22;">🏘️</div>
                            <div style="font-weight: bold; color: ${isCurrentPlayer ? '#fff' : '#2c3e50'};">${formatMoney(propertyValue)}</div>
                            <div style="font-size: 0.8em; color: ${isCurrentPlayer ? '#ecf0f1' : '#7f8c8d'};">قيمة العقارات</div>
                        </div>
                    </div>
                    
                    <div class="player-info">
                        <span style="color: ${isCurrentPlayer ? '#fff' : '#2c3e50'};">📍 الموقع الحالي:</span>
                        <div class="player-position-indicator" style="color: ${isCurrentPlayer ? '#ecf0f1' : '#34495e'}; font-weight: bold;">
                            ${omanProperties[currentPosition]?.name || 'البداية'}
                        </div>
                        
                        ${player.inJail ? `
                            <div style="background: rgba(231, 76, 60, 0.2); padding: 10px; border-radius: 10px; margin-top: 10px; border: 2px solid #e74c3c;">
                                <div style="color: #e74c3c; font-weight: bold; font-size: 0.9em;">
                                    🏛️ في السجن - المحاولة ${player.jailTurns || 0}/3
                                </div>
                                <div style="font-size: 0.8em; color: ${isCurrentPlayer ? '#ecf0f1' : '#7f8c8d'}; margin-top: 5px;">
                                    يمكن الخروج بزوجي أو دفع 50 ر.ع
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${isCurrentPlayer && gameState.gameStarted ? `
                        <div class="player-actions">
                            <small style="color: #7f8c8d; text-align: center; display: block; margin-top: 10px;">
                                ⏰ انتظار الحركة...
                            </small>
                        </div>
                    ` : ''}
                `;
                
                playersInfo.appendChild(playerCard);
            });
            
            // تحديث تمييز البطاقة الحالية
            updatePlayerCardHighlight();
        }

        // ===========================================
        // اختبار نظام السحب
        // ===========================================
        
        function testBankruptcyDemo() {
            console.log('💔 بدء العرض التجريبي لنظام الإفلاس');
            
            // إنشاء لاعبين تجريبيين
            if (!gameState.players || gameState.players.length < 2) {
                gameState.players = [
                    {
                        name: "لاعب تجريبي 1",
                        money: 50, // مال قليل
                        position: 5,
                        properties: [1, 3], // بعض العقارات
                        inJail: false,
                        jailTurns: 0,
                        isBankrupt: false
                    },
                    {
                        name: "لاعب تجريبي 2",
                        money: 1500,
                        position: 10,
                        properties: [],
                        inJail: false,
                        jailTurns: 0,
                        isBankrupt: false
                    }
                ];
                gameState.currentPlayer = 0;
                gameState.gameStarted = true;
                gameState.propertyOwners = {
                    1: gameState.players[0],
                    3: gameState.players[0]
                };
            }
            
            // محاكاة موقف إفلاس
            MessageSystem.show('💸 محاكاة موقف إفلاس...', 'info', 2000);
            setTimeout(() => {
                // تقليل مال اللاعب لحد الإفلاس
                const player = gameState.players[0];
                player.money = -200; // إفلاس
                
                updatePlayersDisplay();
                
                setTimeout(() => {
                    handleBankruptcy(0, 300);
                }, 1000);
            }, 1000);
            
            console.log('💔 اختبار الإفلاس مُفعّل!');
        }

        function testJailDemo() {
            console.log('🏛️ بدء العرض التجريبي لنظام السجن');
            
            // إنشاء لاعب تجريبي إذا لم يكن موجود
            if (!gameState.players || gameState.players.length === 0) {
                gameState.players = [{
                    name: "لاعب تجريبي",
                    money: 1500,
                    position: 5,
                    properties: [],
                    inJail: false,
                    jailTurns: 0
                }];
                gameState.currentPlayer = 0;
                gameState.gameStarted = true;
            }
            
            // إرسال اللاعب للسجن
            MessageSystem.show('🏛️ إرسال اللاعب التجريبي للسجن...', 'info', 2000);
            setTimeout(() => {
                handleGoToJail(0);
                updatePlayersDisplay();
                
                // اختبار آخر بعد 3 ثوان
                setTimeout(() => {
                    MessageSystem.show('🎲 محاولة الهروب من السجن...', 'info', 2000);
                    gameState.players[0].jailTurns = 1; // محاكاة محاولة واحدة
                    setTimeout(() => {
                        handleJailTurn(gameState.players[0]);
                    }, 1000);
                }, 3000);
            }, 1000);
            
            console.log('🏛️ اختبار السجن مكتمل!');
        }

        function testCardDemo() {
            console.log('🧪 بدء العرض التجريبي لنظام البطاقات');
            
            // إنشاء لاعب تجريبي إذا لم يكن موجود
            if (!gameState.players || gameState.players.length === 0) {
                gameState.players = [{
                    name: "لاعب تجريبي",
                    money: 1500,
                    position: 0,
                    properties: []
                }];
                gameState.currentPlayer = 0;
            }
            
            // اختبار بطاقة صدفة
            MessageSystem.show('🎲 اختبار بطاقة الصدفة...', 'info', 2000);
            setTimeout(() => {
                handleChanceCard(0);
            }, 1000);
            
            // اختبار بطاقة خزانة بعد 3 ثوان
            setTimeout(() => {
                MessageSystem.show('🏛️ اختبار بطاقة الخزانة...', 'info', 2000);
                setTimeout(() => {
                    handleCommunityCard(0);
                }, 1000);
            }, 3000);
            
            // طباعة تقرير النظام
            const testResult = testCardSystem();
            console.log('📊 تقرير نظام البطاقات:', testResult);
            
            return testResult;
        }

        function testCardSystem() {
            console.log('🧪 اختبار نظام السحب...');
            
            // اختبار بطاقة الصدفة
            console.log('📊 اختبار بطاقات الصدفة:', chanceCards.length, 'بطاقة');
            chanceCards.forEach((card, index) => {
                console.log(`${index + 1}. ${card.text}`);
            });
            
            // اختبار بطاقة الخزانة
            console.log('📊 اختبار بطاقات الخزانة:', communityCards.length, 'بطاقة');
            communityCards.forEach((card, index) => {
                console.log(`${index + 1}. ${card.text}`);
            });
            
            // اختبار سحب عشوائي
            const randomChance = chanceCards[Math.floor(Math.random() * chanceCards.length)];
            const randomCommunity = communityCards[Math.floor(Math.random() * communityCards.length)];
            
            console.log('🎲 بطاقة صدفة عشوائية:', randomChance.text);
            console.log('🏛️ بطاقة خزانة عشوائية:', randomCommunity.text);
            
            return {
                chanceCardsCount: chanceCards.length,
                communityCardsCount: communityCards.length,
                randomChance,
                randomCommunity,
                systemWorking: true
            };
        }

        // ===========================================
        // ميكانيكية اللعبة الاحترافية
        // ===========================================
        function rollDice() {
            if (!gameState.gameStarted) {
                MessageSystem.show('يجب بدء اللعبة أولاً!', 'error');
                return;
            }

            const player = gameState.players[gameState.currentPlayer];
            
            // فحص حالة السجن أولاً
            if (player.inJail) {
                handleJailTurn(player);
                return;
            }
            
            // تعطيل زر النرد أثناء الرمي
            document.getElementById('rollDice').disabled = true;
            
            // تأثير صوتي للترقب
            soundSystem.play('countdown');
            
            // أنيميشن رمي النرد
            showDiceAnimation(() => {
                const dice1 = Math.floor(Math.random() * 6) + 1;
                const dice2 = Math.floor(Math.random() * 6) + 1;
                const total = dice1 + dice2;
                const isDouble = dice1 === dice2;

                gameState.lastRoll = { dice1, dice2, total };

                // تحديث عرض النرد
                updateDiceDisplay(dice1, dice2);
                
                // تأثيرات صوتية مختلفة حسب النتيجة
                if (isDouble) {
                    soundSystem.play('bell');
                    gameState.doubles++;
                } else {
                    soundSystem.play('dice');
                    gameState.doubles = 0;
                }

                // عرض النتيجة مع تأثيرات
                let message = `🎲 ${player.name}: ${dice1} + ${dice2} = ${total}`;
                if (isDouble) {
                    message += ' - زوجي! 🎉';
                    confetti({
                        particleCount: 30,
                        spread: 60,
                        origin: { y: 0.8 }
                    });
                }
                
                MessageSystem.show(message, isDouble ? 'success' : 'dice', 4000);

                // فحص الزوجي الثلاثي (سجن)
                if (gameState.doubles >= 3) {
                    MessageSystem.show('🚨 ثلاثة زوجيات متتالية! اذهب للسجن!', 'error', 5000, true);
                    soundSystem.play('lose');
                    handleGoToJail(gameState.currentPlayer);
                    gameState.doubles = 0;
                    document.getElementById('rollDice').disabled = false;
                    return;
                }

                // فحص إنجاز النرد المحظوظ
                AchievementSystem.checkAchievement(player, 'lucky_roller', { consecutiveDoubles: gameState.doubles });

                // تحريك اللاعب
                setTimeout(() => {
                    movePlayer(gameState.currentPlayer, total);
                    
                    // إعادة تفعيل زر النرد
                    document.getElementById('rollDice').disabled = false;
                    
                    // إذا لم يكن زوجي، يمكن إنهاء الدور
                    if (!isDouble) {
                        document.getElementById('endTurn').disabled = false;
                    }
                }, 1000);
            });
        }

        function showDiceAnimation(callback) {
            let diceContainer = document.getElementById('diceContainer');
            if (!diceContainer) {
                diceContainer = createDiceContainer();
            }
            
            // أنيميشن الدوران
            diceContainer.classList.add('rolling');
            
            // محاكاة الرمي لمدة ثانيتين
            let rollCount = 0;
            const rollInterval = setInterval(() => {
                const tempDice1 = Math.floor(Math.random() * 6) + 1;
                const tempDice2 = Math.floor(Math.random() * 6) + 1;
                updateDiceDisplay(tempDice1, tempDice2);
                rollCount++;
                
                if (rollCount >= 20) {
                    clearInterval(rollInterval);
                    diceContainer.classList.remove('rolling');
                    callback();
                }
            }, 100);
        }

        function createDiceContainer() {
            const container = document.createElement('div');
            container.id = 'diceContainer';
            container.innerHTML = `
                <div class="dice-wrapper">
                    <div class="dice" id="dice1">⚀</div>
                    <div class="dice" id="dice2">⚀</div>
                </div>
            `;
            container.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 1000;
                pointer-events: none;
                background: rgba(0,0,0,0.8);
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            // إضافة أنماط النرد
            const diceStyle = document.createElement('style');
            diceStyle.textContent = `
                .dice-wrapper {
                    display: flex;
                    gap: 20px;
                    align-items: center;
                    justify-content: center;
                }
                .dice {
                    width: 60px;
                    height: 60px;
                    background: white;
                    border-radius: 10px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 40px;
                    color: #333;
                    border: 2px solid #ddd;
                    transition: all 0.1s ease;
                }
                .rolling .dice {
                    animation: diceRoll 0.1s infinite;
                }
                @keyframes diceRoll {
                    0% { transform: rotate(0deg); }
                    25% { transform: rotate(90deg); }
                    50% { transform: rotate(180deg); }
                    75% { transform: rotate(270deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(diceStyle);
            
            document.body.appendChild(container);
            return container;
        }

        function updateDiceDisplay(dice1, dice2) {
            const diceSymbols = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'];
            const dice1Element = document.getElementById('dice1');
            const dice2Element = document.getElementById('dice2');
            
            if (dice1Element && dice2Element) {
                dice1Element.textContent = diceSymbols[dice1 - 1];
                dice2Element.textContent = diceSymbols[dice2 - 1];
            }
        }

        function movePlayer(playerIndex, steps) {
            const player = gameState.players[playerIndex];
            const oldPosition = player.position;
            
            // حساب الموقع الجديد
            let newPosition = (player.position + steps) % 40;
            let passedStart = newPosition < oldPosition;
            
            // أنيميشن الحركة التدريجية
            animatePlayerMovement(playerIndex, oldPosition, steps, () => {
                player.position = newPosition;
                
                // فحص المرور بنقطة البداية
                if (passedStart) {
                    player.money += 200;
                    MessageSystem.showMoneyTransaction(player.name, 200, true);
                    MessageSystem.show('🎯 مررت بنقطة البداية! حصلت على 200 ر.ع', 'success', 4000);
                    soundSystem.play('bonus');
                    
                    // تأثير خاص للمرور بالبداية
                    confetti({
                        particleCount: 80,
                        spread: 90,
                        origin: { y: 0.7 },
                        colors: ['#00FF00', '#32CD32', '#7FFF00']
                    });
                }

                updatePlayersDisplay();
                updatePlayerPosition(playerIndex);
                handleSquareLanding(playerIndex, player.position);
            });
        }

        function animatePlayerMovement(playerIndex, startPos, steps, callback) {
            let currentStep = 0;
            const player = gameState.players[playerIndex];
            
            const moveStep = () => {
                if (currentStep >= steps) {
                    callback();
                    return;
                }
                
                currentStep++;
                const tempPosition = (startPos + currentStep) % 40;
                
                // تحديث الموقع المؤقت
                updatePlayerPosition(playerIndex, tempPosition);
                
                // تأثير صوتي للحركة
                if (currentStep % 2 === 0) {
                    soundSystem.play('select', 0.3);
                }
                
                // تأثير بصري للمربع الحالي
                highlightSquare(tempPosition);
                
                setTimeout(moveStep, 300); // سرعة الحركة
            };
            
            moveStep();
        }

        function updatePlayerPosition(playerIndex, position = null) {
            const player = gameState.players[playerIndex];
            const pos = position !== null ? position : player.position;
            const square = document.getElementById(`square-${pos}`);
            
            if (square) {
                // إزالة اللاعب من المواقع السابقة
                document.querySelectorAll('.player-token').forEach(token => {
                    if (token.dataset.player === playerIndex.toString()) {
                        token.remove();
                    }
                });
                
                // إضافة اللاعب للموقع الجديد
                const token = document.createElement('div');
                token.className = 'player-token';
                token.dataset.player = playerIndex;
                token.style.cssText = `
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, 
                        ${getPlayerColor(playerIndex)}, 
                        ${getDarkerColor(getPlayerColor(playerIndex))});
                    border: 2px solid white;
                    position: absolute;
                    bottom: ${5 + (playerIndex * 25)}px;
                    right: 5px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    animation: bounceIn 0.5s ease-out;
                    z-index: 100;
                `;
                token.textContent = (playerIndex + 1);
                token.style.color = 'white';
                token.style.fontSize = '12px';
                token.style.fontWeight = 'bold';
                token.style.display = 'flex';
                token.style.alignItems = 'center';
                token.style.justifyContent = 'center';
                
                square.appendChild(token);
            }
        }

        function highlightSquare(position) {
            // إزالة التمييز السابق
            document.querySelectorAll('.square-highlight').forEach(el => el.classList.remove('square-highlight'));
            
            // إضافة التمييز للمربع الحالي
            const square = document.getElementById(`square-${position}`);
            if (square) {
                square.classList.add('square-highlight');
                setTimeout(() => square.classList.remove('square-highlight'), 300);
            }
        }

        function getPlayerColor(playerIndex) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#F4A460', '#98D8C8'];
            return colors[playerIndex % colors.length];
        }

        function getDarkerColor(color) {
            // تحويل اللون لدرجة أغمق
            const hex = color.replace('#', '');
            const r = Math.max(0, parseInt(hex.substr(0, 2), 16) - 50);
            const g = Math.max(0, parseInt(hex.substr(2, 2), 16) - 50);
            const b = Math.max(0, parseInt(hex.substr(4, 2), 16) - 50);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function handleSquareLanding(playerIndex, position) {
            const player = gameState.players[playerIndex];
            const property = omanProperties[position];

            // تأثير بصري خاص للنزول
            const square = document.getElementById(`square-${position}`);
            if (square) {
                square.classList.add('landing-effect');
                setTimeout(() => square.classList.remove('landing-effect'), 1000);
            }

            // رسالة الهبوط مع تأثير صوتي
            MessageSystem.show(`🎯 ${player.name} هبط على ${property.name}`, 'info', 3000);
            soundSystem.play('bell', 0.5);

            switch (property.type) {
                case 'property':
                case 'airport':
                case 'utility':
                    handlePropertyLanding(playerIndex, property);
                    break;
                case 'tax':
                    handleTax(playerIndex, property.price);
                    break;
                case 'chance':
                    handleChanceCard(playerIndex);
                    break;
                case 'community':
                    handleCommunityCard(playerIndex);
                    break;
                case 'go-to-jail':
                    handleGoToJail(playerIndex);
                    break;
                case 'start':
                    // تأثير خاص للهبوط على البداية
                    confetti({
                        particleCount: 60,
                        spread: 80,
                        origin: { y: 0.8 }
                    });
                    break;
                case 'jail':
                    MessageSystem.show('🏛️ مجرد زيارة للسجن!', 'info');
                    break;
                case 'free':
                    MessageSystem.show('🅿️ موقف مجاني - استرح!', 'success');
                    soundSystem.play('bonus', 0.7);
                    break;
            }

            // تحديث اللوحة القيادية
            LeaderboardSystem.updateLeaderboard();
        }

        function handlePropertyLanding(playerIndex, property) {
            const player = gameState.players[playerIndex];
            
            // التحقق من ملكية العقار
            const owner = gameState.players.find(p => p.properties.includes(property.id));
            
            if (!owner) {
                // العقار متاح للشراء
                showPropertyPurchaseDialog(playerIndex, player, property);
            } else if (owner !== player) {
                // دفع إيجار
                const rent = calculateRent(property, owner);
                handleRentPayment(player, owner, property, rent);
            } else {
                // العقار مملوك للاعب نفسه
                MessageSystem.show(`🏠 ${property.name} مملوك لك بالفعل!`, 'info');
                soundSystem.play('select', 0.5);
            }
        }

        function showPropertyPurchaseDialog(playerIndex, player, property) {
            // التحقق من صحة بيانات اللاعب
            validatePlayerData(player);
            
            if (player.money < property.price) {
                MessageSystem.show(`💸 ليس لديك مال كافٍ لشراء ${property.name}! تحتاج ${formatMoney(property.price)}`, 'error', 5000);
                soundSystem.play('lose');
                return;
            }

            // إنشاء نافذة شراء تفاعلية
            const modal = document.createElement('div');
            modal.className = 'purchase-modal';
            modal.innerHTML = `
                <div class="purchase-content">
                    <h2>🏠 شراء ${property.name}</h2>
                    <div class="property-details">
                        <p><strong>السعر:</strong> ${formatMoney(property.price)}</p>
                        <p><strong>المالك الحالي:</strong> غير مملوك</p>
                        <p><strong>رصيدك:</strong> ${formatMoney(player.money)}</p>
                        <p><strong>الرصيد بعد الشراء:</strong> ${formatMoney(player.money - property.price)}</p>
                    </div>
                    <div class="purchase-buttons">
                        <button onclick="purchaseProperty(${playerIndex}, ${property.id})" class="btn-purchase">
                            💰 شراء
                        </button>
                        <button onclick="closePurchaseModal()" class="btn-decline">
                            ❌ رفض
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;

            document.body.appendChild(modal);
            soundSystem.play('notification');
        }

        function purchaseProperty(playerIndex, propertyId) {
            const player = gameState.players[playerIndex];
            const property = omanProperties[propertyId];
            
            // التحقق من كفاية المال
            if (player.money < property.price) {
                MessageSystem.show(`💸 ليس لديك مال كافٍ لشراء ${property.name}!`, 'error');
                closePurchaseModal();
                return;
            }

            player.money -= property.price;
            player.properties.push(propertyId);
            
            // إغلاق النافذة
            closePurchaseModal();
            
            // رسائل وتأثيرات النجاح
            MessageSystem.showPropertyPurchase(player.name, property.name, property.price);
            soundSystem.playSequence(['buy', 'bonus'], 300);
            
            // تأثير بصري للشراء
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.7 },
                colors: ['#FFD700', '#FFA500', '#FF8C00']
            });

            // تحديث مظهر العقارات
            updatePropertyDisplay();

            // فحص الإنجازات
            AchievementSystem.checkAchievement(player, 'first_property');
            AchievementSystem.checkAchievement(player, 'millionaire');
            AchievementSystem.checkAchievement(player, 'monopoly_master');

            updatePlayersDisplay();
            LeaderboardSystem.updateLeaderboard();
        }

        function closePurchaseModal() {
            const modal = document.querySelector('.purchase-modal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-in';
                setTimeout(() => modal.remove(), 300);
            }
        }

        function handleRentPayment(payer, receiver, property, rent) {
            payer.money -= rent;
            receiver.money += rent;
            
            MessageSystem.showRentPayment(payer.name, receiver.name, property.name, rent);
            soundSystem.play('lose');
            
            // تأثير بصري لدفع الإيجار
            const payerElement = document.querySelector(`[data-player="${gameState.players.indexOf(payer)}"]`);
            if (payerElement) {
                payerElement.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => payerElement.style.animation = '', 500);
            }

            // فحص الإفلاس بعد دفع الإيجار باستخدام النظام المحسن
            const payerIndex = gameState.players.indexOf(payer);
            const isBankrupt = checkBankruptcyAfterPayment(payerIndex);
            
            if (!isBankrupt) {
                updatePlayersDisplay();
            }
            // إذا كان مفلس، الدالة ستتولى العرض والانتقال
        }

        function calculateRent(property, owner) {
            if (property.type === 'property') {
                return property.rent[0]; // إيجار أساسي (يمكن تطويره لاحقاً)
            } else if (property.type === 'airport') {
                const airportsOwned = owner.properties.filter(id => 
                    omanProperties[id].type === 'airport'
                ).length;
                return property.rent[airportsOwned - 1];
            } else if (property.type === 'utility') {
                const utilitiesOwned = owner.properties.filter(id => 
                    omanProperties[id].type === 'utility'
                ).length;
                return (utilitiesOwned === 1 ? 4 : 10) * (Math.floor(Math.random() * 6) + 1 + Math.floor(Math.random() * 6) + 1);
            }
            return 0;
        }

        function handleTax(playerIndex, amount) {
            const player = gameState.players[playerIndex];
            player.money -= amount;
            MessageSystem.show(`دفعت ${amount} ر.ع ضريبة`, 'error');
            soundSystem.play('lose');
            
            // فحص الإفلاس بعد دفع الضريبة
            const isBankrupt = checkBankruptcyAfterPayment(playerIndex);
            
            if (!isBankrupt) {
                updatePlayersDisplay();
            }
        }

        // بطاقات الصدفة والخزانة العامة
        const chanceCards = [
            { text: "🎉 تقدم إلى البداية واحصل على 200 ر.ع", action: "goToStart" },
            { text: "🏠 تقدم إلى مسقط العاصمة", action: "goToProperty", property: 1 },
            { text: "💰 احصل على 150 ر.ع مكافأة", action: "money", amount: 150 },
            { text: "📄 ادفع 50 ر.ع ضريبة", action: "money", amount: -50 },
            { text: "🚗 تقدم إلى أقرب مطار", action: "goToNearestAirport" },
            { text: "⬅️ ارجع 3 مربعات", action: "moveBack", spaces: 3 },
            { text: "🏛️ اذهب إلى السجن مباشرة", action: "goToJail" },
            { text: "🎁 احصل على 100 ر.ع من كل لاعب", action: "collectFromPlayers", amount: 100 },
            { text: "🔧 ادفع 40 ر.ع لكل منزل و 115 ر.ع لكل فندق", action: "payForBuildings" },
            { text: "🎯 تقدم إلى صلالة", action: "goToProperty", property: 11 },
            { text: "🏦 احصل على 200 ر.ع من البنك", action: "money", amount: 200 },
            { text: "🚫 ادفع غرامة 15 ر.ع", action: "money", amount: -15 }
        ];

        const communityCards = [
            { text: "🎓 حصلت على منحة دراسية - احصل على 200 ر.ع", action: "money", amount: 200 },
            { text: "🏥 ادفع فاتورة المستشفى 100 ر.ع", action: "money", amount: -100 },
            { text: "📈 أرباح استثمارك - احصل على 50 ر.ع", action: "money", amount: 50 },
            { text: "🎂 عيد ميلادك - احصل على 10 ر.ع من كل لاعب", action: "collectFromPlayers", amount: 10 },
            { text: "🚗 غرامة سرعة - ادفع 50 ر.ع", action: "money", amount: -50 },
            { text: "💼 مكافأة خدمات - احصل على 100 ر.ع", action: "money", amount: 100 },
            { text: "🏛️ اذهب إلى السجن مباشرة", action: "goToJail" },
            { text: "🎉 تقدم إلى البداية واحصل على 200 ر.ع", action: "goToStart" },
            { text: "🏠 ادفع 40 ر.ع لكل منزل و 115 ر.ع لكل فندق", action: "payForBuildings" },
            { text: "📄 ضريبة الدخل - ادفع 200 ر.ع", action: "money", amount: -200 },
            { text: "🎁 وراثة - احصل على 100 ر.ع", action: "money", amount: 100 },
            { text: "💳 خطأ بنكي لصالحك - احصل على 75 ر.ع", action: "money", amount: 75 }
        ];

        function handleChanceCard(playerIndex) {
            console.log('🎲 تفعيل بطاقة الصدفة للاعب:', playerIndex);
            const card = chanceCards[Math.floor(Math.random() * chanceCards.length)];
            console.log('البطاقة المختارة:', card);
            showCardModal(playerIndex, card, 'chance');
        }

        function handleCommunityCard(playerIndex) {
            console.log('🏛️ تفعيل بطاقة الخزانة العامة للاعب:', playerIndex);
            const card = communityCards[Math.floor(Math.random() * communityCards.length)];
            console.log('البطاقة المختارة:', card);
            showCardModal(playerIndex, card, 'community');
        }

        function showCardModal(playerIndex, card, type) {
            const player = gameState.players[playerIndex];
            const cardTitle = type === 'chance' ? '🎲 بطاقة الصدفة' : '🏛️ صندوق الخزانة العامة';
            const cardColor = type === 'chance' ? '#e74c3c' : '#3498db';

            const modal = document.createElement('div');
            modal.className = 'card-modal';
            modal.innerHTML = `
                <div class="card-content" style="border-color: ${cardColor}">
                    <h2 style="color: white !important">${cardTitle}</h2>
                    <div class="card-text">
                        <p>${card.text}</p>
                    </div>
                    <div class="card-player">
                        <strong>${player.name}</strong>
                    </div>
                    <button onclick="executeCardAction(${playerIndex}, '${encodeURIComponent(JSON.stringify(card))}', '${type}')" 
                            class="btn-execute" style="background: ${cardColor}">
                        ✨ تنفيذ البطاقة
                    </button>
                </div>
            `;

            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: cardSlideIn 0.5s ease-out;
            `;

            document.body.appendChild(modal);
            soundSystem.play('reveal');
        }

        function executeCardAction(playerIndex, encodedCardData, type) {
            const player = gameState.players[playerIndex];
            const card = JSON.parse(decodeURIComponent(encodedCardData));

            // إغلاق النافذة مع تأثير
            const modal = document.querySelector('.card-modal');
            if (modal) {
                modal.style.animation = 'cardSlideOut 0.3s ease-in';
                setTimeout(() => modal.remove(), 300);
            }

            // تأثير صوتي للتنفيذ
            soundSystem.play('select');

            setTimeout(() => {
                switch (card.action) {
                    case 'money':
                        handleMoneyChange(playerIndex, card.amount);
                        break;
                    case 'goToStart':
                        movePlayerToPosition(playerIndex, 0);
                        player.money += 200; // مكافأة المرور من البداية
                        MessageSystem.show(`🎉 ${player.name} وصل للبداية وحصل على 200 ر.ع!`, 'success');
                        soundSystem.play('bonus');
                        break;
                    case 'goToProperty':
                        movePlayerToPosition(playerIndex, card.property);
                        break;
                    case 'goToJail':
                        handleGoToJail(playerIndex);
                        break;
                    case 'goToNearestAirport':
                        moveToNearestAirport(playerIndex);
                        break;
                    case 'moveBack':
                        movePlayerBack(playerIndex, card.spaces);
                        break;
                    case 'collectFromPlayers':
                        collectFromAllPlayers(playerIndex, card.amount);
                        break;
                    case 'payForBuildings':
                        payForBuildings(playerIndex);
                        break;
                }

                updatePlayersDisplay();
                LeaderboardSystem.updateLeaderboard();
            }, 500);
        }

        function handleMoneyChange(playerIndex, amount) {
            const player = gameState.players[playerIndex];
            const oldMoney = player.money;
            player.money += amount;

            if (amount > 0) {
                MessageSystem.show(`💰 ${player.name} حصل على ${amount} ر.ع!`, 'success');
                soundSystem.play('bonus');
                confetti({
                    particleCount: 50,
                    spread: 60,
                    origin: { y: 0.8 },
                    colors: ['#FFD700', '#32CD32']
                });
            } else {
                MessageSystem.show(`💸 ${player.name} دفع ${Math.abs(amount)} ر.ع!`, 'error');
                soundSystem.play('lose');
                
                // فحص الإفلاس
                if (player.money < 0) {
                    handleBankruptcy(playerIndex, Math.abs(amount));
                }
            }
        }

        // نظام الإفلاس المتطور
        function handleBankruptcy(playerIndex, debtAmount) {
            const player = gameState.players[playerIndex];
            const debt = Math.abs(player.money); // المبلغ السالب
            
            console.log(`💸 ${player.name} مفلس! الدين: ${debt} ر.ع`);
            
            // حساب القيمة الإجمالية لممتلكات اللاعب
            const totalAssets = calculatePlayerAssets(player);
            
            if (totalAssets >= debt) {
                // يمكن إنقاذه ببيع الممتلكات
                showBankruptcyOptions(playerIndex, debt, totalAssets);
            } else {
                // إفلاس نهائي فوري
                console.log(`💔 ${player.name} - إفلاس نهائي! الممتلكات غير كافية`);
                declareBankruptcy(playerIndex);
            }
        }

        // فحص الإفلاس الذكي - يتم استدعاؤه بعد أي عملية دفع
        function checkBankruptcyAfterPayment(playerIndex) {
            const player = gameState.players[playerIndex];
            
            if (player.money < 0 && !player.isBankrupt) {
                console.log(`🚨 اكتشاف مال سالب لـ ${player.name}: ${player.money} ر.ع`);
                setTimeout(() => {
                    handleBankruptcy(playerIndex, Math.abs(player.money));
                }, 500); // تأخير صغير للسماح بانتهاء العمليات الأخرى
                return true; // يشير إلى وجود إفلاس
            }
            return false; // لا يوجد إفلاس
        }

        function calculatePlayerAssets(player) {
            let totalValue = 0;
            
            // قيمة العقارات (نصف السعر الأصلي)
            if (player.properties) {
                player.properties.forEach(propId => {
                    const property = omanProperties.find(p => p.id === propId);
                    if (property) {
                        totalValue += Math.floor(property.price * 0.5); // بيع بنصف السعر
                    }
                });
            }
            
            return totalValue;
        }

        function showBankruptcyOptions(playerIndex, debt, totalAssets) {
            const player = gameState.players[playerIndex];
            
            const modal = document.createElement('div');
            modal.className = 'bankruptcy-modal';
            modal.innerHTML = `
                <div class="bankruptcy-content">
                    <div class="bankruptcy-header">
                        <h2 style="color: #e74c3c;">💸 إنذار إفلاس!</h2>
                        <div class="bankruptcy-warning">
                            ⚠️ ${player.name} لا يملك مالاً كافياً!
                        </div>
                    </div>
                    
                    <div class="bankruptcy-details">
                        <div class="debt-info">
                            <div class="debt-label">💰 المبلغ المطلوب:</div>
                            <div class="debt-amount">${formatMoney(debt)}</div>
                        </div>
                        
                        <div class="assets-info">
                            <div class="assets-label">🏠 قيمة الممتلكات:</div>
                            <div class="assets-amount">${formatMoney(totalAssets)}</div>
                        </div>
                        
                        <div class="current-money">
                            <div class="money-label">💸 الرصيد الحالي:</div>
                            <div class="money-amount negative">${formatMoney(player.money)}</div>
                        </div>
                    </div>
                    
                    <div class="bankruptcy-options">
                        <button onclick="sellProperties(${playerIndex}, ${debt})" class="bankruptcy-btn sell-btn">
                            🏠 بيع الممتلكات
                            <small>بيع العقارات لسداد الدين</small>
                        </button>
                        
                        <button onclick="declareBankruptcy(${playerIndex})" class="bankruptcy-btn bankrupt-btn">
                            💔 إعلان الإفلاس
                            <small>الخروج من اللعبة</small>
                        </button>
                        
                        <div class="bankruptcy-help">
                            💡 يمكنك بيع عقاراتك بنصف السعر الأصلي لسداد الدين
                            <br>⏰ سيتم إعلان الإفلاس تلقائياً خلال 30 ثانية
                        </div>
                    </div>
                </div>
            `;

            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: bankruptcySlideIn 0.5s ease-out;
            `;

            document.body.appendChild(modal);
            soundSystem.play('lose');

            // إفلاس تلقائي بعد 30 ثانية لمنع التعليق
            setTimeout(() => {
                const stillOpen = document.querySelector('.bankruptcy-modal');
                if (stillOpen) {
                    console.log('⏰ إفلاس تلقائي بعد انتهاء الوقت');
                    declareBankruptcy(playerIndex);
                }
            }, 30000);
        }

        function sellProperties(playerIndex, debt) {
            const player = gameState.players[playerIndex];
            let totalSold = 0;
            const soldProperties = [];

            // بيع العقارات واحداً تلو الآخر حتى سداد الدين
            if (player.properties) {
                for (let i = player.properties.length - 1; i >= 0 && (player.money + totalSold) < 0; i--) {
                    const propId = player.properties[i];
                    const property = omanProperties.find(p => p.id === propId);
                    
                    if (property) {
                        const sellPrice = Math.floor(property.price * 0.5);
                        totalSold += sellPrice;
                        soldProperties.push(property.name);
                        
                        // إزالة العقار من ملكية اللاعب
                        player.properties.splice(i, 1);
                        
                        // إزالة ملكية العقار من نظام اللعبة
                        delete gameState.propertyOwners[propId];
                    }
                }
            }

            // إضافة المال المحصل من البيع
            player.money += totalSold;

            // إغلاق نافذة الإفلاس
            const modal = document.querySelector('.bankruptcy-modal');
            if (modal) modal.remove();

            // عرض نتيجة البيع
            if (player.money >= 0) {
                MessageSystem.show(`🏠 ${player.name} باع عقاراته مقابل ${formatMoney(totalSold)} وتجنب الإفلاس!`, 'success');
                soundSystem.play('victory');
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.8 },
                    colors: ['#27AE60', '#F39C12']
                });
            } else {
                MessageSystem.show(`💸 البيع لم يكفِ! ${player.name} ما زال مديناً بـ ${formatMoney(Math.abs(player.money))}`, 'error');
                // لا يزال مفلساً
                setTimeout(() => {
                    declareBankruptcy(playerIndex);
                }, 2000);
            }

            updatePlayersDisplay();
            LeaderboardSystem.updateLeaderboard();
        }

        function declareBankruptcy(playerIndex) {
            const player = gameState.players[playerIndex];
            
            // إغلاق أي نوافذ مفتوحة
            const modal = document.querySelector('.bankruptcy-modal');
            if (modal) modal.remove();

            // إعلان الإفلاس
            MessageSystem.show(`💔 ${player.name} أعلن إفلاسه وخرج من اللعبة!`, 'error', 8000, true);
            soundSystem.play('lose');

            // تحرير جميع ممتلكات اللاعب
            if (player.properties) {
                player.properties.forEach(propId => {
                    delete gameState.propertyOwners[propId];
                });
            }

            // وضع علامة الإفلاس
            player.isBankrupt = true;
            player.money = 0;
            player.properties = [];

            // تأثيرات بصرية للإفلاس
            createBankruptcyEffect(player.name);

            // فحص إذا بقي لاعب واحد فقط
            const activePlayers = gameState.players.filter(p => !p.isBankrupt);
            if (activePlayers.length === 1) {
                // فوز بالإفلاس
                setTimeout(() => {
                    handleGameWin(activePlayers[0]);
                }, 3000);
                return;
            } else if (activePlayers.length === 0) {
                // جميع اللاعبين مفلسون (نادر جداً)
                MessageSystem.show('🏦 جميع اللاعبين أفلسوا! البنك يفوز! 😅', 'info', 8000);
                return;
            }

            updatePlayersDisplay();
            LeaderboardSystem.updateLeaderboard();

            // إذا كان اللاعب المفلس هو اللاعب الحالي، الانتقال للدور التالي
            if (playerIndex === gameState.currentPlayer) {
                console.log('🔄 انتقال تلقائي للدور التالي بعد الإفلاس');
                setTimeout(() => {
                    nextTurn();
                    // تفعيل زر رمي النرد للاعب الجديد
                    document.getElementById('rollDice').disabled = false;
                    document.getElementById('endTurn').disabled = true;
                }, 2000);
            }
        }

        function createBankruptcyEffect(playerName) {
            // تأثير بصري للإفلاس
            const effect = document.createElement('div');
            effect.innerHTML = `
                <div style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(45deg, #e74c3c, #c0392b);
                    color: white;
                    padding: 30px;
                    border-radius: 20px;
                    text-align: center;
                    z-index: 10001;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.5);
                    animation: bankruptcyExplosion 3s ease-out forwards;
                ">
                    <div style="font-size: 3em;">💔</div>
                    <div style="font-size: 1.5em; margin: 10px 0;">${playerName}</div>
                    <div style="font-size: 2em; font-weight: bold;">مُفلِس!</div>
                </div>
            `;
            
            document.body.appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 3000);
        }

        function moveToNearestAirport(playerIndex) {
            const player = gameState.players[playerIndex];
            const airports = [5, 15, 25, 35]; // مواقع المطارات
            let nearestAirport = airports[0];
            let minDistance = Math.abs(player.position - airports[0]);

            airports.forEach(airport => {
                const distance = (airport - player.position + 40) % 40;
                if (distance < minDistance) {
                    nearestAirport = airport;
                    minDistance = distance;
                }
            });

            movePlayerToPosition(playerIndex, nearestAirport);
        }

        function collectFromAllPlayers(playerIndex, amount) {
            const player = gameState.players[playerIndex];
            let totalCollected = 0;

            gameState.players.forEach((otherPlayer, index) => {
                if (index !== playerIndex) {
                    const payment = Math.min(amount, otherPlayer.money);
                    otherPlayer.money -= payment;
                    totalCollected += payment;
                }
            });

            player.money += totalCollected;
            MessageSystem.show(`💰 ${player.name} جمع ${totalCollected} ر.ع من اللاعبين!`, 'success');
            soundSystem.play('win');
        }

        function handleSpecialCard(playerIndex, cardType) {
            if (cardType === 'chance') {
                handleChanceCard(playerIndex);
            } else {
                handleCommunityCard(playerIndex);
            }
        }

        function movePlayerBack(playerIndex, spaces) {
            const player = gameState.players[playerIndex];
            const newPosition = (player.position - spaces + 40) % 40;
            movePlayerToPosition(playerIndex, newPosition);
        }

        function movePlayerToPosition(playerIndex, targetPosition) {
            const player = gameState.players[playerIndex];
            const oldPosition = player.position;
            
            // إذا مر من البداية، احصل على 200 ر.ع
            if (targetPosition < oldPosition && targetPosition !== 0) {
                player.money += 200;
                MessageSystem.show(`💰 ${player.name} مر من البداية وحصل على 200 ر.ع!`, 'success');
            }
            
            player.position = targetPosition;
            animatePlayerMovement(playerIndex, oldPosition, targetPosition, () => {
                handleSquareLanding(playerIndex, targetPosition);
            });
        }

        function payForBuildings(playerIndex) {
            const player = gameState.players[playerIndex];
            // حساب تكلفة المباني (سيتم تطوير نظام البناء لاحقاً)
            const houseCost = 40;
            const hotelCost = 115;
            
            // للآن، سيتم دفع مبلغ ثابت
            const totalCost = 100;
            player.money -= totalCost;
            
            MessageSystem.show(`🏠 ${player.name} دفع ${totalCost} ر.ع رسوم صيانة!`, 'error');
            soundSystem.play('lose');
        }

        function handleTax(playerIndex, amount) {
            const player = gameState.players[playerIndex];
            player.money -= amount;
            
            MessageSystem.show(`📄 ${player.name} دفع ${amount} ر.ع ضريبة!`, 'error');
            soundSystem.play('lose');
            
            // تأثير بصري للضريبة
            const playerElement = document.querySelector(`[data-player="${playerIndex}"]`);
            if (playerElement) {
                playerElement.classList.add('shake');
                setTimeout(() => playerElement.classList.remove('shake'), 500);
            }
            
            updatePlayersDisplay();
        }

        function handleGoToJail(playerIndex) {
            const player = gameState.players[playerIndex];
            const oldPosition = player.position;
            player.position = 10; // موقع السجن
            player.inJail = true;
            player.jailTurns = 0;
            
            MessageSystem.show(`🏛️ ${player.name} ذهب إلى السجن!`, 'error');
            soundSystem.play('lose');
            
            // تحريك اللاعب إلى السجن مع تأثير خاص
            animatePlayerMovement(playerIndex, oldPosition, 10, () => {
                const jailSquare = document.getElementById('square-10');
                if (jailSquare) {
                    jailSquare.classList.add('pulse-effect');
                    setTimeout(() => jailSquare.classList.remove('pulse-effect'), 600);
                }
            });
            
            updatePlayersDisplay();
        }

        // نظام السجن المتطور
        function handleJailTurn(player) {
            player.jailTurns++;
            
            // تعطيل زر النرد أثناء المعالجة
            document.getElementById('rollDice').disabled = true;
            
            MessageSystem.show(`🏛️ ${player.name} في السجن - المحاولة ${player.jailTurns}/3`, 'warning', 3000);
            
            // عرض خيارات الخروج من السجن
            showJailOptions(player);
        }

        function showJailOptions(player) {
            const modal = document.createElement('div');
            modal.className = 'jail-modal';
            modal.innerHTML = `
                <div class="jail-content">
                    <h2 style="color: #e74c3c;">🏛️ ${player.name} في السجن</h2>
                    <p>المحاولة ${player.jailTurns} من 3</p>
                    
                    <div class="jail-options">
                        <button onclick="tryJailEscape('dice')" class="jail-btn jail-btn-try">
                            🎲 رمي النرد للخروج
                            <small>تحتاج زوجي للخروج</small>
                        </button>
                        
                        <button onclick="tryJailEscape('pay')" class="jail-btn jail-btn-pay">
                            💰 دفع كفالة 50 ر.ع
                            <small>الخروج فوراً</small>
                        </button>
                        
                        ${player.jailTurns >= 3 ? `
                            <div style="background: #e74c3c; color: white; padding: 10px; border-radius: 10px; margin-top: 10px;">
                                ⚠️ محاولتك الأخيرة! سيتم إجبارك على الدفع إذا فشلت.
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;

            document.body.appendChild(modal);
            soundSystem.play('notification');
        }

        function tryJailEscape(method) {
            const player = gameState.players[gameState.currentPlayer];
            const modal = document.querySelector('.jail-modal');
            
            if (method === 'pay') {
                // دفع الكفالة
                if (player.money >= 50) {
                    player.money -= 50;
                    releaseFromJail(player, 'paid');
                } else {
                    MessageSystem.show('💸 ليس لديك مال كافٍ للكفالة!', 'error');
                    return;
                }
            } else if (method === 'dice') {
                // رمي النرد للخروج
                const dice1 = Math.floor(Math.random() * 6) + 1;
                const dice2 = Math.floor(Math.random() * 6) + 1;
                const isDouble = dice1 === dice2;
                
                updateDiceDisplay(dice1, dice2);
                
                if (isDouble) {
                    // نجح في الخروج
                    releaseFromJail(player, 'escaped');
                    // يتحرك بالنرد المرمي
                    setTimeout(() => {
                        movePlayer(gameState.currentPlayer, dice1 + dice2);
                    }, 1000);
                } else {
                    // فشل في الخروج
                    if (player.jailTurns >= 3) {
                        // إجباري على الدفع
                        MessageSystem.show('💸 المحاولة الأخيرة فشلت! دفع إجباري للكفالة.', 'error');
                        if (player.money >= 50) {
                            player.money -= 50;
                            releaseFromJail(player, 'forced');
                            // يتحرك بالنرد المرمي
                            setTimeout(() => {
                                movePlayer(gameState.currentPlayer, dice1 + dice2);
                            }, 1000);
                        } else {
                            MessageSystem.show('💸 لا يمكنك دفع الكفالة! ستبقى في السجن.', 'error');
                            setTimeout(() => {
                                nextTurn();
                            }, 2000);
                        }
                    } else {
                        MessageSystem.show(`🚫 فشل الهروب! النرد: ${dice1} + ${dice2}`, 'error');
                        setTimeout(() => {
                            nextTurn();
                        }, 2000);
                    }
                }
            }
            
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-in';
                setTimeout(() => modal.remove(), 300);
            }
        }

        function releaseFromJail(player, method) {
            player.inJail = false;
            player.jailTurns = 0;
            
            let message = '';
            switch (method) {
                case 'paid':
                    message = `💰 ${player.name} دفع 50 ر.ع وخرج من السجن!`;
                    soundSystem.play('coin');
                    break;
                case 'escaped':
                    message = `🎉 ${player.name} هرب من السجن بزوجي!`;
                    soundSystem.play('victory');
                    confetti({
                        particleCount: 50,
                        spread: 60,
                        origin: { y: 0.8 }
                    });
                    break;
                case 'forced':
                    message = `💸 ${player.name} أُجبر على دفع الكفالة!`;
                    soundSystem.play('lose');
                    break;
            }
            
            MessageSystem.show(message, method === 'escaped' ? 'success' : 'info');
            updatePlayersDisplay();
            
            // إعادة تفعيل زر النرد
            document.getElementById('rollDice').disabled = false;
        }

        // نظام حساب الإيجار المحترف
        function calculateRent(property, owner) {
            let baseRent = property.rent;
            
            // إذا كان المالك يملك مجموعة كاملة
            if (hasMonopoly(owner, property)) {
                baseRent *= 2;
            }
            
            // إضافة تكلفة المباني (سيتم تطوير هذا لاحقاً)
            // baseRent += (property.houses * property.houseRent);
            // if (property.hotel) baseRent = property.hotelRent;
            
            return baseRent;
        }

        function hasMonopoly(player, property) {
            const colorGroup = getColorGroup(property.id);
            return colorGroup.every(propId => player.properties.includes(propId));
        }

        function getColorGroup(propertyId) {
            // مجموعات الألوان في المونوبولي العماني
            const colorGroups = {
                brown: [1, 3],
                lightBlue: [6, 8, 9],
                pink: [11, 13, 14],
                orange: [16, 18, 19],
                red: [21, 23, 24],
                yellow: [26, 27, 29],
                green: [31, 32, 34],
                blue: [37, 39]
            };
            
            for (const [color, properties] of Object.entries(colorGroups)) {
                if (properties.includes(propertyId)) {
                    return properties;
                }
            }
            return [];
        }

        // ====================================
        // نظام اللعب المحترف والتنافسي
        // ====================================

        function nextTurn() {
            // تحديث اللوحة القيادية
            LeaderboardSystem.updateLeaderboard();
            
            // فحص شرط الفوز
            const winner = checkWinCondition();
            if (winner) {
                handleGameWin(winner);
                return;
            }

            // البحث عن اللاعب التالي غير المفلس
            let attempts = 0;
            do {
                gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
                attempts++;
                
                // إذا عاد للاعب الأول، زيادة المرحلة
                if (gameState.currentPlayer === 0) {
                    gameState.currentRound++;
                    MessageSystem.show(`🔄 بداية المرحلة ${gameState.currentRound}`, 'info', 3000);
                    soundSystem.play('notification');
                }
                
                // منع اللولب اللانهائي
                if (attempts >= gameState.players.length) {
                    console.error('جميع اللاعبين مفلسون!');
                    break;
                }
            } while (gameState.players[gameState.currentPlayer].isBankrupt);
            
            // تمييز اللاعب الحالي
            LeaderboardSystem.highlightCurrentPlayer();
            
            // إشعار بدور اللاعب الجديد
            const currentPlayer = gameState.players[gameState.currentPlayer];
            MessageSystem.show(`🎯 دور ${currentPlayer.name}`, 'success', 4000);
            
            // تأثيرات صوتية لتغيير الدور
            soundSystem.play('select');
            setTimeout(() => {
                soundSystem.play('notification');
            }, 500);
            
            // تأثير بصري لتمييز اللاعب الحالي
            highlightCurrentPlayerOnBoard();
            addBoardTurnEffect();
            
            // تحديث جميع واجهات المستخدم
            updatePlayersDisplay();
            updateGameInfo();
            updateButtonStates();
            
            // تحديث فوري للبطاقات
            setTimeout(() => {
                updatePlayerCardHighlight();
            }, 100);
        }

        function checkWinCondition() {
            // فحص إذا كان هناك لاعب واحد فقط لم يفلس
            const activePlayers = gameState.players.filter(player => !player.isBankrupt);
            if (activePlayers.length === 1) {
                return activePlayers[0];
            }
            
            // فحص إذا لم يبق أي لاعب نشط (حالة نادرة)
            if (activePlayers.length === 0) {
                // البنك يفوز!
                return { name: "البنك المركزي العُماني", isBank: true };
            }
            
            // فحص إذا وصلت اللعبة لحد زمني معين (مثلاً 20 مرحلة)
            if (gameState.currentRound >= 20) {
                // إرجاع اللاعب الأغنى من اللاعبين النشطين
                return activePlayers.reduce((richest, player) => {
                    const playerNetWorth = LeaderboardSystem.calculateNetWorth(player);
                    const richestNetWorth = LeaderboardSystem.calculateNetWorth(richest);
                    return playerNetWorth > richestNetWorth ? player : richest;
                });
            }
            
            return null;
        }

        function handleGameWin(winner) {
            // تأثيرات الفوز الرائعة
            soundSystem.playSequence(['win', 'firework'], 1000);
            
            // عرض شاشة الفوز
            showWinnerScreen(winner);
            
            // تأثيرات بصرية للفوز
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 },
                        colors: ['#FFD700', '#FFA500', '#FF6B35', '#4ECDC4', '#45B7D1']
                    });
                }, i * 300);
            }
            
            // حفظ الإنجازات
            AchievementSystem.checkAchievement(winner, 'game_winner');
            AchievementSystem.saveProgress();
        }

        function showWinnerScreen(winner) {
            const modal = document.createElement('div');
            modal.className = 'winner-modal';
            modal.innerHTML = `
                <div class="winner-content">
                    <h1>🏆 مبروك الفوز! 🏆</h1>
                    <div class="winner-info">
                        <h2>${winner.name}</h2>
                        <p>الفائز بلعبة مونوبولي عُمان!</p>
                        <div class="winner-stats">
                            <div class="stat">
                                <span>💰 الأموال النهائية:</span>
                                <span>${winner.money} ر.ع</span>
                            </div>
                            <div class="stat">
                                <span>🏠 العقارات المملوكة:</span>
                                <span>${winner.properties.length}</span>
                            </div>
                            <div class="stat">
                                <span>📊 القيمة الصافية:</span>
                                <span>${LeaderboardSystem.calculateNetWorth(winner)} ر.ع</span>
                            </div>
                        </div>
                    </div>
                    <div class="winner-actions">
                        <button onclick="restartGame()" class="btn-restart">
                            🔄 لعبة جديدة
                        </button>
                        <button onclick="showFinalLeaderboard()" class="btn-leaderboard">
                            📊 النتائج النهائية
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.5s ease-out;
            `;
            
            document.body.appendChild(modal);
        }

        function updateButtonStates() {
            const rollDiceBtn = document.getElementById('rollDice');
            const endTurnBtn = document.getElementById('endTurn');
            
            if (!rollDiceBtn || !endTurnBtn) return;
            
            if (!gameState.gameStarted) {
                rollDiceBtn.disabled = true;
                endTurnBtn.disabled = true;
                rollDiceBtn.textContent = '🎲 في انتظار البدء';
                endTurnBtn.textContent = '⏸️ متوقف';
            } else {
                const currentPlayer = gameState.players[gameState.currentPlayer];
                rollDiceBtn.textContent = `🎲 ${currentPlayer?.name} - ارمي النرد`;
                endTurnBtn.textContent = `⏭️ إنهاء دور ${currentPlayer?.name}`;
                
                // تحديث مظهر الأزرار للاعب الحالي
                rollDiceBtn.style.background = 'linear-gradient(45deg, #00d2ff, #3a7bd5)';
                rollDiceBtn.style.boxShadow = '0 4px 15px rgba(0, 210, 255, 0.4)';
                endTurnBtn.style.background = 'linear-gradient(45deg, #ff6b6b, #ffa500)';
                endTurnBtn.style.boxShadow = '0 4px 15px rgba(255, 107, 107, 0.4)';
            }
        }

        // دالة لتحديث تمييز البطاقات
        function updatePlayerCardHighlight() {
            const playerCards = document.querySelectorAll('.player-card');
            playerCards.forEach((card, index) => {
                card.classList.remove('current-player');
                if (index === gameState.currentPlayer) {
                    card.classList.add('current-player');
                    // تأثير صوتي خفيف
                    setTimeout(() => {
                        soundSystem.play('hover');
                    }, 300);
                }
            });
        }

        // دالة لإضافة تأثير بصري للوحة عند تغيير الدور
        function addBoardTurnEffect() {
            const gameBoard = document.querySelector('.game-board');
            if (gameBoard) {
                gameBoard.style.transform = 'scale(1.02)';
                gameBoard.style.boxShadow = '0 0 50px rgba(0, 210, 255, 0.6)';
                gameBoard.style.transition = 'all 0.5s ease';
                
                setTimeout(() => {
                    gameBoard.style.transform = 'scale(1)';
                    gameBoard.style.boxShadow = '0 20px 40px rgba(0,0,0,0.1)';
                }, 800);
            }
        }

        function highlightCurrentPlayerOnBoard() {
            // إزالة التمييز من جميع اللاعبين
            document.querySelectorAll('.player-token').forEach(token => {
                token.classList.remove('current-player-highlight');
            });
            
            // تمييز اللاعب الحالي على اللوحة
            const currentPlayerToken = document.querySelector(`[data-player="${gameState.currentPlayer}"]`);
            if (currentPlayerToken) {
                currentPlayerToken.classList.add('current-player-highlight');
            }
        }

        function updateGameInfo() {
            const gameInfoDiv = document.getElementById('game-info');
            if (!gameInfoDiv) return;
            
            const currentPlayer = gameState.players[gameState.currentPlayer];
            if (!currentPlayer) return;
            
            // التحقق من صحة البيانات
            validatePlayerData(currentPlayer);
            
            const currentPosition = currentPlayer.position >= 0 && currentPlayer.position < omanProperties.length ? 
                currentPlayer.position : 0;
            
            gameInfoDiv.innerHTML = `
                <div class="current-turn-info" style="
                    background: linear-gradient(135deg, #00d2ff, #3a7bd5, #667eea);
                    color: white;
                    padding: 25px;
                    border-radius: 20px;
                    text-align: center;
                    box-shadow: 0 10px 30px rgba(0, 210, 255, 0.4);
                    margin-bottom: 20px;
                    border: 3px solid rgba(255,255,255,0.3);
                    animation: infoGlow 3s ease-in-out infinite alternate;
                    position: relative;
                    overflow: hidden;
                ">
                    <!-- تأثير خلفية متحركة -->
                    <div style="
                        position: absolute;
                        top: -50%;
                        left: -50%;
                        width: 200%;
                        height: 200%;
                        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
                        animation: shimmer 3s ease-in-out infinite;
                        pointer-events: none;
                    "></div>
                    
                    <h2 style="margin: 0 0 20px 0; font-size: 2em; position: relative; z-index: 1;">
                        🎯 دور: ${currentPlayer.name}
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; position: relative; z-index: 1;">
                        <div style="background: rgba(255,255,255,0.25); padding: 15px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                            <div style="font-size: 1.2em; font-weight: bold;">🏆 المرحلة</div>
                            <div style="font-size: 1.5em; margin-top: 5px;">${gameState.currentRound || 1}</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.25); padding: 15px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                            <div style="font-size: 1.2em; font-weight: bold;">📍 الموقع</div>
                            <div style="font-size: 1.2em; margin-top: 5px;">${omanProperties[currentPosition]?.name || 'البداية'}</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.25); padding: 15px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                            <div style="font-size: 1.2em; font-weight: bold;">💰 الرصيد</div>
                            <div style="font-size: 1.5em; margin-top: 5px;">${formatMoney(currentPlayer.money)}</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.25); padding: 15px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                            <div style="font-size: 1.2em; font-weight: bold;">🏠 العقارات</div>
                            <div style="font-size: 1.5em; margin-top: 5px;">${currentPlayer.properties ? currentPlayer.properties.length : 0}</div>
                        </div>
                    </div>
                    
                    ${gameState.gameStarted ? `
                        <div style="margin-top: 20px; padding: 15px; background: rgba(46, 204, 113, 0.4); border-radius: 15px; border: 3px dashed rgba(255,255,255,0.6); position: relative; z-index: 1;">
                            <div style="font-size: 1.3em; font-weight: bold;">💡 التعليمات</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">اضغط "رمي النرد" للبدء في حركتك!</div>
                        </div>
                    ` : `
                        <div style="margin-top: 20px; padding: 15px; background: rgba(231, 76, 60, 0.4); border-radius: 15px; border: 3px dashed rgba(255,255,255,0.6); position: relative; z-index: 1;">
                            <div style="font-size: 1.3em; font-weight: bold;">⏳ في انتظار البدء</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">اضغط "بدء اللعبة" للبدء!</div>
                        </div>ش
                    `}
                </div>
            `;
        }

        function restartGame() {
            // إعادة تعيين حالة اللعبة
            gameState.currentPlayer = 0;
            gameState.currentRound = 1;
            gameState.players.forEach(player => {
                player.money = 1500;
                player.position = 0;
                player.properties = [];
                player.inJail = false;
                player.jailTurns = 0;
            });
            
            // إزالة شاشة الفوز
            const modal = document.querySelector('.winner-modal');
            if (modal) modal.remove();
            
            // إعادة تحديث الشاشة
            updatePlayersDisplay();
            LeaderboardSystem.updateLeaderboard();
            MessageSystem.show('🎮 بدأت لعبة جديدة!', 'success');
            soundSystem.play('startapp');
        }

        function showFinalLeaderboard() {
            LeaderboardSystem.showLeaderboard();
        }

        function endTurn() {
            if (!gameState.gameStarted) {
                MessageSystem.show('يجب بدء اللعبة أولاً!', 'error');
                return;
            }

            // فحص إفلاس اللاعب الحالي قبل إنهاء الدور
            const currentPlayer = gameState.players[gameState.currentPlayer];
            if (currentPlayer.money < 0 && !currentPlayer.isBankrupt) {
                console.log(`💸 اكتشاف إفلاس ${currentPlayer.name} في نهاية الدور`);
                handleBankruptcy(gameState.currentPlayer, Math.abs(currentPlayer.money));
                return; // إيقاف الدور حتى يتم التعامل مع الإفلاس
            }

            // تعطيل أزرار الدور الحالي
            document.getElementById('rollDice').disabled = true;
            document.getElementById('endTurn').disabled = true;
            
            // الانتقال للدور التالي
            nextTurn();
            
            // تفعيل زر رمي النرد للاعب الجديد
            setTimeout(() => {
                document.getElementById('rollDice').disabled = false;
            }, 1000);
        }

        // ===========================================
        // إدارة اللعبة
        // ===========================================
        function startGame() {
            if (gameState.gameStarted) {
                MessageSystem.show('اللعبة بدأت بالفعل!', 'error');
                return;
            }

            if (!gameState.players || gameState.players.length < 2) {
                MessageSystem.show('يجب إعداد اللاعبين أولاً!', 'error');
                return;
            }

            gameState.gameStarted = true;
            gameState.currentPlayer = 0;
            
            // تحديث مظهر العقارات
            updatePropertyDisplay();
            
            MessageSystem.show('🎮 بدأت اللعبة! حظاً موفقاً!', 'success');
            soundSystem.play('win');
            updatePlayersDisplay();
            LeaderboardSystem.updateLeaderboard();
        }

        function showRules() {
            document.getElementById('rulesModal').style.display = 'block';
        }

        // ===========================================
        // معالجة الأحداث
        // ===========================================
        function setupEventListeners() {
            console.log('🔧 بدء إعداد معالجات الأحداث...');
            
            // التحقق من وجود العناصر قبل إضافة الأحداث
            const setupPlayersBtn = document.getElementById('setupPlayersBtn');
            const startGameBtn = document.getElementById('startGameBtn');
            const rollDiceBtn = document.getElementById('rollDice');
            const endTurnBtn = document.getElementById('endTurn');
            const showRulesBtn = document.getElementById('showRules');
            
            // أزرار التحكم الرئيسية
            if (setupPlayersBtn) {
                setupPlayersBtn.addEventListener('click', setupSmartPlayerSelection);
                console.log('✅ تم ربط setupPlayersBtn');
            }
            if (startGameBtn) {
                startGameBtn.addEventListener('click', startGameWithStudents);
                console.log('✅ تم ربط startGameBtn');
            }
            if (rollDiceBtn) {
                rollDiceBtn.addEventListener('click', () => rollDice());
                console.log('✅ تم ربط rollDice');
            }
            if (endTurnBtn) {
                endTurnBtn.addEventListener('click', () => endTurn());
                console.log('✅ تم ربط endTurn');
            }
            if (showRulesBtn) {
                showRulesBtn.addEventListener('click', showRules);
                console.log('✅ تم ربط showRules');
            }

            // واجهة اختيار اللاعبين الذكية
            const playersCount = document.getElementById('playersCount');
            if (playersCount) {
                playersCount.addEventListener('change', () => {
                    const setupBtn = document.getElementById('setupPlayersBtn');
                    const classSelect = document.getElementById('classSelect');
                    if (setupBtn && classSelect && classSelect.value) {
                        setupBtn.disabled = false;
                    }
                });
                console.log('✅ تم ربط playersCount');
            }
            
            // أزرار التحكم في الاختيار
            const confirmBtn = document.getElementById('confirmPlayerSelection');
            const cancelBtn = document.getElementById('cancelPlayerSelection');
            const clearBtn = document.getElementById('clearSelection');
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', confirmPlayerSelection);
                console.log('✅ تم ربط confirmPlayerSelection');
            }
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelPlayerSelection);
                console.log('✅ تم ربط cancelPlayerSelection');
            }
            if (clearBtn) {
                clearBtn.addEventListener('click', clearSelection);
                console.log('✅ تم ربط clearSelection');
            }

            // أزرار التحكم العلوية المحسّنة
            setupTopControlButtons();
            
            console.log('✅ تم إعداد جميع معالجات الأحداث');
        }
        
        // إعداد أزرار التحكم العلوية
        function setupTopControlButtons() {
            console.log('🎮 إعداد أزرار التحكم العلوية...');
            
            // زر العودة للرئيسية
            const returnToIndex = document.getElementById('returnToIndex');
            if (returnToIndex) {
                returnToIndex.addEventListener('click', () => {
                    if (confirm('هل تريد العودة للصفحة الرئيسية؟')) {
                        window.location.href = '../index.html';
                    }
                });
                console.log('✅ تم ربط زر العودة للرئيسية');
            } else {
                console.error('❌ لم يتم العثور على زر returnToIndex');
            }

            // زر التحكم بالصوت
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) {
                soundToggle.addEventListener('click', () => {
                    try {
                        const enabled = soundSystem.toggle();
                        const icon = soundToggle.querySelector('i');
                        if (icon) {
                            icon.className = enabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
                        }
                        MessageSystem.show(enabled ? '🔊 تم تشغيل الصوت' : '🔇 تم إيقاف الصوت', 'info', 2000);
                    } catch (error) {
                        console.error('خطأ في تبديل الصوت:', error);
                        MessageSystem.show('خطأ في تبديل الصوت', 'error', 2000);
                    }
                });
                console.log('✅ تم ربط زر التحكم بالصوت');
            } else {
                console.error('❌ لم يتم العثور على زر soundToggle');
            }

            // زر ملء الشاشة
            const fullscreenToggle = document.getElementById('fullscreenToggle');
            if (fullscreenToggle) {
                fullscreenToggle.addEventListener('click', () => {
                    try {
                        if (!document.fullscreenElement) {
                            document.documentElement.requestFullscreen().then(() => {
                                const icon = fullscreenToggle.querySelector('i');
                                if (icon) {
                                    icon.className = 'fas fa-compress';
                                }
                                MessageSystem.show('🖥️ تم تفعيل ملء الشاشة', 'success', 2000);
                            }).catch(err => {
                                console.error('خطأ في ملء الشاشة:', err);
                                MessageSystem.show('❌ لا يمكن تفعيل ملء الشاشة', 'error', 2000);
                            });
                        } else {
                            document.exitFullscreen().then(() => {
                                const icon = fullscreenToggle.querySelector('i');
                                if (icon) {
                                    icon.className = 'fas fa-expand';
                                }
                                MessageSystem.show('🪟 تم إلغاء ملء الشاشة', 'info', 2000);
                            });
                        }
                    } catch (error) {
                        console.error('خطأ في ملء الشاشة:', error);
                        MessageSystem.show('❌ ملء الشاشة غير مدعوم', 'error', 2000);
                    }
                });
                console.log('✅ تم ربط زر ملء الشاشة');
            } else {
                console.error('❌ لم يتم العثور على زر fullscreenToggle');
            }

            // زر معلومات اللعبة
            const gameInfo = document.getElementById('gameInfo');
            if (gameInfo) {
                gameInfo.addEventListener('click', () => {
                    try {
                        showGameInfoModal();
                        MessageSystem.show('📖 تم عرض معلومات اللعبة', 'info', 2000);
                    } catch (error) {
                        console.error('خطأ في عرض معلومات اللعبة:', error);
                        MessageSystem.show('❌ خطأ في عرض المعلومات', 'error', 2000);
                    }
                });
                console.log('✅ تم ربط زر معلومات اللعبة');
            } else {
                console.error('❌ لم يتم العثور على زر gameInfo');
            }
        }
        
        // عرض نافذة معلومات اللعبة
        function showGameInfoModal() {
            const gameInfoModal = document.createElement('div');
            gameInfoModal.className = 'modal';
            gameInfoModal.style.display = 'block';
            gameInfoModal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2><i class="fas fa-info-circle"></i> معلومات اللعبة</h2>
                    <div class="game-info-content">
                        <div class="info-section">
                            <h3>🎮 نوع اللعبة</h3>
                            <p>مونوبولي سلطنة عُمان التعليمي</p>
                        </div>
                        <div class="info-section">
                            <h3>🎯 الهدف</h3>
                            <p>تعلم الجغرافيا العُمانية وإدارة الأموال من خلال شراء العقارات</p>
                        </div>
                        <div class="info-section">
                            <h3>👥 عدد اللاعبين</h3>
                            <p>2-6 لاعبين</p>
                        </div>
                        <div class="info-section">
                            <h3>⏱️ مدة اللعبة</h3>
                            <p>30-60 دقيقة</p>
                        </div>
                        <div class="info-section">
                            <h3>🏛️ الأماكن</h3>
                            <p>مدن ومعالم حقيقية من سلطنة عُمان</p>
                        </div>
                        <div class="info-section">
                            <h3>📱 الإصدار</h3>
                            <p>الإصدار التعليمي 2025</p>
                        </div>
                        <div class="info-section">
                            <h3>🔄 حالة البيانات</h3>
                            <p>البيانات: ${playerData && Object.keys(playerData).length > 0 ? '✅ محملة بنجاح' : '❌ غير محملة'}</p>
                            <p>عدد الصفوف: ${playerData ? Object.keys(playerData).length : 0}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="this.closest('.modal').remove()" class="btn btn-primary">حسناً</button>
                        ${!playerData || Object.keys(playerData).length === 0 ? 
                            '<button onclick="this.closest(\'.modal\').remove(); location.reload();" class="btn btn-secondary">إعادة تحميل الصفحة</button>' : 
                            ''}
                    </div>
                </div>
            `;
            document.body.appendChild(gameInfoModal);
        }
        
        // إعداد أزرار التحكم العلوية
        function setupTopControlButtons() {
            console.log('🎮 إعداد أزرار التحكم العلوية...');
            
            // زر العودة للرئيسية
            const returnToIndex = document.getElementById('returnToIndex');
            if (returnToIndex) {
                returnToIndex.addEventListener('click', () => {
                    if (confirm('هل تريد العودة للصفحة الرئيسية؟')) {
                        window.location.href = '../index.html';
                    }
                });
                console.log('✅ تم ربط زر العودة للرئيسية');
            }

            // زر التحكم بالصوت
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) {
                soundToggle.addEventListener('click', () => {
                    try {
                        const enabled = soundSystem.toggle();
                        const icon = soundToggle.querySelector('i');
                        if (icon) {
                            icon.className = enabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
                        }
                        MessageSystem.show(enabled ? '🔊 تم تشغيل الصوت' : '🔇 تم إيقاف الصوت', 'info', 2000);
                    } catch (error) {
                        console.error('خطأ في تبديل الصوت:', error);
                        MessageSystem.show('خطأ في تبديل الصوت', 'error', 2000);
                    }
                });
                console.log('✅ تم ربط زر التحكم بالصوت');
            }

            // زر ملء الشاشة
            const fullscreenToggle = document.getElementById('fullscreenToggle');
            if (fullscreenToggle) {
                fullscreenToggle.addEventListener('click', () => {
                    try {
                        if (!document.fullscreenElement) {
                            document.documentElement.requestFullscreen().then(() => {
                                const icon = fullscreenToggle.querySelector('i');
                                if (icon) {
                                    icon.className = 'fas fa-compress';
                                }
                                MessageSystem.show('🖥️ تم تفعيل ملء الشاشة', 'success', 2000);
                            }).catch(err => {
                                console.error('خطأ في ملء الشاشة:', err);
                                MessageSystem.show('❌ لا يمكن تفعيل ملء الشاشة', 'error', 2000);
                            });
                        } else {
                            document.exitFullscreen().then(() => {
                                const icon = fullscreenToggle.querySelector('i');
                                if (icon) {
                                    icon.className = 'fas fa-expand';
                                }
                                MessageSystem.show('🪟 تم إلغاء ملء الشاشة', 'info', 2000);
                            });
                        }
                    } catch (error) {
                        console.error('خطأ في ملء الشاشة:', error);
                        MessageSystem.show('❌ ملء الشاشة غير مدعوم', 'error', 2000);
                    }
                });
                console.log('✅ تم ربط زر ملء الشاشة');
            }

            // زر معلومات اللعبة
            const gameInfo = document.getElementById('gameInfo');
            if (gameInfo) {
                gameInfo.addEventListener('click', () => {
                    try {
                        showGameInfoModal();
                        MessageSystem.show('📖 تم عرض معلومات اللعبة', 'info', 2000);
                    } catch (error) {
                        console.error('خطأ في عرض معلومات اللعبة:', error);
                        MessageSystem.show('❌ خطأ في عرض المعلومات', 'error', 2000);
                    }
                });
                console.log('✅ تم ربط زر معلومات اللعبة');
            }
            
            // إعداد اختصارات لوحة المفاتيح
            document.addEventListener('keydown', (e) => {
                if (e.key === ' ') {
                    e.preventDefault();
                    if (typeof rollDice === 'function') rollDice();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (typeof endTurn === 'function') endTurn();
                } else if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                    const smartSelection = document.getElementById('smartPlayerSelection');
                    if (smartSelection) smartSelection.style.display = 'none';
                }
            });
        }

        // ===========================================
        // تهيئة اللعبة
        // ===========================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🎮 بدء تحميل مونوبولي عُمان...');

            try {
                // تحميل بيانات الطلاب
                console.log('🔄 بدء تحميل بيانات الطلاب...');
                await loadStudentData();
                console.log('✅ تم تحميل بيانات الطلاب');
                
                // ملء قائمة الصفوف
                console.log('📚 ملء قائمة الصفوف...');
                populateClassSelect();
                console.log('✅ تم ملء قائمة الصفوف');
                
                // إنشاء لوحة اللعبة
                console.log('🏗️ إنشاء لوحة اللعبة...');
                createGameBoard();
                console.log('✅ تم إنشاء لوحة اللعبة');
                
                // إعداد معالجات الأحداث
                console.log('⚙️ إعداد معالجات الأحداث...');
                setupEventListeners();
                console.log('✅ تم إعداد معالجات الأحداث');
                
                // إضافة أنماط الرسوم المتحركة والبطاقات التفاعلية
                const animationStyles = `
                    @keyframes slideInRight {
                        from {
                            opacity: 0;
                            transform: translateX(100px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                    
                    @keyframes slideOutRight {
                        from {
                            opacity: 1;
                            transform: translateX(0);
                        }
                        to {
                            opacity: 0;
                            transform: translateX(100px);
                        }
                    }
                    
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        25% { transform: translateX(-5px); }
                        75% { transform: translateX(5px); }
                    }
                    
                    .current-player {
                        border: 3px solid var(--accent-gold) !important;
                        box-shadow: var(--shadow-glow-gold) !important;
                    }
                    
                    /* تحسين البطاقات التفاعلية */
                    .students-interactive-grid {
                        display: grid !important;
                        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)) !important;
                        gap: 15px !important;
                        padding: 0 30px !important;
                        max-height: 500px !important;
                        overflow-y: auto !important;
                        margin-bottom: 30px !important;
                    }
                    
                    .student-interactive-card {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                        border-radius: 12px !important;
                        padding: 15px !important;
                        text-align: center !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        border: 2px solid transparent !important;
                        position: relative !important;
                        overflow: hidden !important;
                        color: white !important;
                        min-height: 140px !important;
                        display: flex !important;
                        flex-direction: column !important;
                        align-items: center !important;
                        justify-content: center !important;
                    }
                    
                    .student-interactive-card::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
                        z-index: 1;
                        transition: opacity 0.3s ease;
                    }
                    
                    .student-interactive-card:hover {
                        transform: translateY(-5px) !important;
                        box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
                        border-color: #ffd700 !important;
                    }
                    
                    .student-interactive-card:hover::before {
                        opacity: 0.8;
                    }
                    
                    .student-interactive-card.selected {
                        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
                        border-color: #ffd700 !important;
                        transform: translateY(-3px) !important;
                        box-shadow: 0 8px 20px rgba(17, 153, 142, 0.4) !important;
                    }
                    
                    .student-interactive-card.selected::before {
                        background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
                    }
                    
                    .student-avatar {
                        width: 50px !important;
                        height: 50px !important;
                        border-radius: 50% !important;
                        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        margin: 0 auto 10px !important;
                        font-size: 20px !important;
                        font-weight: bold !important;
                        color: #333 !important;
                        position: relative !important;
                        z-index: 2 !important;
                        box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4) !important;
                    }
                    
                    .student-name {
                        font-weight: bold !important;
                        color: white !important;
                        margin-bottom: 8px !important;
                        position: relative !important;
                        z-index: 2 !important;
                        font-size: 14px !important;
                    }
                    
                    .student-status {
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 5px !important;
                        color: rgba(255,255,255,0.9) !important;
                        font-size: 12px !important;
                        position: relative !important;
                        z-index: 2 !important;
                    }
                    
                    .student-status i {
                        font-size: 14px !important;
                    }
                    
                    .selected-player-card {
                        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
                        border-radius: 10px !important;
                        padding: 15px !important;
                        text-align: center !important;
                        position: relative !important;
                        color: white !important;
                        border: 2px solid #ffd700 !important;
                    }
                    
                    .selected-player-card .remove-btn {
                        position: absolute !important;
                        top: -8px !important;
                        right: -8px !important;
                        background: #ff4757 !important;
                        border: none !important;
                        border-radius: 50% !important;
                        width: 24px !important;
                        height: 24px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        cursor: pointer !important;
                        color: white !important;
                        font-size: 12px !important;
                        transition: all 0.3s ease !important;
                        z-index: 3 !important;
                    }
                    
                    .selected-player-card .remove-btn:hover {
                        background: #ff3838 !important;
                        transform: scale(1.1) !important;
                    }
                    
                    .player-role {
                        margin-top: 8px !important;
                        font-size: 11px !important;
                        color: rgba(255,255,255,0.8) !important;
                        font-weight: bold !important;
                    }
                `;
                
                const styleSheet = document.createElement('style');
                styleSheet.textContent = animationStyles;
                document.head.appendChild(styleSheet);
                
                MessageSystem.show('تم تحميل مونوبولي عُمان بنجاح! 🎉', 'success');
                console.log('✅ تم تحميل اللعبة بنجاح!');
                
            } catch (error) {
                console.error('❌ خطأ في تحميل اللعبة:', error);
                MessageSystem.show('حدث خطأ في تحميل اللعبة', 'error');
            }
        });

        // إعداد واجهة اختيار عدد اللاعبين المحسّنة
        document.addEventListener('DOMContentLoaded', () => {
            const playerCountOptions = document.querySelectorAll('.player-count-option');
            const playersCountSelect = document.getElementById('playersCount');
            
            // تعيين القيمة الافتراضية
            const defaultOption = document.querySelector('.player-count-option[data-count="2"]');
            if (defaultOption) {
                defaultOption.classList.add('selected');
                playersCountSelect.value = '2';
            }
            
            // إضافة أحداث النقر لخيارات عدد اللاعبين
            playerCountOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // إزالة التحديد من جميع الخيارات
                    playerCountOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // تحديد الخيار المنقور
                    option.classList.add('selected');
                    
                    // تحديث قيمة الـ select المخفي
                    const count = option.getAttribute('data-count');
                    playersCountSelect.value = count;
                    
                    // تحديث عداد اللاعبين المطلوب
                    document.getElementById('totalPlayersNeeded').textContent = count;
                    
                    // تأثير صوتي
                    soundSystem.play('Click');
                    
                    // تأثير بصري
                    option.style.animation = 'pulse 0.3s ease';
                    setTimeout(() => {
                        option.style.animation = '';
                    }, 300);
                    
                    // إعادة تعيين اختيار اللاعبين إذا تم تغيير العدد
                    selectedPlayers = [];
                    updateSelectionUI();
                    
                    // رسالة إعلامية
                    MessageSystem.show(`تم اختيار ${count} لاعبين للعبة! 🎮`, 'info', 2000);
                    
                    // تحديث حالة الأزرار
                    updateSetupButtonState();
                });
                
                // تأثيرات التفاعل
                option.addEventListener('mouseenter', () => {
                    if (!option.classList.contains('selected')) {
                        option.style.transform = 'translateY(-2px) scale(1.02)';
                    }
                });
                
                option.addEventListener('mouseleave', () => {
                    if (!option.classList.contains('selected')) {
                        option.style.transform = 'translateY(0) scale(1)';
                    }
                });
            });
        });
        
        // تحديث حالة زر الإعداد
        function updateSetupButtonState() {
            const classSelect = document.getElementById('classSelect');
            const playersCount = document.getElementById('playersCount').value;
            const setupBtn = document.getElementById('setupPlayersBtn');
            
            setupBtn.disabled = !classSelect.value || !playersCount;
        }
    </script>

    <!-- المساعد الاستجابي للأجهزة المحمولة -->
    <script src="../assets/js/responsive-helper.js"></script>
</body>
</html>
