  <!-- شاشة الفوز ولوحة الشرف -->
  <div id="victory-screen" class="victory-screen" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;">
    <div class="victory-content" style="background:linear-gradient(135deg,#fffbe6 0%,#ffd700 100%);border-radius:30px;padding:40px 30px;box-shadow:0 0 60px #ffd700a0;max-width:400px;margin:auto;text-align:center;position:relative;">
      <button class="victory-close" onclick="victoryManager.hideVictoryScreen()" style="position:absolute;top:10px;left:10px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#DC143C;"><i class="fas fa-times"></i></button>
      <div class="victory-crown" style="font-size:3.5em;">👑</div>
      <h1 class="victory-title" id="victory-title" style="color:#DC143C;font-size:2em;margin:10px 0;">تهانينا!</h1>
      <div class="winner-name" id="winner-name" style="font-size:1.5em;color:#23243a;font-weight:bold;margin-bottom:10px;">البطل الفائز</div>
      <div class="victory-stats" style="margin:18px 0;">
        <div class="stats-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="stat-item"><span class="stat-value" id="final-time">00:00</span><span class="stat-label" style="display:block;font-size:0.9em;">الوقت المستغرق</span></div>
          <div class="stat-item"><span class="stat-value" id="final-moves">0</span><span class="stat-label" style="display:block;font-size:0.9em;">عدد الحركات</span></div>
          <div class="stat-item"><span class="stat-value" id="final-level">1</span><span class="stat-label" style="display:block;font-size:0.9em;">المستوى المكتمل</span></div>
          <div class="stat-item"><span class="stat-value" id="final-score">0</span><span class="stat-label" style="display:block;font-size:0.9em;">النقاط</span></div>
        </div>
      </div>
      <div class="victory-actions" style="margin-top:18px;display:flex;gap:10px;justify-content:center;">
        <button class="victory-btn btn-play-again" onclick="playAgain()" style="background:linear-gradient(90deg,#FFD700,#fffbe6 80%,#FFD700);color:#23243a;font-weight:bold;padding:12px 18px;border-radius:12px;border:none;font-size:1em;cursor:pointer;"><i class="fas fa-redo"></i> العب من جديد</button>
        <button class="victory-btn btn-home" onclick="goToHome()" style="background:linear-gradient(90deg,#DC143C,#FFD700);color:#fff;font-weight:bold;padding:12px 18px;border-radius:12px;border:none;font-size:1em;cursor:pointer;"><i class="fas fa-home"></i> الصفحة الرئيسية</button>
      </div>
    </div>
  </div>
  <script>
    // مدير شاشة الفوز
    class VictoryManager {
      constructor() {
        this.victoryScreen = document.getElementById('victory-screen');
      }
      showVictoryScreen(winnerData) {
        const { name, time, moves, level, score } = winnerData;
        document.getElementById('winner-name').textContent = name;
        document.getElementById('final-time').textContent = time;
        document.getElementById('final-moves').textContent = moves;
        document.getElementById('final-level').textContent = level;
        document.getElementById('final-score').textContent = score;
        this.victoryScreen.style.display = 'flex';
        this.playVictorySound();
        setTimeout(()=>this.createCelebrationEffect(), 800);
      }
      hideVictoryScreen() {
        this.victoryScreen.style.display = 'none';
      }
      playVictorySound() {
        if(window.audioManager) {
          audioManager.playSound('battle-victory');
          setTimeout(()=>audioManager.playSound('crowd-cheer'), 500);
          setTimeout(()=>audioManager.playSound('perfect-score'), 1000);
        }
      }
      createCelebrationEffect() {
        for(let i=0;i<20;i++) {
          setTimeout(()=>{
            const particle = document.createElement('div');
            particle.innerHTML = ['🎉','✨','🌟','💫','🎊'][Math.floor(Math.random()*5)];
            particle.style.position = 'fixed';
            particle.style.fontSize = '2rem';
            particle.style.pointerEvents = 'none';
            particle.style.zIndex = '100000';
            particle.style.left = (window.innerWidth/2 + (Math.random()-0.5)*200) + 'px';
            particle.style.top = (window.innerHeight/2 + (Math.random()-0.5)*100) + 'px';
            document.body.appendChild(particle);
            particle.animate([
              { transform: 'translateY(0) scale(1)', opacity: 1 },
              { transform: `translateY(-${Math.random()*200+100}px) scale(0)`, opacity: 0 }
            ], { duration: 2000, easing: 'ease-out' }).onfinish = ()=>particle.remove();
          }, i*80);
        }
      }
    }
    window.victoryManager = new VictoryManager();
    function showGameVictory(winnerName, gameStats) {
      const winnerData = {
        name: winnerName,
        time: gameStats.time || '00:00',
        moves: gameStats.moves || 0,
        level: gameStats.level || 1,
        score: gameStats.score || 0
      };
      victoryManager.showVictoryScreen(winnerData);
    }
    function playAgain() {
      victoryManager.hideVictoryScreen();
      window.location.reload();
    }
    function goToHome() {
      victoryManager.hideVictoryScreen();
      setTimeout(()=>{ window.location.href = '../main.html'; }, 300);
    }
  </script>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>سباق المعرفة التفاعلي</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --tower-gradient: linear-gradient(45deg, #ffd700 0%, #ff6b35 50%, #ffd700 100%);
      --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --danger-gradient: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
      --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --cosmic-bg: linear-gradient(45deg, #181c2a 0%, #23243a 100%);
      --success-color: #11998e;
      --danger-color: #fc466b;
      --warning-color: #f5576c;
      --neon-cyan: #00f5ff;
      --neon-pink: #ff073a;
      --border-radius: 18px;
      --border-radius-small: 12px;
      --spacing-xs: 8px;
      --spacing-sm: 14px;
      --spacing-md: 22px;
      --spacing-lg: 36px;
      --spacing-xl: 48px;
      --transition-fast: 0.18s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --transition-normal: 0.28s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --transition-slow: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --elastic-timing: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --cosmic-timing: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --text-primary: #fffbe6;
      --text-secondary: #ffd700;
      --text-light: #fff;
      --text-dark: #23243a;
      --shadow-strong: 0 8px 32px rgba(0,0,0,0.45);
      --shadow-soft: 0 2px 8px #FFD70022;
    }
    body {
      font-family: 'Cairo', sans-serif;
      background: var(--cosmic-bg);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      letter-spacing: 0.01em;
    }
    .top-toolbar {
      position: fixed; top: 0; left: 0; right: 0; height: 70px;
      background: linear-gradient(135deg, #181c2a 80%, #ffd70022 100%);
      backdrop-filter: blur(25px);
      border-bottom: 2px solid #ffd70055;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 var(--spacing-lg);
      z-index: 10000;
      box-shadow: var(--shadow-strong);
      animation: toolbarSlideDown 1s var(--cosmic-timing);
    }
    @keyframes toolbarSlideDown { 0% { opacity: 0; transform: translateY(-100%); } 100% { opacity: 1; transform: translateY(0); } }
    .game-logo {
      display: flex; align-items: center; gap: var(--spacing-sm);
      font-family: 'Orbitron', 'Cairo', sans-serif;
      font-size: 1.7rem; font-weight: 900;
      background: var(--tower-gradient);
      background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 0 0 24px #ffd700a0;
      cursor: pointer; transition: all var(--transition-normal);
      position: relative;
      letter-spacing: 0.04em;
    }
    .game-logo::before { content: '👑'; font-size: 2.1rem; animation: logoFloat 3s ease-in-out infinite; filter: drop-shadow(0 0 15px #ffd700cc); }
    .game-logo:hover { transform: scale(1.07); filter: drop-shadow(0 0 30px #ffd700cc); }
    @keyframes logoFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-7px) rotate(10deg); } }
    .toolbar-icons { display: flex; gap: var(--spacing-sm); align-items: center; }
    .toolbar-icon {
      width: 52px; height: 52px; border-radius: 50%;
      background: linear-gradient(135deg, #23243a 60%, #ffd70022 100%);
      border: 2px solid #ffd70055;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--elastic-timing);
      position: relative; overflow: hidden; font-size: 1.4rem;
      color: var(--text-secondary);
      box-shadow: 0 5px 20px #181c2a99, inset 0 1px 0 #ffd70033;
    }
    .toolbar-icon:hover {
      transform: translateY(-3px) scale(1.13);
      border-color: var(--neon-cyan);
      color: var(--neon-cyan);
      box-shadow: 0 15px 40px #00f5ff44, 0 0 30px var(--neon-cyan), inset 0 2px 5px #ffd70055;
      text-shadow: 0 0 18px currentColor;
    }
    .toolbar-icon:active { transform: translateY(-1px) scale(1.07); }
    .toolbar-icon[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute; bottom: -44px; left: 50%; transform: translateX(-50%);
      background: #23243aee; color: #ffd700; padding: 9px 14px; border-radius: 10px;
      font-size: 1.05rem; font-weight: 700; white-space: nowrap; z-index: 10001;
      animation: tooltipFadeIn 0.3s ease; box-shadow: 0 5px 15px #181c2a99;
      font-family: 'Cairo', sans-serif;
      letter-spacing: 0.02em;
    }
    @keyframes tooltipFadeIn { 0% { opacity: 0; transform: translateX(-50%) translateY(-10px); } 100% { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .container { margin-top: 80px; }
    .main-container {
      background: linear-gradient(135deg, #23243a 80%, #ffd70011 100%);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-soft);
      padding: var(--spacing-lg) var(--spacing-md);
      max-width: 600px;
      margin: 0 auto 32px auto;
      border: 1.5px solid #ffd70033;
    }
    .title {
      font-size: 2.1rem;
      font-weight: 900;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 8px;
      letter-spacing: 0.03em;
      text-shadow: 0 0 18px #ffd70055;
    }
    .subtitle {
      font-size: 1.15rem;
      color: #fffbe6cc;
      text-align: center;
      margin-bottom: 18px;
      font-weight: 600;
    }
    .notif {
      text-align: center;
      margin-bottom: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-secondary);
      background: #23243a;
      border-radius: var(--border-radius-small);
      padding: 8px 0;
      box-shadow: 0 2px 8px #ffd70022;
    }
    .select-row label {
      font-weight: 700;
      color: var(--text-secondary);
      margin-left: 8px;
    }
    .select-row select, .select-row button {
      font-size: 1.1rem;
      border-radius: var(--border-radius-small);
      border: 1.5px solid #ffd70055;
      padding: 7px 14px;
      margin-left: 8px;
      background: #23243a;
      color: var(--text-primary);
      font-weight: 600;
      transition: border-color var(--transition-fast);
    }
    .select-row button {
      background: var(--success-gradient);
      color: #fff;
      border: none;
      font-weight: 800;
      box-shadow: 0 2px 8px #38ef7d44;
    }
    .select-row button:hover {
      background: var(--danger-gradient);
      color: #fffbe6;
    }
    .student-list {
      display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 18px;
    }
    .student-chip {
      background: linear-gradient(90deg, #ffd700 60%, #fffbe6 100%);
      color: #23243a;
      font-weight: 800;
      border-radius: 20px;
      padding: 10px 22px;
      font-size: 1.1rem;
      box-shadow: 0 2px 8px #ffd70033;
      cursor: pointer;
      border: 2px solid #ffd70055;
      transition: all var(--transition-fast);
    }
    .student-chip.selected, .student-chip:hover {
      background: var(--success-gradient);
      color: #fff;
      border-color: #38ef7d;
      box-shadow: 0 4px 16px #38ef7d44;
    }
    .control-panel {
      background: linear-gradient(135deg, #fffbe6 0%, #ffd70022 100%);
      border-radius: var(--border-radius);
      padding: 18px 12px;
      box-shadow: var(--shadow-soft);
      max-width: 420px;
      margin: 0 auto 18px auto;
      border: 1.5px solid #ffd70033;
    }
    .current-player {
      text-align: center;
      margin-bottom: 18px;
    }
    .player-avatar {
      width: 90px; height: 90px; border-radius: 50%;
      background: var(--success-gradient,#FFD700);
      display: flex; align-items: center; justify-content: center;
      font-size: 2.5rem; color: #fff; font-weight: 800;
      margin: 0 auto 10px auto;
      box-shadow: 0 0 30px #FFD70099;
      border: 2.5px solid #fffbe6;
      letter-spacing: 0.04em;
    }
    .player-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-secondary);
      margin-bottom: 6px;
      letter-spacing: 0.02em;
    }
    .player-status {
      color: #23243a;
      font-size: 1.1rem;
      font-weight: 600;
      background: #ffd70033;
      border-radius: 8px;
      padding: 4px 10px;
      display: inline-block;
    }
    .control-buttons {
      display: flex; gap: 10px; justify-content: center;
    }
    .control-btn {
      font-size: 1.1rem;
      border-radius: 12px;
      padding: 10px 18px;
      font-weight: 800;
      border: none;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast);
      box-shadow: 0 2px 8px #ffd70022;
    }
    .btn-primary { background: var(--primary-gradient); color: #fff; }
    .btn-success { background: var(--success-gradient); color: #fff; }
    .btn-danger { background: var(--danger-gradient); color: #fff; }
    .control-btn:hover { filter: brightness(1.1) contrast(1.2); }
    .scoreboard {
      margin: 0 auto 18px auto;
      max-width: 420px;
      background: #23243a;
      border-radius: var(--border-radius-small);
      box-shadow: 0 2px 8px #ffd70022;
      padding: 12px 0;
      border: 1.5px solid #ffd70033;
    }
    .score-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 18px;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      border-bottom: 1px solid #ffd70022;
    }
    .score-row:last-child { border-bottom: none; }
    .score-row .name { color: var(--text-secondary); }
    .score-row .score { color: #fffbe6; }
    /* تحسينات إضافية للوضوح والتباين */
    ::selection { background: #ffd70088; color: #23243a; }
    input, select, button { outline: none; }
    /* ... باقي التنسيقات ... */
  </style>
</head>
<body>
  <!-- إشعارات تفاعلية أعلى الشاشة -->
  <div id="notificationBar" style="position:fixed;top:0;left:50%;transform:translateX(-50%);z-index:20000;min-width:220px;max-width:90vw;padding:14px 28px;background:linear-gradient(90deg,#23243a 60%,#ffd700 100%);color:#fffbe6;font-size:1.15em;font-weight:800;border-radius:0 0 18px 18px;box-shadow:0 8px 32px #FFD70055,0 2px 8px #FFD70022;display:none;align-items:center;gap:12px;text-align:center;pointer-events:none;animation:fadeInNotif 0.7s;">
    <span id="notifIcon" style="font-size:1.3em;"></span>
    <span id="notifMsg"></span>
  </div>
  <style>@keyframes fadeInNotif{0%{opacity:0;transform:translateY(-30px) scale(0.95);}100%{opacity:1;transform:translateY(0) scale(1);}}</style>
  <div class="top-toolbar">
    <div class="game-logo">سباق المعرفة</div>
    <div class="toolbar-icons">
      <div class="toolbar-icon sound-icon" id="soundToggle" data-tooltip="تشغيل/إيقاف الصوت"><i class="fas fa-volume-up"></i></div>
      <div class="toolbar-icon cache-icon" id="clearCacheBtn" data-tooltip="مسح الكاش"><i class="fas fa-broom"></i></div>
      <div class="toolbar-icon settings-icon" id="settingsBtn" data-tooltip="الإعدادات"><i class="fas fa-cog"></i></div>
      <div class="toolbar-icon fullscreen-icon" id="fullscreenBtn" data-tooltip="ملء الشاشة"><i class="fas fa-expand"></i></div>
    </div>
  </div>
  <div class="container">
    <div class="main-container">
    <div class="title">🏆 سباق المعرفة التفاعلي</div>
    <div class="subtitle">اختر الصف، ثم اختر طالبًا عشوائيًا أو يدويًا، واسأل سؤالًا شفويًا وقيّم الإجابة!</div>
    <!-- واجهة اختيار الصف والمتنافسين الاحترافية -->
    <div class="selection-panel" id="selectionPanel">
      <div class="glass-container" style="background: rgba(0,0,0,0.8); border: 2px solid rgba(255,215,0,0.5);">
        <div style="position: relative; margin-bottom: 2rem;">
          <h2 style="text-align: center; color: #ffd700; font-size: 2.2rem; margin-bottom: 0.5rem;">👥 إعداد سباق المعرفة</h2>
          <p style="text-align: center; color: rgba(255,255,255,0.8); font-size: 1.1rem;">⚡ اختر صفك وطلابك لبدء السباق</p>
        </div>
        <!-- اختيار الصف -->
        <div class="class-selection-section" style="margin-bottom: 3rem;">
          <h3 style="color: #00ffff; font-size: 1.5rem; margin-bottom: 1rem; text-align: center;">🏫 اختيار الصف</h3>
          <div class="class-grid" id="classGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"></div>
        </div>
        <!-- اختيار الطلاب -->
        <div class="student-selection-section" id="studentSelectionSection" style="display: none;">
          <h3 style="color: #ff6347; font-size: 1.5rem; margin-bottom: 1rem; text-align: center;">🎯 اختيار المتسابقين</h3>
          <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
            <button class="neural-button" id="clearAllBtn">❌ إلغاء الكل</button>
            <button class="neural-button" id="selectRandomBtn">🎲 اختيار عشوائي</button>
          </div>
          <div class="students-grid" id="studentsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;"></div>
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="background: rgba(0,255,255,0.2); padding: 1rem; border-radius: 15px; display: inline-block;">
              <span style="color: #00ffff; font-size: 1.1rem; font-weight: 700;">المتسابقون المختارون: <span id="selectedCount">0</span></span>
            </div>
          </div>
          <div style="text-align: center;">
            <button class="neural-button" id="startRaceBtn" style="font-size: 1.1rem; padding: 1.2rem 2.5rem; background: linear-gradient(45deg, #ffd700, #ff6347);" disabled>🚀 بدء سباق المعرفة</button>
          </div>
        </div>
      </div>
    </div>
    <div class="control-panel" id="controlPanel" style="background:linear-gradient(135deg,#fffbe6 0%,#ffd70022 100%);border-radius:18px;padding:18px 12px;box-shadow:0 2px 8px #FFD70022;max-width:420px;margin:0 auto 18px auto;display:none;">
      <div class="current-player" style="text-align:center;margin-bottom:18px;">
        <div class="player-avatar" id="playerAvatar" style="width:90px;height:90px;border-radius:50%;background:var(--success-gradient,#FFD700);display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:#fff;font-weight:800;margin:0 auto 10px auto;box-shadow:0 0 30px #FFD70099;">?</div>
        <div class="player-name" id="currentStudent" style="font-size:1.5rem;font-weight:700;color:#FFD700;margin-bottom:6px;"></div>
        <div class="player-status" id="playerStatus" style="color:#23243a;font-size:1.1rem;font-weight:600;"></div>
      </div>
      <div class="start-btns" id="startBtns" style="display:none;text-align:center;margin-bottom:12px;">
        <button class="control-btn btn-primary" id="startQuestionBtn"><i class="fas fa-play"></i> بدء</button>
      </div>
      <div class="control-buttons" id="evalBtns" style="display:none;gap:10px;justify-content:center;">
        <button class="control-btn btn-success" id="correctBtn"><i class="fas fa-check"></i> إجابة صحيحة ✅</button>
        <button class="control-btn btn-danger" id="wrongBtn"><i class="fas fa-times"></i> إجابة خاطئة ❌</button>
      </div>
    </div>
    <div class="scoreboard" id="scoreboard"></div>
  </div>
  <script>
    // ========== نظام الصوت الاحترافي ========== // 
    class AudioManager {
      constructor() {
        this.sounds = {
          welcome: 'kingdom-sounds/character-intro.mp3',
          instruction: 'kingdom-sounds/book-open.mp3',
          select: 'kingdom-sounds/button-hover.mp3',
          correct: 'kingdom-sounds/perfect-score.mp3',
          wrong: 'kingdom-sounds/bomb-explosion.mp3',
          motivate: 'kingdom-sounds/achievement-unlock.mp3',
          start: 'kingdom-sounds/adventure-theme.mp3',
          finish: 'kingdom-sounds/battle-victory.mp3',
          cheer: 'kingdom-sounds/crowd-cheer.mp3',
          click: 'kingdom-sounds/cosmic-click.mp3',
          panel: 'kingdom-sounds/panel-slide.mp3',
          notify: 'kingdom-sounds/ai-notification.mp3',
          error: 'kingdom-sounds/ai-beep.mp3',
        };
        this.isMuted = false;
        this.volume = 1;
      }
      playSound(name, opts={}) {
        if(this.isMuted) return;
        let src = this.sounds[name] || name;
        let audio = new Audio('../assets/media/sounds/' + src);
        audio.volume = (typeof opts.volume === 'number') ? opts.volume : (typeof this.volume === 'number' ? this.volume : 1);
        audio.play();
      }
      toggleMute() { this.isMuted = !this.isMuted; }
    }
    window.audioManager = new AudioManager();

    // ========== نظام الإشعارات التفاعلية ========== //
    class NotificationSystem {
      constructor() {
        this.bar = document.getElementById('notificationBar');
        this.icon = document.getElementById('notifIcon');
        this.msg = document.getElementById('notifMsg');
        this.timeout = null;
      }
      show(msg, color='#FFD700', icon='💡', duration=3200, sound='notify') {
        this.bar.style.display = 'flex';
        this.bar.style.background = `linear-gradient(90deg,#23243a 60%,${color} 100%)`;
        this.icon.textContent = icon;
        this.msg.textContent = msg;
        this.bar.style.animation = 'fadeInNotif 0.7s';
        if(window.audioManager && sound) audioManager.playSound(sound);
        clearTimeout(this.timeout);
        this.timeout = setTimeout(()=>{ this.hide(); }, duration);
      }
      hide() { this.bar.style.display = 'none'; }
    }
    window.notificationSystem = new NotificationSystem();

    // ...existing toolbar, victoryManager code...

    // ========== تفعيل أزرار الشريط العلوي ========== //
    // زر الصوت
    const soundToggle = document.getElementById('soundToggle');
    if (soundToggle) {
      soundToggle.onclick = function() {
        if (!window.audioManager) return;
        audioManager.toggleMute();
        const icon = soundToggle.querySelector('i');
        if (audioManager.isMuted) {
          icon.classList.remove('fa-volume-up');
          icon.classList.add('fa-volume-mute');
          window.notificationSystem && window.notificationSystem.show('تم إيقاف الصوت','#DC143C');
        } else {
          icon.classList.remove('fa-volume-mute');
          icon.classList.add('fa-volume-up');
          window.notificationSystem && window.notificationSystem.show('تم تفعيل الصوت','#228B22');
        }
      };
    }
    // زر مسح الكاش
    const clearCacheBtn = document.getElementById('clearCacheBtn');
    if (clearCacheBtn) {
      clearCacheBtn.onclick = function() {
        // مسح localStorage وsessionStorage
        localStorage.clear();
        sessionStorage.clear();
        // محاولة مسح كاش الخدمة (إن وجد)
        if ('caches' in window) {
          caches.keys().then(function(names) {
            for (let name of names) caches.delete(name);
          });
        }
        window.notificationSystem && window.notificationSystem.show('تم التنظيف بنجاح!','#00ffff');
        window.audioManager && window.audioManager.playSound('cosmic-portal');
      };
    }
    // زر الإعدادات (نافذة وهمية)
    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn) {
      settingsBtn.onclick = function() {
        // نافذة تحكم صوتي احترافية
        if(document.getElementById('audioControlModal')) {
          document.getElementById('audioControlModal').style.display = 'flex';
          return;
        }
        let modal = document.createElement('div');
        modal.id = 'audioControlModal';
        modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:20001;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div style="background:linear-gradient(135deg,#fffbe6 0%,#ffd700 100%);border-radius:22px;padding:32px 28px;box-shadow:0 0 40px #ffd700a0;min-width:320px;max-width:90vw;text-align:center;position:relative;">
            <button id="closeAudioModal" style="position:absolute;top:10px;left:10px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#DC143C;"><i class="fas fa-times"></i></button>
            <div style="font-size:2em;margin-bottom:10px;color:#23243a;"><i class='fas fa-volume-up'></i> التحكم بالصوت</div>
            <div style="margin-bottom:18px;font-size:1.1em;color:#23243a;">يمكنك التحكم في مستوى الصوت أو كتم/تشغيل جميع الأصوات.</div>
            <div style="display:flex;align-items:center;justify-content:center;gap:18px;margin-bottom:18px;">
              <button id="muteBtn" style="font-size:1.2em;padding:10px 18px;border-radius:10px;border:none;background:linear-gradient(90deg,#DC143C,#FFD700);color:#fff;font-weight:bold;cursor:pointer;"><i class="fas fa-volume-mute"></i> كتم</button>
              <button id="unmuteBtn" style="font-size:1.2em;padding:10px 18px;border-radius:10px;border:none;background:linear-gradient(90deg,#11998e,#FFD700);color:#fff;font-weight:bold;cursor:pointer;"><i class="fas fa-volume-up"></i> تشغيل</button>
            </div>
            <div style="margin-bottom:10px;color:#23243a;font-weight:700;">مستوى الصوت:</div>
            <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="1" style="width:80%;accent-color:#FFD700;">
            <div id="volumeValue" style="margin-top:8px;color:#23243a;font-size:1.1em;font-weight:700;">100%</div>
          </div>
        `;
        document.body.appendChild(modal);
        // إغلاق النافذة
        document.getElementById('closeAudioModal').onclick = ()=>{ modal.style.display = 'none'; };
        // كتم الصوت
        document.getElementById('muteBtn').onclick = ()=>{
          if(window.audioManager) audioManager.isMuted = true;
          window.notificationSystem && window.notificationSystem.show('تم كتم جميع الأصوات','#DC143C');
        };
        // تشغيل الصوت
        document.getElementById('unmuteBtn').onclick = ()=>{
          if(window.audioManager) audioManager.isMuted = false;
          window.notificationSystem && window.notificationSystem.show('تم تفعيل جميع الأصوات','#228B22');
        };
        // التحكم في مستوى الصوت
        let slider = document.getElementById('volumeSlider');
        let volumeValue = document.getElementById('volumeValue');
        slider.value = (window.audioManager && typeof window.audioManager.volume === 'number') ? window.audioManager.volume : 1;
        volumeValue.textContent = Math.round(slider.value*100) + '%';
        slider.oninput = function() {
          let v = parseFloat(slider.value);
          if(window.audioManager) window.audioManager.volume = v;
          volumeValue.textContent = Math.round(v*100) + '%';
        };
      };
    }
    // زر ملء الشاشة
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    if (fullscreenBtn) {
      fullscreenBtn.onclick = function() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      };
    }

    // ========== منطق اختيار الصف والمتسابقين الاحترافي ========== //
    let studentsData = {};
    let selectedClass = null;
    let selectedStudents = [];
    let allStudents = [];

    async function loadStudentsData() {
      try {
        const res = await fetch('../data/studentData.json');
        studentsData = await res.json();
      } catch {
        studentsData = { 'الصف الأول': ['طالب1','طالب2'], 'الصف الثاني': ['طالب3','طالب4'] };
      }
      renderClassGrid();
      // إشعار ترحيبي وتعليمات
      setTimeout(()=>{
        window.notificationSystem.show('مرحبًا بكم في سباق المعرفة!','cyan','👑',3500,'welcome');
        setTimeout(()=>{
          window.notificationSystem.show('اختر الصف ثم المتسابقين لبدء المنافسة','gold','📖',4000,'instruction');
        }, 3700);
      }, 800);
    }

    function renderClassGrid() {
      const classGrid = document.getElementById('classGrid');
      classGrid.innerHTML = '';
      Object.keys(studentsData).forEach(className => {
        const card = document.createElement('div');
        card.className = 'class-card';
        card.innerHTML = `<div class="class-icon">🏫</div><h4>${className}</h4><div class="student-count">${studentsData[className].length} طالب</div>`;
        card.onclick = () => selectClass(className, card);
        classGrid.appendChild(card);
      });
    }

    function selectClass(className, card) {
      selectedClass = className;
      allStudents = studentsData[className] || [];
      selectedStudents = [];
      // إزالة التحديد من جميع البطاقات
      document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
      // إضافة تأثير بصري للبطاقة المختارة
      card.classList.add('selected');
      card.style.transition = 'box-shadow 0.5s, transform 0.5s';
      card.style.boxShadow = '0 0 40px 10px #00ffffcc, 0 0 0 4px #ffd700cc';
      card.style.transform = 'scale(1.08) rotate(-2deg)';
      setTimeout(()=>{
        card.style.boxShadow = '';
        card.style.transform = '';
      }, 700);
      // إخفاء جميع بطاقات الصفوف مع تأثير تلاشي
      const classGrid = document.getElementById('classGrid');
      classGrid.style.transition = 'opacity 0.7s cubic-bezier(0.68,-0.55,0.27,1.55)';
      classGrid.style.opacity = '0';
      setTimeout(()=>{
        classGrid.style.display = 'none';
        renderStudentsGrid();
        document.getElementById('studentSelectionSection').style.display = 'block';
        updateSelectedCount();
        document.getElementById('startRaceBtn').disabled = true;
      }, 700);
  if(window.audioManager) audioManager.playSound('panel');
  window.notificationSystem && window.notificationSystem.show('اختر المتسابقين (حتى 8) ثم اضغط بدء','gold','🎯',3500,'instruction');
    }

    function renderStudentsGrid() {
      const studentsGrid = document.getElementById('studentsGrid');
      studentsGrid.innerHTML = '';
      allStudents.forEach((student, idx) => {
        const card = document.createElement('div');
        card.className = 'student-card';
        card.innerHTML = `<div class="selection-indicator">○</div><div class="student-name">${student}</div>`;
        card.onclick = () => toggleStudent(card, student);
        card.onmouseenter = () => { if(window.audioManager) audioManager.playSound('button-hover', {volume:0.1}); };
        studentsGrid.appendChild(card);
      });
    }

    function toggleStudent(card, student) {
      if(card.classList.contains('selected')) {
        card.classList.remove('selected');
        card.querySelector('.selection-indicator').textContent = '○';
        selectedStudents = selectedStudents.filter(s => s !== student);
        if(window.audioManager) audioManager.playSound('select');
      } else {
        if(selectedStudents.length >= 8) {
          if(window.notificationSystem) window.notificationSystem.show('الحد الأقصى 8 متسابقين فقط!','#DC143C','🚫',2500,'error');
          if(window.audioManager) audioManager.playSound('error');
          card.style.animation = 'shakeX 0.4s';
          setTimeout(()=>{ card.style.animation = ''; }, 400);
          return;
        }
        card.classList.add('selected');
        card.querySelector('.selection-indicator').textContent = '✓';
        selectedStudents.push(student);
        if(window.audioManager) audioManager.playSound('select');
        // رسالة تحفيزية عشوائية
        const motivs = ['أحسنت!','ممتاز!','اختيار رائع!','جاهز للتحدي!','بطل قادم!','💪🔥'];
        if(window.notificationSystem) window.notificationSystem.show(motivs[Math.floor(Math.random()*motivs.length)],'#38ef7d','⚡',1200,'motivate');
      }
      updateSelectedCount();
      document.getElementById('startRaceBtn').disabled = selectedStudents.length === 0;
      card.style.transform = 'scale(1.05)';
      setTimeout(()=>{ card.style.transform = ''; }, 200);
    }

    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = selectedStudents.length;
    }

  // تم إزالة زر اختيار الكل نهائياً
    document.getElementById('clearAllBtn').onclick = function() {
      selectedStudents = [];
      document.querySelectorAll('.student-card').forEach(card => {
        card.classList.remove('selected');
        card.querySelector('.selection-indicator').textContent = '○';
      });
      updateSelectedCount();
      document.getElementById('startRaceBtn').disabled = true;
      if(window.audioManager) audioManager.playSound('cosmic-click');
    };
    document.getElementById('selectRandomBtn').onclick = function() {
      selectedStudents = [];
      document.querySelectorAll('.student-card').forEach(card => {
        card.classList.remove('selected');
        card.querySelector('.selection-indicator').textContent = '○';
      });
      let cards = Array.from(document.querySelectorAll('.student-card'));
      // خلط البطاقات عشوائياً بدون تكرار
      for (let i = cards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [cards[i], cards[j]] = [cards[j], cards[i]];
      }
      let count = Math.min(8, Math.max(4, Math.floor(cards.length * 0.4)));
      let selected = cards.slice(0, count);
      selected.forEach(card => {
        card.classList.add('selected');
        card.querySelector('.selection-indicator').textContent = '✓';
        let name = card.querySelector('.student-name').textContent;
        if (!selectedStudents.includes(name)) selectedStudents.push(name);
      });
      updateSelectedCount();
      document.getElementById('startRaceBtn').disabled = selectedStudents.length === 0;
      if(window.audioManager) audioManager.playSound('cosmic-explosion');
      // إصلاح: تفعيل زر بدء السباق بعد الاختيار العشوائي
      document.getElementById('startRaceBtn').style.display = 'inline-block';
    };

    document.getElementById('startRaceBtn').onclick = function() {
      if(selectedStudents.length === 0) return;
      window.notificationSystem && window.notificationSystem.show('استعدوا للسباق!','gold','🚀',2000,'start');
      if(window.audioManager) audioManager.playSound('start');
      // إخفاء شاشة اختيار الطلاب فورًا
      document.getElementById('selectionPanel').style.display = 'none';
      // معالجة أي تأخير في DOM
      setTimeout(function() {
        showRaceSetupScreen();
      }, 600);
    };

    // شاشة إعداد الجولات والسباق
    function showRaceSetupScreen() {
      // إنشاء شاشة السباق إذا لم تكن موجودة
      let raceScreen = document.getElementById('raceScreen');
      if (!raceScreen) {
        raceScreen = document.createElement('div');
        raceScreen.id = 'raceScreen';
        raceScreen.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:linear-gradient(135deg,#23243a 80%,#ffd70022 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;';
        raceScreen.innerHTML = `
          <div id="raceSetup" style="background:rgba(0,0,0,0.85);border-radius:24px;padding:32px 24px;box-shadow:0 0 40px #ffd700a0;max-width:420px;margin:auto;text-align:center;">
            <h2 style="color:#FFD700;font-size:2rem;margin-bottom:1.2rem;">إعداد الجولات</h2>
            <div id="roundInputs" style="margin-bottom:1.5rem;"></div>
            <button class="neural-button" id="startRealRaceBtn" style="font-size:1.2rem;padding:1rem 2.5rem;background:linear-gradient(45deg,#ffd700,#00ffff);">بدء السباق</button>
          </div>
          <div id="raceArena" style="display:none;width:100vw;height:100vh;align-items:center;justify-content:center;flex-direction:column;">
            <div id="raceTrack" style="width:90vw;max-width:900px;margin:0 auto 30px auto;"></div>
            <div id="raceQuestionBox" style="background:rgba(255,255,255,0.95);border-radius:18px;padding:24px 18px;max-width:420px;margin:auto;text-align:center;box-shadow:0 0 24px #ffd70055;">
              <div id="raceCurrentStudent" style="font-size:1.5rem;font-weight:800;color:#DC143C;margin-bottom:10px;"></div>
              <div id="raceQuestion" style="font-size:1.2rem;color:#23243a;margin-bottom:18px;">اسأل سؤالًا شفويًا للطالب</div>
              <div style="display:flex;gap:1rem;justify-content:center;">
                <button class="control-btn btn-success" id="raceCorrectBtn">إجابة صحيحة ✅</button>
                <button class="control-btn btn-danger" id="raceWrongBtn">إجابة خاطئة ❌</button>
              </div>
              <div id="raceProgressInfo" style="margin-top:12px;font-size:1.1rem;color:#11998e;"></div>
            </div>
          </div>
          <div id="raceHonorBoard" style="display:none;position:absolute;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.93);z-index:10000;align-items:center;justify-content:center;flex-direction:column;">
            <div style="background:linear-gradient(135deg,#fffbe6 0%,#ffd700 100%);border-radius:20px;padding:16px 8px 18px 8px;box-shadow:0 0 28px #ffd700a0;max-width:320px;width:96vw;margin:auto;text-align:center;position:relative;overflow-y:auto;max-height:90vh;">
              <button class="victory-close" onclick="closeHonorBoard()" style="position:absolute;top:8px;left:8px;background:none;border:none;font-size:1.2em;cursor:pointer;color:#DC143C;"><i class="fas fa-times"></i></button>
              <div style="font-size:2em;margin-bottom:6px;">🏁</div>
              <h1 style="color:#DC143C;font-size:1.1em;margin:8px 0 10px 0;letter-spacing:0.02em;">لوحة الشرف</h1>
              <div id="raceStats" style="font-size:0.98em;"></div>
              <div style="display:flex;gap:7px;justify-content:center;margin-top:12px;flex-wrap:wrap;">
                <button class="neural-button" onclick="window.location.reload()" style="font-size:0.95em;padding:7px 13px;background:linear-gradient(90deg,#FFD700,#fffbe6 80%,#FFD700);color:#23243a;font-weight:bold;border-radius:10px;border:none;cursor:pointer;"><i class='fas fa-redo'></i> إعادة السباق</button>
                <button class="neural-button" onclick="goToHome()" style="font-size:0.95em;padding:7px 13px;background:linear-gradient(90deg,#DC143C,#FFD700);color:#fff;font-weight:bold;border-radius:10px;border:none;cursor:pointer;"><i class='fas fa-home'></i> الرئيسية</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(raceScreen);
      }
// زر إغلاق لوحة الشرف
function closeHonorBoard() {
  const raceScreen = document.getElementById('raceScreen');
  if(raceScreen) {
    raceScreen.querySelector('#raceHonorBoard').style.display = 'none';
    // يمكن إعادة السباق أو العودة للرئيسية من الأزرار
  }
}
      // إعداد مدخل عدد الأسئلة فقط
      const roundInputs = raceScreen.querySelector('#roundInputs');
      roundInputs.innerHTML = `<div style='margin-bottom:10px;'><label style='color:#FFD700;font-weight:700;'>عدد الأسئلة لكل طالب:</label> <input type='number' min='1' max='20' value='5' id='questionsPerStudent' style='width:60px;font-size:1.1em;border-radius:8px;border:1.5px solid #ffd700;padding:4px 8px;text-align:center;'></div><div style='color:#FFD700;font-size:1em;margin-bottom:8px;'>ملاحظة: هذا الرقم هو عدد الأسئلة التي سيُسألها كل طالب في السباق.</div>`;
      raceScreen.style.display = 'flex';
      raceScreen.querySelector('#raceSetup').style.display = 'block';
      raceScreen.querySelector('#raceArena').style.display = 'none';
      raceScreen.querySelector('#raceHonorBoard').style.display = 'none';
      raceScreen.querySelector('#startRealRaceBtn').onclick = function(){
        let questions = parseInt(document.getElementById('questionsPerStudent').value)||1;
        // عند بدء السباق، إظهار المضمار فقط مع زر "انطلاق"
        startRace(questions, true); // وضع خاص: لا تظهر نافذة السؤال بعد
        let raceArena = document.getElementById('raceArena');
        if(raceArena) {
          raceArena.style.display = 'flex';
          // إضافة زر انطلاق إذا لم يكن موجودًا
          if(!document.getElementById('startRoundBtn')) {
            let btn = document.createElement('button');
            btn.id = 'startRoundBtn';
            btn.textContent = 'انطلاق';
            btn.className = 'neural-button';
            btn.style = 'font-size:1.3em;padding:1.2em 2.8em;margin:22px auto 0 auto;display:block;background:linear-gradient(90deg,#FFD700,#00f5ff);color:#23243a;font-weight:bold;border-radius:16px;border:none;box-shadow:0 2px 16px #FFD70055;letter-spacing:0.04em;';
            btn.onclick = function() {
              btn.style.display = 'none';
              let raceQuestionBox = document.getElementById('raceQuestionBox');
              if(raceQuestionBox) {
                raceQuestionBox.style.display = 'block';
                raceQuestionBox.scrollIntoView({behavior:'smooth',block:'center'});
              }
              showNextQuestion();
            };
            raceArena.insertBefore(btn, raceArena.firstChild);
          } else {
            let btn = document.getElementById('startRoundBtn');
            btn.textContent = 'انطلاق';
            btn.style.display = 'block';
            btn.onclick = function() {
              btn.style.display = 'none';
              let raceQuestionBox = document.getElementById('raceQuestionBox');
              if(raceQuestionBox) {
                raceQuestionBox.style.display = 'block';
                raceQuestionBox.scrollIntoView({behavior:'smooth',block:'center'});
              }
              showNextQuestion();
            };
          }
          // إخفاء نافذة السؤال حتى الضغط
          let raceQuestionBox = document.getElementById('raceQuestionBox');
          if(raceQuestionBox) raceQuestionBox.style.display = 'none';
        }
      };
    }

    // منطق السباق والجولات
    let raceState = null;
    // عداد السؤال المتتالي
    let currentQuestionNumber = 0;
    function startRace(questionsPerStudent) {
      // تهيئة السباق لجولة واحدة
      let hideQuestionBox = false;
      if (typeof arguments[1] === 'boolean') hideQuestionBox = arguments[1];
      raceState = {
        students: selectedStudents.map(name=>({name,score:0,progress:0,answers:[]})),
        questionsPerStudent,
        finished: false
      };
      currentQuestionNumber = 0;
      // إظهار واجهة السباق
      const raceScreen = document.getElementById('raceScreen');
      raceScreen.querySelector('#raceSetup').style.display = 'none';
      raceScreen.querySelector('#raceArena').style.display = 'flex';
      raceScreen.querySelector('#raceArena').style.overflowY = 'auto';
      raceScreen.querySelector('#raceArena').style.maxHeight = '100vh';
      raceScreen.querySelector('#raceHonorBoard').style.display = 'none';
      setTimeout(function() {
        let raceQuestionBox = document.getElementById('raceQuestionBox');
        let raceArena = document.getElementById('raceArena');
        if(raceArena) {
          raceArena.style.display = 'flex';
          raceArena.style.overflowY = 'auto';
          raceArena.style.maxHeight = '100vh';
        }
        if(raceQuestionBox) {
          raceQuestionBox.style.display = hideQuestionBox ? 'none' : 'block';
          if (!hideQuestionBox) raceQuestionBox.scrollIntoView({behavior:'smooth',block:'center'});
        }
      }, 150);
      renderRaceTrack();
      if (!hideQuestionBox) showNextQuestion();
    }

    function renderRaceTrack() {
      const track = document.getElementById('raceTrack');
      const students = raceState.students;
      let maxScore = raceState.questionsPerStudent;
      // مضمار ماراثون رأسي احترافي وألوان متدرجة عصرية
      track.innerHTML = '';
  track.style.position = 'relative';
  track.style.height = '';
  track.style.background = 'linear-gradient(180deg,#181c2a 60%,#23243a 100%)';
  track.style.borderRadius = '32px';
  track.style.boxShadow = '0 6px 32px #00f5ff33, 0 2px 18px #ffd70033';
  track.style.display = 'flex';
  track.style.flexDirection = 'column';
  track.style.justifyContent = 'flex-start';
  track.style.alignItems = 'stretch';
  track.style.padding = '40px 0 40px 0';
  track.style.overflowX = 'auto';
  // رأس المضمار: اسم الطالب الأول (الاسم الكامل مع إبراز الاسم الأول)
  let startName = students[0]?.name || '';
  let firstName = startName.split(' ')[0] || startName;
  let restName = startName.slice(firstName.length).trim();
  let startDiv = document.createElement('div');
  startDiv.style = 'display:flex;align-items:center;gap:18px;margin-bottom:28px;justify-content:flex-start;padding-right:40px;';
  startDiv.innerHTML = `<span style="font-size:1.3em;font-weight:900;color:#00f5ff;text-shadow:0 0 18px #00f5ff99;letter-spacing:0.04em;">🏁 البداية</span><span style="font-size:1.3em;font-weight:900;"><span style='color:#FFD700;text-shadow:0 0 18px #FFD70099;'>${firstName}</span> <span style='color:#fffbe6;'>${restName}</span></span>`;
  track.appendChild(startDiv);
      // لكل طالب: مضمار وعداء متحرك
      students.forEach((student, idx) => {
        let percent = (student.score / maxScore);
        let runnerId = `runner-${idx}`;
        let lane = document.createElement('div');
        lane.style = 'position:relative;height:80px;margin-bottom:32px;display:flex;align-items:center;';
        // إبراز العداء الحالي
        let isCurrent = (typeof window.currentQuestionNumber === 'number' && raceState && idx === (window.currentQuestionNumber % students.length));
        let sFirst = student.name.split(' ')[0] || student.name;
        lane.innerHTML = `
          <div style="position:absolute;top:50%;left:0;transform:translateY(-50%);width:92%;height:20px;background:linear-gradient(90deg,#23243a 0%,#00f5ff 60%,#FFD700 100%);border-radius:14px;box-shadow:0 0 16px #00f5ff55,0 0 8px #ffd70055;"></div>
          <div id="${runnerId}" class="race-runner${isCurrent ? ' runner-current' : ''}" style="position:absolute;top:50%;left:0;transform:translateY(-50%);transition:left 0.8s cubic-bezier(0.68,-0.55,0.27,1.55);width:70px;height:70px;z-index:2;${isCurrent ? 'box-shadow:0 0 0 5px #FFD70099,0 0 24px #00f5ff;' : ''}">
            <div style="width:70px;height:70px;border-radius:50%;background:linear-gradient(135deg,#FFD700 60%,#00f5ff 100%);box-shadow:0 0 24px #FFD70099,0 0 24px #00f5ff99;display:flex;align-items:center;justify-content:center;font-size:2.3em;font-weight:900;color:#23243a;animation:runnerBounce 1.2s infinite alternate;filter:drop-shadow(0 0 12px #FFD70088);${isCurrent ? 'border:3px solid #FFD700;' : ''}">
              <span style='display:inline-block;transform:scaleX(-1);text-shadow:0 0 8px #00f5ff;'>🏃‍♂️</span>
            </div>
            <div style="position:absolute;top:74px;left:50%;transform:translateX(-50%);font-size:1.08em;font-weight:900;text-shadow:0 0 8px #23243a,#00f5ff99;letter-spacing:0.02em;">
              <span style='color:#FFD700;'>${sFirst}</span> <span style='color:#FFD700;font-size:1em;text-shadow:0 0 8px #FFD700;'>${student.score}/${maxScore}</span>
            </div>
          </div>
        `;
        // علم النهاية
        if(idx === students.length-1) {
          lane.innerHTML += `<div style="position:absolute;top:50%;right:0;transform:translateY(-50%);font-size:2.5em;filter:drop-shadow(0 0 12px #FFD70088);">🚩</div>`;
        }
        track.appendChild(lane);
        // بعد الإضافة، حرّك العداء حسب التقدم
        setTimeout(()=>{
          let runner = document.getElementById(runnerId);
          if(runner) {
            runner.style.left = `calc(${percent*88}% )`;
          }
        }, 50);
      });
      // أنيميشن العداء
      if(!document.getElementById('runnerBounceStyle')) {
        let style = document.createElement('style');
        style.id = 'runnerBounceStyle';
        style.innerHTML = `@keyframes runnerBounce {0%{transform:translateY(0);}100%{transform:translateY(-16px);}}`;
        document.head.appendChild(style);
      }
    }

    // منطق الدور المتتالي للأسئلة بين الطلاب
    function showNextQuestion() {
      const students = raceState.students;
      const questionsPerStudent = raceState.questionsPerStudent;
      // حساب إجمالي الأسئلة في الجولة
      const totalQuestions = students.length * questionsPerStudent;
      // أول مرة: تهيئة عداد السؤال
      if (typeof currentQuestionNumber !== 'number' || currentQuestionNumber < 0) currentQuestionNumber = 0;
      // إذا انتهت الجولة
      if (currentQuestionNumber >= totalQuestions) {
        finishRace();
        return;
      }
      // منطق متتالي: الطالب الأول ثم الثاني ... حتى انتهاء الجولات
      let studentIdx = currentQuestionNumber % students.length;
      let found = false;
      for (let i = 0; i < students.length; i++) {
        let idx = (currentQuestionNumber + i) % students.length;
        if (students[idx].answers.length < questionsPerStudent) {
          studentIdx = idx;
          found = true;
          break;
        }
      }
      if (!found) {
        finishRace();
        return;
      }
      // ضمان ظهور نافذة السؤال وأزرار التقييم
      setTimeout(function() {
        let raceQuestionBox = document.getElementById('raceQuestionBox');
        let raceArena = document.getElementById('raceArena');
        if(raceArena) {
          raceArena.style.display = 'flex';
          raceArena.style.overflowY = 'auto';
          raceArena.style.maxHeight = '100vh';
        }
        if(raceQuestionBox) {
          raceQuestionBox.style.display = 'block';
          raceQuestionBox.scrollIntoView({behavior:'smooth',block:'center'});
        }
      }, 80);
      // عرض اسم الطالب والسؤال
  // عرض الاسم الكامل في نافذة السؤال
  let sName = students[studentIdx].name;
  document.getElementById('raceCurrentStudent').innerHTML = `<span style='color:#FFD700;font-weight:900;font-size:1.1em;'>${sName}</span>`;
  // إعادة رسم المضمار لإبراز العداء الحالي
  renderRaceTrack();
      document.getElementById('raceQuestion').textContent = `اسأل سؤال (${students[studentIdx].answers.length+1} من ${questionsPerStudent})`;
      document.getElementById('raceProgressInfo').textContent = `عدد الأسئلة لكل طالب: ${questionsPerStudent}`;
      // رسالة تحفيزية عشوائية عند كل سؤال
      const motivs = [
        'ركز جيدًا وأجب بثقة!','أنت البطل القادم!','أظهر مهاراتك!','كلنا نشجعك!','حظًا موفقًا!','أنت قدها!','👏🔥','💡'
      ];
      if(window.notificationSystem) window.notificationSystem.show(motivs[Math.floor(Math.random()*motivs.length)],'#FFD700','🎤',1800,'motivate');
      // تفعيل أزرار التقييم
      document.getElementById('raceCorrectBtn').onclick = ()=>{
  students[studentIdx].score++;
  students[studentIdx].progress++;
  students[studentIdx].answers.push({correct:true});
  renderRaceTrack();
  // مؤثر احتفالي عند الإجابة الصحيحة
  setTimeout(()=>{ showConfetti(); }, 100);
  setTimeout(()=>{ window.notificationSystem && window.notificationSystem.show('إجابة رائعة!','lime','✅',1500,'correct'); }, 120);
  if(window.audioManager) setTimeout(()=>{ audioManager.playSound('correct'); }, 120);
  currentQuestionNumber++;
  setTimeout(()=>{ showNextQuestion(); }, 200);
      };
      document.getElementById('raceWrongBtn').onclick = ()=>{
  students[studentIdx].answers.push({correct:false});
  renderRaceTrack();
  setTimeout(()=>{ window.notificationSystem && window.notificationSystem.show('حاول مرة أخرى!','#DC143C','❌',1200,'wrong'); }, 80);
  if(window.audioManager) setTimeout(()=>{ audioManager.playSound('wrong'); }, 100);
  currentQuestionNumber++;
  setTimeout(()=>{ showNextQuestion(); }, 200);
      };
    }

    function finishRace() {
      raceState.finished = true;
      // إظهار لوحة الشرف والإحصائيات
      const raceScreen = document.getElementById('raceScreen');
      raceScreen.querySelector('#raceArena').style.display = 'none';
      raceScreen.querySelector('#raceHonorBoard').style.display = 'flex';
      // ضمان ظهور أزرار لوحة الشرف
      const honorActions = raceScreen.querySelector('#raceHonorBoard .neural-button')?.parentElement;
      if(honorActions) honorActions.style.display = 'flex';
      // مؤثر احتفالي وصوتي عند نهاية السباق
      showConfetti();
      if(window.audioManager) { audioManager.playSound('finish'); setTimeout(()=>audioManager.playSound('cheer'), 800); }
      window.notificationSystem && window.notificationSystem.show('انتهى السباق! تهانينا للجميع!','gold','🏆',3500,'finish');
      // ترتيب الطلاب حسب النقاط
      let sorted = [...raceState.students].sort((a,b)=>b.score-a.score);
      let statsHtml = '<div style="margin-bottom:18px;font-size:1.2em;color:#23243a;font-weight:700;">ترتيب المتسابقين:</div>';
      sorted.forEach((s,idx)=>{
        statsHtml += `<div style='background:linear-gradient(90deg,#ffd700,#fffbe6);margin:8px 0;padding:12px 18px;border-radius:16px;font-size:1.2em;font-weight:900;color:#DC143C;box-shadow:0 2px 12px #ffd70033;'>${idx+1}. ${s.name} <span style='color:#11998e;font-size:1em;'>(${s.score} نقطة)</span></div>`;
      });
      // إحصائيات إضافية
      statsHtml += `<div style='margin-top:18px;font-size:1.1em;color:#23243a;'>عدد الأسئلة لكل طالب: ${raceState.questionsPerStudent}</div>`;
      statsHtml += `<div style='font-size:1.1em;color:#23243a;'>إجمالي الأسئلة: ${raceState.questionsPerStudent * raceState.students.length}</div>`;
      raceScreen.querySelector('#raceStats').innerHTML = statsHtml;
    // ====== مؤثر احتفالي (كونفيتي) ====== //
    function showConfetti() {
      for(let i=0;i<22;i++) {
        setTimeout(()=>{
          const c = document.createElement('div');
          c.textContent = ['🎉','✨','🌟','💫','🎊','🥇','🥳'][Math.floor(Math.random()*7)];
          c.style.position = 'fixed';
          c.style.fontSize = (Math.random()*1.2+1.2)+'em';
          c.style.pointerEvents = 'none';
          c.style.zIndex = '20001';
          c.style.left = (window.innerWidth*Math.random()*0.9+window.innerWidth*0.05)+'px';
          c.style.top = (window.innerHeight*Math.random()*0.5)+'px';
          c.style.opacity = 1;
          document.body.appendChild(c);
          c.animate([
            { transform: 'translateY(0) scale(1)', opacity: 1 },
            { transform: `translateY(${Math.random()*180+120}px) scale(0.7)`, opacity: 0.2 }
          ], { duration: 1800+Math.random()*800, easing: 'ease-out' }).onfinish = ()=>c.remove();
        }, i*60);
      }
    }
    }

    // تحميل الطلاب تلقائيًا عند الفتح
    loadStudentsData();
  </script>
</body>
</html>
